<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WP Planner 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* 1. ÿ™ÿπÿ±ŸäŸÅ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ¥ÿßŸÖŸÑÿ© ŸÑŸÑŸÖŸàÿØŸäŸÜ */
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f8fafc;
            --input-bg: #0f172a;
            --tab-inactive: #334155;
            --tab-text: #94a3b8;
            --border-color: #334155;
            --header-bg: #1e293b;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --primary-teal: #2dd4bf;
        }

        [data-theme="light"] {
            --bg-dark: #f1f5f9;
            --card-bg: #ffffff;
            --text-color: #0f172a;
            --input-bg: #f8fafc;
            --tab-inactive: #e2e8f0;
            --tab-text: #475569;
            --border-color: #cbd5e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .main-content {
            margin-top: 80px;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header h1 {
            color: var(--primary-teal);
            margin-bottom: 15px;
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
        }

        .progress-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .progress-bar-container {
            background: #334155;
            height: 12px;
            border-radius: 10px;
            width: 50%;
            margin: 15px auto;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary-teal), #0d9488);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(45, 212, 191, 0.5);
        }

        .add-task-area {
            margin-bottom: 30px;
            text-align: center;
        }

        .input-group {
            display: inline-flex;
            gap: 12px;
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
            justify-content: center;
        }

        input,
        select,
        textarea {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 14px;
            border-radius: 8px;
            outline: none;
            transition: 0.3s;
            font-family: inherit;
            font-size: 0.95rem;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-teal);
            box-shadow: 0 0 8px rgba(45, 212, 191, 0.2);
        }

        #task-input {
            min-width: 250px;
            flex: 1;
        }

        .add-btn {
            background: var(--primary-teal);
            color: var(--bg-dark);
            cursor: pointer;
            border: none;
            font-weight: bold;
            padding: 10px 25px;
            border-radius: 8px;
            transition: 0.3s;
            font-size: 1rem;
        }

        .add-btn:hover {
            background: #0d9488;
            box-shadow: 0 0 15px rgba(13, 148, 136, 0.3);
        }

        .main-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }




        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-btn {
            background: var(--tab-inactive);
            color: var(--tab-text);
            border: none;
            padding: 8px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .nav-btn:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .nav-btn.active {
            background: var(--primary-teal);
            color: var(--bg-dark);
            font-weight: bold;
        }

        .notes-word,
        .bucket-btn {
            background: none;
            border: 1px solid var(--primary-teal);
            color: var(--primary-teal);
            padding: 8px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s ease;
        }

        .notes-word:hover,
        .bucket-btn:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .app-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-name {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary-teal);
            letter-spacing: 0.5px;
        }

        .theme-icon-container {
            font-size: 1.4rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: 0.3s;
            background: var(--tab-inactive);
            color: var(--text-color);
        }

        .theme-icon-container:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .logout-link {
            background: none;
            border: 1px solid #ff7675;
            color: #ff7675;
            width: 38px;
            height: 38px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
            font-size: 1.1rem;
        }

        .logout-link:hover {
            background: #ff7675;
            color: white;
        }

        .pomodoro-container {
            display: flex;
            align-items: center;
            background: var(--input-bg);
            padding: 5px 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            gap: 10px;
        }

        .timer-display {
            font-family: 'monospace';
            font-weight: bold;
            color: var(--primary-teal);
            font-size: 1.1rem;
            min-width: 55px;
        }

        #timer-btn {
            background: var(--primary-teal);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: 0.3s;
        }

        #timer-btn:hover {
            background: #0d9488;
            transform: scale(1.1);
        }

        .timer-running {
            box-shadow: 0 0 10px rgba(45, 212, 191, 0.5);
            border-color: var(--primary-teal);
        }

        .sub-nav {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .sub-tab {
            background: var(--tab-inactive);
            color: var(--tab-text);
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .sub-tab:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .sub-tab.active {
            background: var(--primary-teal);
            color: var(--bg-dark);
            box-shadow: 0 0 15px rgba(45, 212, 191, 0.4);
            font-weight: 600;
        }

        .columns-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            animation: fadeInUp 0.4s ease;
        }

        .column {
            background: var(--card-bg);
            min-height: 400px;
            border-radius: 20px;
            padding: 20px;
            border-top: 5px solid transparent;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .todo-col {
            border-color: var(--accent-red);
        }

        .doing-col {
            border-color: var(--accent-yellow);
        }

        .done-col {
            border-color: var(--accent-green);
        }

        .col-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .col-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--text-color);
            font-weight: 600;
        }

        .count {
            background: var(--tab-inactive);
            color: var(--text-color);
            padding: 4px 14px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
            min-height: 100px;
            transition: background 0.2s;
            border-radius: 10px;
        }

        .task-list.drag-over,
        .column.drag-over {
            background: rgba(45, 212, 191, 0.08);
        }

        .task-item {
            background: var(--input-bg);
            color: var(--text-color);
            margin-bottom: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
            animation: fadeIn 0.3s ease;
            cursor: grab;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            border-color: var(--primary-teal);
            box-shadow: 0 4px 12px rgba(45, 212, 191, 0.1);
        }

        .task-item.dragging {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--primary-teal);
            transform: scale(0.95);
        }

        .task-item:active {
            cursor: grabbing;
        }

        .importance-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
        }

        .dot-urgent {
            background: var(--accent-red);
        }

        .dot-medium {
            background: var(--accent-yellow);
        }

        .dot-normal {
            background: var(--accent-green);
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -350px;
            width: 320px;
            height: 100%;
            background: var(--card-bg);
            z-index: 2000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.4);
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-header {
            background-color: var(--primary-teal);
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--bg-dark);
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--bg-dark);
            font-size: 1.8rem;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: 0.3s;
        }

        .close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .note-inputs {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .note-inputs input,
        .note-inputs textarea {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 12px;
            border-radius: 8px;
            font-family: inherit;
            outline: none;
            font-size: 0.95rem;
            transition: 0.3s;
        }

        .note-inputs input:focus,
        .note-inputs textarea:focus {
            border-color: var(--primary-teal);
            box-shadow: 0 0 8px rgba(45, 212, 191, 0.2);
        }

        .note-inputs textarea {
            height: 120px;
            resize: none;
        }

        .add-note-btn {
            background-color: var(--primary-teal);
            color: var(--bg-dark);
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.3s;
        }

        .add-note-btn:hover {
            background-color: #0d9488;
        }

        .notes-display-area {
            padding: 0 20px 20px 20px;
            overflow-y: auto;
            flex: 1;
        }

        .note-card {
            background: var(--input-bg);
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 10px;
            border-right: 4px solid var(--primary-teal);
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-card:hover {
            background: var(--tab-inactive);
            transform: translateX(-5px);
        }

        .note-card h4 {
            margin: 0;
            color: var(--text-color);
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-body textarea {
            height: 200px;
            resize: none;
        }

        .save-edit-btn {
            background-color: var(--primary-teal);
            color: var(--bg-dark);
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .save-edit-btn:hover {
            background-color: #0d9488;
        }

        /* ============= Bucket Styles ============= */
        .bucket-page {
            display: none;
            padding-top: 80px;
            animation: fadeInUp 0.4s ease;
        }

        .bucket-page.active {
            display: block;
        }

        .bucket-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .bucket-header h1 {
            color: var(--primary-teal);
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .bucket-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .upload-btn {
            background: var(--primary-teal);
            color: var(--bg-dark);
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-btn:hover {
            background: #0d9488;
            transform: translateY(-2px);
        }

        #bucket-search {
            min-width: 300px;
            padding: 12px 20px;
            border-radius: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .bucket-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 20px;
        }

        .bucket-item {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: 0.3s;
            animation: fadeIn 0.3s ease;
        }

        .bucket-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(45, 212, 191, 0.2);
            border-color: var(--primary-teal);
        }

        .bucket-preview {
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--input-bg);
            overflow: hidden;
            position: relative;
        }

        .bucket-preview img,
        .bucket-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .bucket-preview .file-icon {
            font-size: 4rem;
            color: var(--primary-teal);
        }

        .bucket-info {
            padding: 15px;
        }

        .bucket-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-teal);
            font-size: 1.1rem;
        }

        .bucket-filename {
            font-size: 0.85rem;
            margin-bottom: 8px;
            color: var(--tab-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bucket-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--tab-text);
            margin-bottom: 12px;
        }

        .bucket-actions {
            display: flex;
            gap: 10px;
        }

        .bucket-action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            font-size: 0.9rem;
        }

        .view-btn {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .view-btn:hover {
            background: #0d9488;
        }

        .delete-btn {
            background: var(--accent-red);
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .edit-btn {
            background: var(--accent-yellow);
            color: var(--bg-dark);
        }

        .edit-btn:hover {
            background: #d97706;
        }

        .empty-bucket {
            text-align: center;
            padding: 60px 20px;
            color: var(--tab-text);
        }

        .empty-bucket i {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-bucket p {
            font-size: 1.2rem;
        }

        /* Modal ŸÑŸÑÿπÿ±ÿ∂ */
        .view-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }

        .view-modal.active {
            display: flex;
        }

        .view-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .view-modal-content img,
        .view-modal-content video {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 10px;
        }

        .close-view-modal {
            position: absolute;
            top: -40px;
            right: 0;
            background: var(--accent-red);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        .close-view-modal:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .upload-progress {
            margin-top: 15px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .progress-item {
            margin-bottom: 10px;
            padding: 10px;
            background: var(--input-bg);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .progress-item.success {
            border-right: 3px solid var(--accent-green);
        }

        .progress-item.error {
            border-right: 3px solid var(--accent-red);
        }

        .progress-bar-upload {
            width: 100%;
            height: 8px;
            background: var(--tab-inactive);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary-teal);
            width: 0%;
            transition: width 0.3s;
        }

        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .welcome-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .welcome-content {
            text-align: center;
            animation: welcomeSlide 0.8s ease-out;
        }

        .welcome-content h2 {
            font-size: 3rem;
            color: var(--primary-teal);
            margin-bottom: 20px;
            font-weight: 800;
        }

        .welcome-content .user-name {
            font-size: 2.5rem;
            color: var(--text-color);
            font-weight: 600;
            margin-bottom: 40px;
        }

        .welcome-content p {
            font-size: 1.2rem;
            color: var(--tab-text);
            margin-bottom: 30px;
        }

        .start-btn {
            background: var(--primary-teal);
            color: var(--bg-dark);
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(45, 212, 191, 0.3);
        }

        .start-btn:hover {
            background: #0d9488;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(45, 212, 191, 0.5);
        }

        @keyframes welcomeSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-box {
            background: var(--card-bg);
            padding: 45px 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.5);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .auth-box h2 {
            color: var(--primary-teal);
            margin-bottom: 30px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .auth-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .auth-box input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
        }

        .auth-box input:focus {
            border-color: var(--primary-teal);
            box-shadow: 0 0 12px rgba(45, 212, 191, 0.2);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: var(--primary-teal);
            color: var(--bg-dark);
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .auth-btn:hover {
            background: #0d9488;
            transform: translateY(-2px);
        }

        .auth-box p {
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--tab-text);
        }

        .auth-box a {
            color: var(--primary-teal);
            text-decoration: none;
            font-weight: bold;
            transition: 0.3s;
        }

        .auth-box a:hover {
            text-decoration: underline;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============= Burger Menu Drawer (Always Visible) ============= */
        .burger-menu {
            display: flex;
            background: var(--tab-inactive);
            color: var(--text-color);
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.3rem;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .burger-menu:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
            transform: scale(1.05);
        }

        .burger-menu i {
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .burger-menu.active i {
            transform: rotate(180deg);
        }

        /* The nav-right is now a fixed right-side drawer */
        .nav-right {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: var(--card-bg);
            flex-direction: column;
            padding: 0;
            gap: 0;
            box-shadow: -8px 0 30px rgba(0, 0, 0, 0.4);
            border-left: 1px solid var(--border-color);
            z-index: 1500;
            display: flex;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-right.active {
            transform: translateX(0);
        }

        /* Drawer Header */
        .drawer-header {
            background: linear-gradient(135deg, var(--primary-teal), #0d9488);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .drawer-header h3 {
            color: var(--bg-dark);
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
        }

        .drawer-close-btn {
            background: rgba(0, 0, 0, 0.15);
            border: none;
            color: var(--bg-dark);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        .drawer-close-btn:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Drawer Nav Items */
        .drawer-nav-items {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .drawer-nav-items .nav-btn,
        .drawer-nav-items .notes-word,
        .drawer-nav-items .bucket-btn,
        .drawer-nav-items .settings-btn,
        .drawer-nav-items .ramadan-btn {
            width: 100%;
            text-align: right;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ramadan-btn {
            background: linear-gradient(135deg, #1a3a2a, #0d4a2a);
            border: 1px solid #2d7a4a;
            color: #4ade80;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        .ramadan-btn:hover {
            background: linear-gradient(135deg, #2d7a4a, #1a5c35);
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.3);
            transform: translateX(-3px);
        }

        /* Drawer Pomodoro */
        .drawer-pomodoro {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .drawer-pomodoro .pomodoro-container {
            width: 100%;
            justify-content: center;
        }

        /* Overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1400;
            display: none;
            backdrop-filter: blur(2px);
            transition: opacity 0.35s ease;
            opacity: 0;
        }

        .menu-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-nav {
                padding: 10px 15px;
            }

            .input-group {
                flex-direction: column;
            }

            .columns-container {
                grid-template-columns: 1fr;
            }

            .bucket-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============= Settings Modal Styles ============= */
        .settings-btn {
            background: var(--tab-inactive);
            color: var(--text-color);
            border: 1px solid var(--primary-teal);
            padding: 8px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-btn:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            backdrop-filter: blur(5px);
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 600px;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .settings-header h2 {
            color: var(--primary-teal);
            margin: 0;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: 0.3s;
        }

        .settings-close:hover {
            background: var(--accent-red);
            color: white;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            color: var(--text-color);
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--input-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .color-picker-group label {
            flex: 1;
            color: var(--text-color);
            font-weight: 500;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker-wrapper input[type="color"] {
            width: 60px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        .color-picker-wrapper input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker-wrapper input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .color-value {
            font-family: monospace;
            color: var(--tab-text);
            font-size: 0.9rem;
            min-width: 80px;
        }

        .bg-image-section {
            padding: 20px;
            background: var(--input-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .bg-image-upload {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: var(--card-bg);
        }

        .upload-area:hover {
            border-color: var(--primary-teal);
            background: var(--input-bg);
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--primary-teal);
            margin-bottom: 10px;
        }

        .upload-area p {
            color: var(--tab-text);
            margin: 5px 0;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .bg-preview {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px solid var(--border-color);
            display: none;
            position: relative;
        }

        .bg-preview.active {
            display: block;
        }

        .remove-bg-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-red);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        .remove-bg-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .settings-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .settings-save-btn,
        .settings-reset-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .settings-save-btn {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .settings-save-btn:hover {
            background: #0d9488;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(45, 212, 191, 0.3);
        }

        .settings-reset-btn {
            background: var(--tab-inactive);
            color: var(--text-color);
        }

        .settings-reset-btn:hover {
            background: var(--accent-red);
            color: white;
        }

        .preview-note {
            background: var(--input-bg);
            padding: 12px;
            border-radius: 8px;
            border-right: 3px solid var(--primary-teal);
            margin-top: 15px;
        }

        .preview-note p {
            margin: 0;
            color: var(--tab-text);
            font-size: 0.9rem;
        }

        /* ÿ™ÿÆÿµŸäÿµ ÿßŸÑÿÆŸÑŸÅŸäÿ© */
        body.custom-bg {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        body.custom-bg::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
        }

        @media (max-width: 768px) {
            .settings-content {
                width: 95%;
                padding: 20px;
            }

            .color-picker-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .settings-actions {
                flex-direction: column;
            }
        }

        /* ============= Ramadan Section Styles ============= */
        .ramadan-page {
            display: none;
            padding-top: 90px;
            animation: fadeInUp 0.4s ease;
        }

        .ramadan-page.active {
            display: block;
        }

        .ramadan-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, #0a2a1a 0%, #0d3d22 50%, #0a2a1a 100%);
            border-radius: 20px;
            border: 1px solid #2d7a4a;
            position: relative;
            overflow: hidden;
        }

        .ramadan-header::before {
            content: 'üåô';
            position: absolute;
            font-size: 8rem;
            opacity: 0.07;
            top: -10px;
            left: 20px;
        }

        .ramadan-header h1 {
            color: #4ade80;
            font-size: 2.2rem;
            margin-bottom: 8px;
        }

        .ramadan-header p {
            color: #86efac;
            font-size: 1rem;
        }

        .ramadan-tabs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .ramadan-tab {
            background: var(--tab-inactive);
            color: var(--tab-text);
            border: none;
            padding: 10px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: 0.3s;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .ramadan-tab:hover {
            background: #2d7a4a;
            color: #4ade80;
        }

        .ramadan-tab.active {
            background: linear-gradient(135deg, #2d7a4a, #1a5c35);
            color: #4ade80;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.3);
        }

        .ramadan-section {
            display: none;
            animation: fadeInUp 0.3s ease;
        }

        .ramadan-section.active {
            display: block;
        }

        /* Prayers Section */
        .prayers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            max-width: 900px;
            margin: 0 auto;
        }

        .prayer-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .prayer-card:hover {
            border-color: #4ade80;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(74, 222, 128, 0.15);
        }

        .prayer-card.done {
            background: linear-gradient(135deg, #0d3d22, #1a5c35);
            border-color: #4ade80;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
        }

        .prayer-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .prayer-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .prayer-check {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            font-size: 1rem;
        }

        .prayer-card.done .prayer-check {
            background: #4ade80;
            border-color: #4ade80;
            color: #0a2a1a;
        }

        /* Khatma Section */
        .khatma-progress-bar-wrap {
            background: var(--tab-inactive);
            height: 14px;
            border-radius: 10px;
            margin: 0 auto 25px;
            max-width: 600px;
            overflow: hidden;
        }

        .khatma-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.4);
        }

        .khatma-percent {
            text-align: center;
            color: #4ade80;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .juz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            max-width: 900px;
            margin: 0 auto 25px;
        }

        .juz-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            user-select: none;
        }

        .juz-item:hover {
            border-color: #4ade80;
            transform: scale(1.05);
        }

        .juz-item.done {
            background: linear-gradient(135deg, #0d3d22, #1a5c35);
            border-color: #4ade80;
            color: #4ade80;
        }

        .juz-item .juz-num {
            font-size: 0.75rem;
            color: var(--tab-text);
            display: block;
            margin-bottom: 3px;
        }

        .juz-item .juz-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .juz-item.done .juz-num,
        .juz-item.done .juz-label {
            color: #4ade80;
        }

        .finish-khatma-btn {
            display: block;
            margin: 0 auto;
            background: linear-gradient(135deg, #2d7a4a, #1a5c35);
            color: #4ade80;
            border: 1px solid #4ade80;
            padding: 14px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .finish-khatma-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .finish-khatma-btn:not(:disabled):hover {
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.4);
            transform: translateY(-2px);
        }

        /* Taraweeh Section */
        .taraweeh-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            max-width: 900px;
            margin: 0 auto;
        }

        .taraweeh-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            user-select: none;
        }

        .taraweeh-item:hover {
            border-color: #4ade80;
            transform: scale(1.05);
        }

        .taraweeh-item.done {
            background: linear-gradient(135deg, #0d3d22, #1a5c35);
            border-color: #4ade80;
        }

        .taraweeh-item .day-num {
            font-size: 0.75rem;
            color: var(--tab-text);
            display: block;
            margin-bottom: 3px;
        }

        .taraweeh-item .day-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .taraweeh-item.done .day-num,
        .taraweeh-item.done .day-label {
            color: #4ade80;
        }

        .taraweeh-complete-msg {
            text-align: center;
            padding: 20px;
            color: #4ade80;
            font-size: 1.2rem;
            font-weight: 700;
            display: none;
        }

        .ramadan-card-wrap {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--border-color);
            max-width: 960px;
            margin: 0 auto;
        }
    </style>
</head>

<body>

    <!-- Modal ŸÑŸÑÿ•ÿπÿØÿßÿØÿßÿ™ -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-content" onclick="event.stopPropagation()">
            <div class="settings-header">
                <h2><i class="fa-solid fa-palette"></i> ÿ™ÿÆÿµŸäÿµ ÿßŸÑŸÖÿ∏Ÿáÿ±</h2>
                <button class="settings-close" onclick="closeSettingsModal()">√ó</button>
            </div>

            <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ£ŸÑŸàÿßŸÜ -->
            <div class="settings-section">
                <h3><i class="fa-solid fa-droplet"></i> ÿßŸÑÿ£ŸÑŸàÿßŸÜ</h3>

                <div class="color-picker-group">
                    <label>ŸÑŸàŸÜ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÜŸÇŸÑ</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="navbar-color-picker" value="#1e293b">
                        <span class="color-value" id="navbar-color-value">#1e293b</span>
                    </div>
                </div>

                <div class="color-picker-group">
                    <label>ŸÑŸàŸÜ ÿßŸÑÿÆŸÑŸÅŸäÿ©</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="bg-color-picker" value="#0f172a">
                        <span class="color-value" id="bg-color-value">#0f172a</span>
                    </div>
                </div>
            </div>

            <!-- ŸÇÿ≥ŸÖ ÿµŸàÿ±ÿ©/ŸÅŸäÿØŸäŸà ÿßŸÑÿÆŸÑŸÅŸäÿ© -->
            <div class="settings-section">
                <h3><i class="fa-solid fa-image"></i> ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</h3>

                <div class="bg-image-section">
                    <div class="bg-image-upload">
                        <div class="upload-area" onclick="document.getElementById('bg-image-input').click()">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <p><strong>ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿ£Ÿà ŸÅŸäÿØŸäŸà</strong></p>
                            <p style="font-size: 0.85rem;">JPG, PNG, GIF, MP4, WEBM (ÿ≠ÿ™Ÿâ 10MB)</p>
                            <input type="file" id="bg-image-input" accept="image/*,video/mp4,video/webm,video/ogg">
                        </div>

                        <div id="bg-preview" class="bg-preview">
                            <button class="remove-bg-btn" onclick="removeBackgroundImage(event)">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>

                    <div class="preview-note">
                        <p><i class="fa-solid fa-info-circle"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿ≥ÿ™ÿ∏Ÿáÿ± ÿÆŸÑŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ±</p>
                    </div>
                </div>
            </div>

            <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ -->
            <div class="settings-actions">
                <button class="settings-save-btn" onclick="saveUserPreferences()">
                    <i class="fa-solid fa-check"></i>
                    ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
                </button>
                <button class="settings-reset-btn" onclick="resetToDefaults()">
                    <i class="fa-solid fa-rotate-left"></i>
                    ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ
                </button>
            </div>
        </div>
    </div>

    <!-- Modal ŸÑŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ -->
    <div id="note-modal" class="modal-overlay" onclick="closeNoteModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3 style="color: var(--primary-teal)">ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©</h3>
                <button onclick="closeNoteModal()"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-note-id">
                <input type="text" id="edit-note-title" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ">
                <textarea id="edit-note-body" placeholder="ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ..."></textarea>
                <button class="save-edit-btn" onclick="saveNoteEdit()">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™</button>
            </div>
        </div>
    </div>

    <!-- Modal ŸÑŸÑÿπÿ±ÿ∂ -->
    <div id="view-modal" class="view-modal">
        <div class="view-modal-content">
            <button class="close-view-modal" onclick="closeViewModal()">&times;</button>
            <div id="view-content"></div>
        </div>
    </div>

    <!-- Modal ŸÑÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ -->
    <div id="upload-modal" class="modal-overlay" onclick="closeUploadModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3 style="color: var(--primary-teal)">ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ</h3>
                <button onclick="closeUploadModal()"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="upload-file-title" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ (ŸÑŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑÿπÿ±ÿ∂)">
                <input type="file" id="upload-file-input" accept="*/*"
                    style="padding: 12px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color);">
                <button class="save-edit-btn" onclick="confirmUpload()">ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ</button>
                <div id="upload-progress" class="upload-progress" style="display: none;">
                    <div class="progress-item">
                        <span id="upload-progress-text">ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ...</span>
                        <div class="progress-bar-upload">
                            <div id="progress-bar-fill" class="progress-bar-fill"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ -->
    <div id="edit-file-modal" class="modal-overlay" onclick="closeEditFileModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3 style="color: var(--primary-teal)">ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ</h3>
                <button onclick="closeEditFileModal()"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-file-id">
                <input type="text" id="edit-file-title" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ">
                <button class="save-edit-btn" onclick="saveFileEdit()">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™</button>
            </div>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
    <div id="auth-container" class="auth-overlay">
        <div class="auth-box" id="login-box">
            <h2>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h2>
            <div class="auth-inputs">
                <input type="text" id="login-identifier" placeholder="ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ£Ÿà ÿßŸÑÿßÿ≥ŸÖ">
                <input type="password" id="login-password" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
            </div>
            <button onclick="login()" class="auth-btn">ÿØÿÆŸàŸÑ</button>
            <p>ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ®ÿü <a href="javascript:void(0);" onclick="showSignup()">ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ</a></p>
        </div>

        <div class="auth-box" id="signup-box" style="display: none;">
            <h2>ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®</h2>
            <div class="auth-inputs">
                <input type="text" id="signup-name" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ">
                <input type="email" id="signup-email" placeholder="ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä">
                <input type="password" id="signup-password" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                <input type="password" id="signup-confirm" placeholder="ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
            </div>
            <button onclick="signup()" class="auth-btn">ÿ™ÿ≥ÿ¨ŸäŸÑ</button>
            <p>ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ® ÿ®ÿßŸÑŸÅÿπŸÑÿü <a href="javascript:void(0);" onclick="showLogin()">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</a></p>
        </div>
    </div>

    <div id="app-wrapper" style="display: none;">

        <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ® -->
        <div id="welcome-screen" class="welcome-screen" style="display: none;">
            <div class="welcome-content">
                <h2>ŸÖÿ±ÿ≠ÿ®ÿßŸã</h2>
                <div class="user-name" id="welcome-user-name"></div>
                <p>ÿßÿ≥ÿ™ÿπÿØ ŸÑÿ™ÿ≠ŸÇŸäŸÇ ÿ£ŸáÿØÿßŸÅŸÉ Ÿàÿ•ŸÜÿ¨ÿßÿ≤ ŸÖŸáÿßŸÖŸÉ! üöÄ</p>
                <button class="start-btn" onclick="closeWelcomeScreen()">ÿßÿ®ÿØÿ£ ÿßŸÑÿ¢ŸÜ</button>
            </div>
        </div>

        <!-- Overlay for burger menu -->
        <div id="menu-overlay" class="menu-overlay" onclick="closeMobileMenu()"></div>

        <!-- Drawer (slides from right) ‚Äî outside nav so it's truly fixed -->
        <div class="nav-right" id="mobile-nav">
            <!-- Drawer Header -->
            <div class="drawer-header">
                <h3>üìã ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</h3>
                <button class="drawer-close-btn" onclick="closeMobileMenu()">‚úï</button>
            </div>

            <!-- Drawer Nav Items -->
            <div class="drawer-nav-items">
                <button class="nav-btn" onclick="switchView('week'); closeMobileMenu()">
                    <i class="fa-solid fa-calendar-week"></i> ÿßŸÑÿ£ÿ≥ÿßÿ®Ÿäÿπ
                </button>
                <button class="nav-btn" onclick="switchView('month'); closeMobileMenu()">
                    <i class="fa-solid fa-calendar"></i> ÿßŸÑÿ¥ŸáŸàÿ±
                </button>
                <button class="nav-btn" onclick="switchView('year'); closeMobileMenu()">
                    <i class="fa-solid fa-calendar-days"></i> ÿßŸÑÿ≥ŸÜÿ©
                </button>
                <button class="notes-word" onclick="toggleNotes(); closeMobileMenu()">
                    <i class="fa-solid fa-note-sticky"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
                </button>
                <button class="bucket-btn" onclick="showBucketPage(); closeMobileMenu()">
                    <i class="fa-solid fa-folder"></i> Bucket
                </button>
                <button class="settings-btn" onclick="openSettingsModal(); closeMobileMenu()">
                    <i class="fa-solid fa-palette"></i> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                </button>
                <button class="ramadan-btn" onclick="showRamadanPage(); closeMobileMenu()">
                    üåô ÿ±ŸÖÿ∂ÿßŸÜ
                </button>
            </div>

            <!-- Pomodoro at bottom of drawer -->
            <div class="drawer-pomodoro">
                <div class="pomodoro-container" id="pomodoro">
                    <div class="timer-display">
                        <span id="timer-minutes">25</span>:<span id="timer-seconds">00</span>
                    </div>
                    <button onclick="toggleTimer()" id="timer-btn" title="ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤">
                        <i class="fa-solid fa-play"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÜŸÇŸÑ -->
        <nav class="main-nav" id="navbar">
            <button class="burger-menu" id="burger-btn" onclick="toggleMobileMenu()">
                <i class="fa-solid fa-bars"></i>
            </button>

            <div class="nav-left">
                <div class="app-brand">
                    <span class="app-name">WP 2026</span>
                    <div id="theme-icon-btn" class="theme-icon-container" onclick="toggleTheme()">
                        <i id="theme-icon" class="fa-solid fa-moon"></i>
                    </div>
                </div>
                <button onclick="logout()" class="logout-link" title="ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </nav>

        <!-- Sidebar ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ -->
        <div id="notes-sidebar" class="sidebar">
            <div class="sidebar-header">
                <button class="close-btn" onclick="toggleNotes()">√ó</button>
                <h3>ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ©</h3>
            </div>

            <div class="note-inputs">
                <input type="text" id="note-title" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©">
                <textarea id="note-body" placeholder="ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ..."></textarea>
                <button class="add-note-btn" onclick="addNote()">ÿ•ÿ∂ÿßŸÅÿ©</button>
            </div>

            <hr style="border: 0.5px solid var(--border-color); margin: 10px 20px;">

            <div style="padding: 0 20px;">
                <input type="text" id="search-notes" placeholder="ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿπŸÜÿßŸàŸäŸÜ..." oninput="filterNotes()"
                    style="width: 100%; padding: 8px; border-radius: 5px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color);">
            </div>

            <div id="notes-list" class="notes-display-area"></div>
        </div>

        <!-- ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© -->
        <div id="tasks-page" class="container main-content">
            <header>
                <h1 id="view-title">ÿßŸÑÿ£ŸáÿØÿßŸÅ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</h1>
                <div class="progress-section" id="progress-area">
                    <div class="progress-bar-container">
                        <div id="main-progress" class="progress-bar"></div>
                    </div>
                    <p id="progress-percent-text">ÿ™ŸÖ ÿ•ŸÜÿ¨ÿßÿ≤ 0%</p>
                </div>
            </header>

            <section class="add-task-area">
                <div class="input-group">
                    <input type="text" id="task-input" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑŸÖŸáŸÖÿ© ŸáŸÜÿß...">
                    <select id="task-importance">
                        <option value="urgent">ÿπÿßÿ¨ŸÑÿ© (ÿ£ÿ≠ŸÖÿ±)</option>
                        <option value="medium">ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© (ÿ£ÿµŸÅÿ±)</option>
                        <option value="normal">ÿπÿßÿØŸäÿ© (ÿ£ÿÆÿ∂ÿ±)</option>
                    </select>
                    <select id="task-recursion">
                        <option value="none">ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©</option>
                        <option value="daily">ŸäŸàŸÖŸäÿßŸã</option>
                        <option value="weekly">ÿ£ÿ≥ÿ®ŸàÿπŸäÿßŸã</option>
                    </select>
                    <button onclick="addNewTask()" class="add-btn">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </section>

            <nav class="sub-nav" id="sub-nav"></nav>

            <main class="columns-container">
                <div id="col-todo" class="column todo-col" ondrop="drop(event)" ondragover="allowDrop(event)"
                    ondragleave="dragLeave(event)">
                    <div class="col-header">
                        <h3>ŸÑŸÑŸÇŸäÿßŸÖ üî¥</h3><span class="count" id="count-todo">0</span>
                    </div>
                    <ul id="list-todo" class="task-list" ondrop="drop(event)" ondragover="allowDrop(event)"
                        ondragleave="dragLeave(event)"></ul>
                </div>
                <div id="col-doing" class="column doing-col" ondrop="drop(event)" ondragover="allowDrop(event)"
                    ondragleave="dragLeave(event)">
                    <div class="col-header">
                        <h3>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿπŸÖŸÑ üöß</h3><span class="count" id="count-doing">0</span>
                    </div>
                    <ul id="list-doing" class="task-list" ondrop="drop(event)" ondragover="allowDrop(event)"
                        ondragleave="dragLeave(event)"></ul>
                </div>
                <div id="col-done" class="column done-col" ondrop="drop(event)" ondragover="allowDrop(event)"
                    ondragleave="dragLeave(event)">
                    <div class="col-header">
                        <h3>ŸÖŸÜÿ¨ÿ≤ ‚úÖ</h3><span class="count" id="count-done">0</span>
                    </div>
                    <ul id="list-done" class="task-list" ondrop="drop(event)" ondragover="allowDrop(event)"
                        ondragleave="dragLeave(event)"></ul>
                </div>
            </main>
        </div>

        <!-- ÿµŸÅÿ≠ÿ© Bucket -->
        <div id="bucket-page" class="bucket-page container">
            <div class="bucket-header">
                <h1><i class="fa-solid fa-folder-open"></i> ŸÖÿ≥ÿßÿ≠ÿ© ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ</h1>
                <p style="color: var(--tab-text);">ÿ±ŸÅÿπ Ÿàÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸàÿßŸÑÿµŸàÿ± ŸàÿßŸÑŸÅŸäÿØŸäŸàŸáÿßÿ™ (ÿ®ÿØŸàŸÜ ÿ≠ÿØ ÿ£ŸÇÿµŸâ ŸÑŸÑÿ≠ÿ¨ŸÖ)</p>
            </div>

            <div class="bucket-controls">
                <button class="upload-btn" onclick="openUploadModal()">
                    <i class="fa-solid fa-upload"></i>
                    ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ
                </button>
                <input type="text" id="bucket-search" placeholder="üîç ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖŸÑŸÅÿßÿ™..."
                    oninput="filterBucketFiles()">
            </div>

            <div id="bucket-grid" class="bucket-grid"></div>

            <div id="empty-bucket" class="empty-bucket" style="display: none;">
                <i class="fa-solid fa-folder-open"></i>
                <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">ÿßÿ®ÿØÿ£ ÿ®ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™ŸÉ ÿßŸÑÿ£ŸàŸÑŸâ!</p>
            </div>
        </div>

        <!-- ÿµŸÅÿ≠ÿ© ÿ±ŸÖÿ∂ÿßŸÜ -->
        <div id="ramadan-page" class="ramadan-page container">
            <div class="ramadan-header">
                <h1>üåô ÿ±ŸÖÿ∂ÿßŸÜ ŸÉÿ±ŸäŸÖ</h1>
                <p>ÿ™ÿ™ÿ®ÿπ ÿπÿ®ÿßÿØÿßÿ™ŸÉ Ÿàÿ£ŸáÿØÿßŸÅŸÉ ÿßŸÑÿ±ŸÖÿ∂ÿßŸÜŸäÿ©</p>
            </div>

            <!-- ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿ±ŸÖÿ∂ÿßŸÜ -->
            <div class="ramadan-tabs">
                <button class="ramadan-tab active" onclick="switchRamadanTab('prayers')">üïå ÿßŸÑÿµŸÑŸàÿßÿ™</button>
                <button class="ramadan-tab" onclick="switchRamadanTab('khatma')">üìñ ÿÆÿ™ŸÖÿ© ÿßŸÑŸÇÿ±ÿ¢ŸÜ</button>
                <button class="ramadan-tab" onclick="switchRamadanTab('taraweeh')">üåü ÿµŸÑÿßÿ© ÿßŸÑÿ™ÿ±ÿßŸàŸäÿ≠</button>
            </div>

            <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿµŸÑŸàÿßÿ™ -->
            <div id="ramadan-prayers" class="ramadan-section active">
                <div class="ramadan-card-wrap">
                    <h2 style="text-align:center; color:#4ade80; margin-bottom:20px; font-size:1.3rem;">
                        ÿµŸÑŸàÿßÿ™ ÿßŸÑŸäŸàŸÖ ‚Äî <span id="prayers-date"></span>
                    </h2>
                    <div class="prayers-grid">
                        <div class="prayer-card" id="card-fajr" onclick="togglePrayer('fajr')">
                            <span class="prayer-icon">üåÖ</span>
                            <div class="prayer-name">ÿßŸÑŸÅÿ¨ÿ±</div>
                            <div class="prayer-check" id="check-fajr">‚úì</div>
                        </div>
                        <div class="prayer-card" id="card-dhuhr" onclick="togglePrayer('dhuhr')">
                            <span class="prayer-icon">‚òÄÔ∏è</span>
                            <div class="prayer-name">ÿßŸÑÿ∏Ÿáÿ±</div>
                            <div class="prayer-check" id="check-dhuhr">‚úì</div>
                        </div>
                        <div class="prayer-card" id="card-asr" onclick="togglePrayer('asr')">
                            <span class="prayer-icon">üå§Ô∏è</span>
                            <div class="prayer-name">ÿßŸÑÿπÿµÿ±</div>
                            <div class="prayer-check" id="check-asr">‚úì</div>
                        </div>
                        <div class="prayer-card" id="card-maghrib" onclick="togglePrayer('maghrib')">
                            <span class="prayer-icon">üåá</span>
                            <div class="prayer-name">ÿßŸÑŸÖÿ∫ÿ±ÿ®</div>
                            <div class="prayer-check" id="check-maghrib">‚úì</div>
                        </div>
                        <div class="prayer-card" id="card-isha" onclick="togglePrayer('isha')">
                            <span class="prayer-icon">üåô</span>
                            <div class="prayer-name">ÿßŸÑÿπÿ¥ÿßÿ°</div>
                            <div class="prayer-check" id="check-isha">‚úì</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ŸÇÿ≥ŸÖ ÿÆÿ™ŸÖÿ© ÿßŸÑŸÇÿ±ÿ¢ŸÜ -->
            <div id="ramadan-khatma" class="ramadan-section">
                <div class="ramadan-card-wrap">
                    <h2 style="text-align:center; color:#4ade80; margin-bottom:15px; font-size:1.3rem;">üìñ ÿÆÿ™ŸÖÿ© ÿßŸÑŸÇÿ±ÿ¢ŸÜ
                        ÿßŸÑŸÉÿ±ŸäŸÖ</h2>
                    <div class="khatma-percent" id="khatma-percent-text">0 / 30 ÿ¨ÿ≤ÿ° ‚Äî 0%</div>
                    <div class="khatma-progress-bar-wrap">
                        <div class="khatma-progress-fill" id="khatma-progress-fill"></div>
                    </div>
                    <div class="juz-grid" id="juz-grid"></div>
                    <button class="finish-khatma-btn" id="finish-khatma-btn" disabled onclick="finishKhatma()">
                        üéâ ÿßŸÜŸáÿßÿ° ÿßŸÑÿÆÿ™ŸÖÿ©
                    </button>
                </div>
            </div>

            <!-- ŸÇÿ≥ŸÖ ÿµŸÑÿßÿ© ÿßŸÑÿ™ÿ±ÿßŸàŸäÿ≠ -->
            <div id="ramadan-taraweeh" class="ramadan-section">
                <div class="ramadan-card-wrap">
                    <h2 style="text-align:center; color:#4ade80; margin-bottom:20px; font-size:1.3rem;">üåü ÿµŸÑÿßÿ© ÿßŸÑÿ™ÿ±ÿßŸàŸäÿ≠
                        ‚Äî 30 ŸÑŸäŸÑÿ©</h2>
                    <div class="taraweeh-complete-msg" id="taraweeh-complete-msg">
                        üéâ ŸÖÿßÿ¥ÿßÿ° ÿßŸÑŸÑŸá! ÿ£ÿ™ŸÖŸÖÿ™ ÿµŸÑÿßÿ© ÿßŸÑÿ™ÿ±ÿßŸàŸäÿ≠ ŸÉÿßŸÖŸÑÿ©!
                    </div>
                    <div class="taraweeh-grid" id="taraweeh-grid"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        (function () {
            'use strict';

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßŸÑÿßÿ™ÿµÿßŸÑ
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const SUPABASE_URL = 'https://vpazkdotoxabplvfukoq.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwYXprZG90b3hhYnBsdmZ1a29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjkwOTIsImV4cCI6MjA4NDAwNTA5Mn0.3x8TVlW8kkPr9Qg0gF5Pq4V3qeszubSt2VmJi7wKzZ4';
            window.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const BUCKET_NAME = 'user-files';

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            window.appState = {
                view: 'week',
                currentSub: '',
                currentPage: 'tasks'
            };

            const subData = {
                week: ['ÿßŸÑÿ≥ÿ®ÿ™', 'ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿßÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©'],
                month: ['ŸäŸÜÿßŸäÿ±', 'ŸÅÿ®ÿ±ÿßŸäÿ±', 'ŸÖÿßÿ±ÿ≥', 'ÿ£ÿ®ÿ±ŸäŸÑ', 'ŸÖÿßŸäŸà', 'ŸäŸàŸÜŸäŸà', 'ŸäŸàŸÑŸäŸà', 'ÿ£ÿ∫ÿ≥ÿ∑ÿ≥', 'ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±', 'ÿ£ŸÉÿ™Ÿàÿ®ÿ±', 'ŸÜŸàŸÅŸÖÿ®ÿ±', 'ÿØŸäÿ≥ŸÖÿ®ÿ±'],
                year: ['2026']
            };

            function escapeHtml(str) {
                if (str == null || typeof str !== 'string') return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ÿßŸÑŸÖÿµÿßÿØŸÇÿ© (ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ / ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            window.showSignup = function () {
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('signup-box').style.display = 'block';
            };

            window.showLogin = function () {
                document.getElementById('signup-box').style.display = 'none';
                document.getElementById('login-box').style.display = 'block';
            };

            window.signup = async function () {
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const confirm = document.getElementById('signup-confirm').value;

                if (!name || !email || !password) {
                    alert("Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ŸÉÿßŸÅÿ© ÿßŸÑÿÆÿßŸÜÿßÿ™");
                    return;
                }
                if (password !== confirm) {
                    alert("ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ©");
                    return;
                }

                try {
                    const { data, error } = await window.supabase
                        .from('users')
                        .insert([{ name, email, password, xp: 0 }])
                        .select();

                    if (error) {
                        alert("Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸäÿØ ÿ£Ÿà ÿßŸÑÿßÿ≥ŸÖ ŸÖÿ≥ÿ¨ŸÑ ŸÖÿ≥ÿ®ŸÇÿßŸã");
                        return;
                    }

                    alert("ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠!");
                    window.showLogin();
                } catch (err) {
                    console.error(err);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ");
                }
            };

            window.login = async function () {
                const identifier = document.getElementById('login-identifier').value.trim();
                const password = document.getElementById('login-password').value;

                if (!identifier || !password) {
                    alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™");
                    return;
                }

                try {
                    const { data, error } = await window.supabase
                        .from('users')
                        .select('*')
                        .or(`email.eq.${identifier},name.eq.${identifier}`)
                        .eq('password', password)
                        .single();

                    if (error || !data) {
                        alert("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿØÿÆŸÑÿ©");
                        return;
                    }

                    localStorage.setItem('currentUser', JSON.stringify(data));
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('app-wrapper').style.display = 'block';
                    showWelcomeScreen(data.name);
                } catch (err) {
                    console.error(err);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ");
                }
            };

            window.logout = function () {
                if (confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü")) {
                    localStorage.removeItem('currentUser');
                    location.reload();
                }
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ÿßŸÑÿµŸÅÿ≠ÿßÿ™ (ÿßŸÑŸÖŸáÿßŸÖ / Bucket)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            window.showBucketPage = function () {
                window.appState.currentPage = 'bucket';
                document.getElementById('tasks-page').style.display = 'none';
                document.getElementById('bucket-page').classList.add('active');
                const rp = document.getElementById('ramadan-page');
                if (rp) { rp.classList.remove('active'); rp.style.display = 'none'; }
                renderBucketFiles();
            };

            window.showTasksPage = function () {
                window.appState.currentPage = 'tasks';
                document.getElementById('bucket-page').classList.remove('active');
                document.getElementById('tasks-page').style.display = 'block';
                const rp = document.getElementById('ramadan-page');
                if (rp) { rp.classList.remove('active'); rp.style.display = 'none'; }
            };

            // === ÿ®ÿßŸÇŸä ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ===
            function showWelcomeScreen(userName) {
                const welcomeScreen = document.getElementById('welcome-screen');
                const userNameEl = document.getElementById('welcome-user-name');

                userNameEl.textContent = userName;
                welcomeScreen.style.display = 'flex';
            }

            window.closeWelcomeScreen = function () {
                const welcomeScreen = document.getElementById('welcome-screen');
                welcomeScreen.classList.add('fade-out');

                setTimeout(() => {
                    welcomeScreen.style.display = 'none';
                    welcomeScreen.classList.remove('fade-out');
                    initApp();
                }, 500);
            };

            function getTodayName() {
                const days = ['ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿßÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'];
                return days[new Date().getDay()];
            }

            function getCurrentMonthName() {
                const months = ['ŸäŸÜÿßŸäÿ±', 'ŸÅÿ®ÿ±ÿßŸäÿ±', 'ŸÖÿßÿ±ÿ≥', 'ÿ£ÿ®ÿ±ŸäŸÑ', 'ŸÖÿßŸäŸà', 'ŸäŸàŸÜŸäŸà', 'ŸäŸàŸÑŸäŸà', 'ÿ£ÿ∫ÿ≥ÿ∑ÿ≥', 'ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±', 'ÿ£ŸÉÿ™Ÿàÿ®ÿ±', 'ŸÜŸàŸÅŸÖÿ®ÿ±', 'ÿØŸäÿ≥ŸÖÿ®ÿ±'];
                return months[new Date().getMonth()];
            }

            window.switchView = function (viewType) {
                window.showTasksPage();
                window.appState.view = viewType;

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                if (event && event.target && event.target.classList.contains('nav-btn')) {
                    event.target.classList.add('active');
                } else {
                    const btns = document.querySelectorAll('.nav-btn');
                    btns.forEach(b => {
                        if (b.getAttribute('onclick').includes(viewType)) b.classList.add('active');
                    });
                }

                const titles = {
                    week: 'ÿßŸÑÿ£ŸáÿØÿßŸÅ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©',
                    month: 'ÿ£ŸáÿØÿßŸÅ ÿßŸÑÿ¥ŸáŸàÿ±',
                    year: 'ÿ£ŸáÿØÿßŸÅ ÿßŸÑÿ≥ŸÜÿ©'
                };

                document.getElementById('view-title').innerText = titles[viewType];
                document.getElementById('progress-area').style.display = viewType === 'year' ? 'none' : 'block';

                renderSubNav();

                let defaultSub;
                if (viewType === 'week') {
                    defaultSub = getTodayName();
                } else if (viewType === 'month') {
                    defaultSub = getCurrentMonthName();
                } else {
                    defaultSub = subData[viewType][0];
                }

                switchSub(defaultSub);
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ÿßŸÑŸÖŸáÿßŸÖ (ÿπÿ±ÿ∂ÿå ÿ•ÿ∂ÿßŸÅÿ©ÿå ÿ≠ÿ∞ŸÅÿå ÿ≥ÿ≠ÿ® Ÿàÿ•ŸÅŸÑÿßÿ™)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function renderSubNav() {
                const nav = document.getElementById('sub-nav');
                nav.innerHTML = '';

                if (window.appState.view === 'year') return;

                subData[window.appState.view].forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'sub-tab';
                    btn.innerText = item;
                    btn.onclick = () => switchSub(item);
                    if (item === window.appState.currentSub) {
                        btn.classList.add('active');
                    }
                    nav.appendChild(btn);
                });
            }

            function switchSub(item) {
                window.appState.currentSub = item;
                renderSubNav();
                renderTasksFromDB();
            }

            window.addNewTask = async function () {
                const input = document.getElementById('task-input');
                const text = input.value.trim();

                if (!text) {
                    alert("ÿßŸÉÿ™ÿ® ÿßŸÑŸÖŸáŸÖÿ© ÿ£ŸàŸÑÿßŸã");
                    return;
                }

                const importance = document.getElementById('task-importance').value;
                const recursion = document.getElementById('task-recursion').value;
                const user = JSON.parse(localStorage.getItem('currentUser'));

                // --- ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ---
                // ŸÜÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÑŸÖÿ© ÿ≥ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÖŸÅÿ™ÿßÿ≠ ŸÑŸÑÿ™ÿ¥ŸÅŸäÿ±
                const secretKey = user.password;
                const encryptedText = CryptoJS.AES.encrypt(text, secretKey).toString();
                // -------------------

                const newTask = {
                    id: Date.now(),
                    text: encryptedText, // ÿßŸÑŸÜÿµ ÿßŸÑÿ¢ŸÜ ŸÖÿ¥ŸÅÿ± (ÿ±ŸÖŸàÿ≤ ÿ∫Ÿäÿ± ŸÖŸÅŸáŸàŸÖÿ©)
                    importance,
                    status: 'todo',
                    recursion,
                    view: window.appState.view,
                    sub: window.appState.currentSub,
                    user_email: user.email,
                    last_created: new Date().toLocaleDateString()
                };

                try {
                    const { error } = await window.supabase
                        .from('tasks')
                        .insert([newTask]);

                    if (error) throw error;

                    input.value = '';
                    renderTasksFromDB();
                } catch (err) {
                    console.error(err);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸáŸÖÿ©");
                }
            };


            window.deleteTaskFromDB = async function (id) {
                if (!confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸáŸÖÿ©ÿü")) return;

                try {
                    const { error } = await window.supabase
                        .from('tasks')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    renderTasksFromDB();
                } catch (err) {
                    console.error(err);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸáŸÖÿ©");
                }
            };

            async function renderTasksFromDB() {
                const lists = {
                    todo: document.getElementById('list-todo'),
                    doing: document.getElementById('list-doing'),
                    done: document.getElementById('list-done')
                };

                // ÿ™ŸÅÿ±Ÿäÿ∫ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ŸÇÿ®ŸÑ ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØ
                Object.values(lists).forEach(list => {
                    if (list) list.innerHTML = '';
                });

                const user = JSON.parse(localStorage.getItem('currentUser'));
                const secretKey = user.password;
                const counts = { todo: 0, doing: 0, done: 0 }; // ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿπÿØÿßÿØÿßÿ™

                try {
                    const { data, error } = await window.supabase
                        .from('tasks')
                        .select('*')
                        .eq('user_email', user.email)
                        .eq('view', window.appState.view)
                        .eq('sub', window.appState.currentSub);

                    if (error) throw error;

                    data.forEach(task => {
                        // --- ŸÖŸÜÿ∑ŸÇ ŸÅŸÉ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ---
                        let decryptedText = "ÿÆÿ∑ÿ£ ŸÅŸä ŸÅŸÉ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±";
                        try {
                            const bytes = CryptoJS.AES.decrypt(task.text, secretKey);
                            decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                            if (!decryptedText) decryptedText = task.text;
                        } catch (e) {
                            decryptedText = task.text;
                        }

                        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿπŸÜÿµÿ±
                        const li = document.createElement('li');
                        li.className = 'task-item';
                        li.id = task.id;
                        li.draggable = true;

                        li.ondragstart = (e) => {
                            e.dataTransfer.setData("text", e.target.id);
                            e.target.classList.add('dragging');
                        };

                        li.ondragend = (e) => {
                            e.target.classList.remove('dragging');
                        };

                        const safeText = escapeHtml(decryptedText);
                        li.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="importance-dot dot-${task.importance}"></span>
                    <span>${safeText} ${task.recursion === 'daily' ? 'üîÑ' : ''}</span>
                </div>
                <button type="button" onclick="deleteTaskFromDB(${task.id})" 
                        style="background:none; border:none; color:#ff7675; cursor:pointer; font-size:1.5rem; line-height:1;">√ó</button>
            `;

                        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸáŸÖÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ© Ÿàÿ≤ŸäÿßÿØÿ© ÿßŸÑÿπÿØÿßÿØ
                        if (lists[task.status]) {
                            lists[task.status].appendChild(li);
                            counts[task.status]++;
                        }
                    });

                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±ŸÇŸÖŸäÿ© ŸÑŸÑÿ£ÿπŸÖÿØÿ©
                    updateCounts(counts);

                    // ÿ™ÿ≠ÿØŸäÿ´ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ ŸàÿßŸÑŸÜÿµ ÿßŸÑŸÖÿ¶ŸàŸä
                    updateProgress(counts);

                } catch (err) {
                    console.error("Render Error:", err);
                }
            }
            function updateCounts(counts) {
                document.getElementById('count-todo').innerText = counts.todo;
                document.getElementById('count-doing').innerText = counts.doing;
                document.getElementById('count-done').innerText = counts.done;
            }

            function updateProgress(counts) {
                const total = counts.todo + counts.doing + counts.done;
                const percentage = total > 0 ? Math.round((counts.done / total) * 100) : 0;
                const progressBar = document.getElementById('main-progress');
                if (progressBar) progressBar.style.width = percentage + '%';
                const progressTextEl = document.getElementById('progress-percent-text');
                if (progressTextEl) progressTextEl.textContent = 'ÿ™ŸÖ ÿ•ŸÜÿ¨ÿßÿ≤ ' + percentage + '%';
            }


            window.allowDrop = function (e) {
                e.preventDefault();
                e.currentTarget.classList.add('drag-over');
            };

            window.dragLeave = function (e) {
                e.currentTarget.classList.remove('drag-over');
            };

            window.drop = async function (e) {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                const id = parseInt(e.dataTransfer.getData("text"), 10);
                const targetId = e.currentTarget.id || '';
                const newStatus = targetId.replace('list-', '').replace('col-', '');
                if (!['todo', 'doing', 'done'].includes(newStatus)) return;
                try {
                    const { error } = await window.supabase
                        .from('tasks')
                        .update({ status: newStatus })
                        .eq('id', id);
                    if (error) throw error;
                    await renderTasksFromDB();
                } catch (err) {
                    console.error(err);
                }
            };

            window.toggleNotes = function () {
                const sidebar = document.getElementById('notes-sidebar');
                sidebar.classList.toggle('active');
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑŸÄ sidebar
                if (sidebar.classList.contains('active')) {
                    renderNotesFromDB();
                }
            };

            window.openNoteModal = function (id, title, body) {
                document.getElementById('edit-note-id').value = id;
                document.getElementById('edit-note-title').value = title;
                document.getElementById('edit-note-body').value = body;
                document.getElementById('note-modal').style.display = 'flex';
            };

            window.closeNoteModal = function () {
                document.getElementById('note-modal').style.display = 'none';
            };

            window.saveNoteEdit = async function () {
                console.log('üîµ saveNoteEdit: ÿ®ÿØÿ° ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™');
                const idRaw = (document.getElementById('edit-note-id').value || '').trim();
                const title = (document.getElementById('edit-note-title').value || '').trim();
                const body = (document.getElementById('edit-note-body').value || '').trim();

                if (!idRaw) {
                    console.error('‚ùå saveNoteEdit: ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÅÿßÿ±ÿ∫');
                    alert("ÿÆÿ∑ÿ£: ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠.");
                    return;
                }
                if (!title && !body) {
                    console.warn('‚ö†Ô∏è saveNoteEdit: ÿßŸÑÿπŸÜŸàÿßŸÜ ŸàÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÅÿßÿ±ÿ∫ÿßŸÜ');
                    alert("ÿ£ÿØÿÆŸÑ ÿπŸÜŸàÿßŸÜÿßŸã ÿ£Ÿà ŸÖÿ≠ÿ™ŸàŸâ ŸÑŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©.");
                    return;
                }
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user || !user.password) {
                    console.error('‚ùå saveNoteEdit: ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    alert("ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±.");
                    return;
                }

                try {
                    const secretKey = user.password;
                    console.log('üîê saveNoteEdit: ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
                    const encryptedTitle = CryptoJS.AES.encrypt(title, secretKey).toString();
                    const encryptedBody = CryptoJS.AES.encrypt(body, secretKey).toString();
                    const idVal = /^\d+$/.test(idRaw) ? parseInt(idRaw, 10) : idRaw;

                    console.log('üíæ saveNoteEdit: ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿå ID:', idVal);
                    const { data, error } = await window.supabase
                        .from('notes')
                        .update({ title: encryptedTitle, body: encryptedBody })
                        .eq('id', idVal)
                        .eq('user_email', user.email)
                        .select('id');

                    if (error) {
                        console.error('‚ùå saveNoteEdit: ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                        throw error;
                    }
                    if (!data || data.length === 0) {
                        console.error('‚ùå saveNoteEdit: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©');
                        alert("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ£Ÿà ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑŸáÿß.");
                        return;
                    }

                    console.log('‚úÖ saveNoteEdit: ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸÜÿ¨ÿßÿ≠');
                    closeNoteModal();
                    await renderNotesFromDB(document.getElementById('search-notes').value);
                    alert('‚úì ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
                } catch (err) {
                    console.error('‚ùå saveNoteEdit: ÿÆÿ∑ÿ£:', err);
                    alert("ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿπÿØŸäŸÑ: " + (err && err.message ? err.message : err));
                }
            };

            window.addNote = async function () {
                const titleEl = document.getElementById('note-title');
                const bodyEl = document.getElementById('note-body');
                const user = JSON.parse(localStorage.getItem('currentUser'));

                console.log('üîµ addNote: ÿ®ÿØÿ° ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ¨ÿØŸäÿØÿ©');

                if (!titleEl || !bodyEl) {
                    console.error('‚ùå addNote: ÿπŸÜÿßÿµÿ± ÿßŸÑÿ•ÿØÿÆÿßŸÑ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                    alert("ÿÆÿ∑ÿ£: ÿπŸÜÿßÿµÿ± ÿßŸÑÿ•ÿØÿÆÿßŸÑ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©");
                    return;
                }

                const title = titleEl.value.trim();
                const body = bodyEl.value.trim();

                if (!title || !body) {
                    console.warn('‚ö†Ô∏è addNote: ÿßŸÑÿ≠ŸÇŸàŸÑ ŸÅÿßÿ±ÿ∫ÿ©');
                    alert("ÿ£ŸÉŸÖŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© (ÿßŸÑÿπŸÜŸàÿßŸÜ ŸàÿßŸÑŸÖÿ≠ÿ™ŸàŸâ)");
                    return;
                }

                if (!user || !user.password) {
                    console.error('‚ùå addNote: ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    alert("ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ");
                    return;
                }

                try {
                    // --- ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ---
                    const secretKey = user.password;
                    console.log('üîê addNote: ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
                    const encryptedTitle = CryptoJS.AES.encrypt(title, secretKey).toString();
                    const encryptedBody = CryptoJS.AES.encrypt(body, secretKey).toString();

                    const newNote = {
                        id: Date.now(),
                        title: encryptedTitle,
                        body: encryptedBody,
                        user_email: user.email
                    };

                    console.log('üíæ addNote: ÿ≠ŸÅÿ∏ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
                    const { data, error } = await window.supabase
                        .from('notes')
                        .insert([newNote])
                        .select();

                    if (error) {
                        console.error('‚ùå addNote: ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                        throw error;
                    }

                    console.log('‚úÖ addNote: ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ®ŸÜÿ¨ÿßÿ≠:', data);
                    titleEl.value = '';
                    bodyEl.value = '';
                    await renderNotesFromDB();
                    alert('‚úì ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                } catch (err) {
                    console.error('‚ùå addNote: ÿÆÿ∑ÿ£:', err);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©: " + (err.message || err));
                }
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (ÿπÿ±ÿ∂ÿå ÿ•ÿ∂ÿßŸÅÿ©ÿå ÿ™ÿπÿØŸäŸÑÿå ÿ≠ÿ∞ŸÅ)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            async function renderNotesFromDB(filter = "") {
                console.log('üîµ renderNotesFromDB: ÿ®ÿØÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ÿå ŸÅŸÑÿ™ÿ±:', filter);
                const area = document.getElementById('notes-list');
                if (!area) {
                    console.error('‚ùå renderNotesFromDB: ÿπŸÜÿµÿ± notes-list ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }
                area.innerHTML = '';
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) {
                    console.warn('‚ö†Ô∏è renderNotesFromDB: ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ');
                    return;
                }
                const secretKey = user.password;
                try {
                    console.log('üì° renderNotesFromDB: ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Supabase...');
                    const { data, error } = await window.supabase
                        .from('notes')
                        .select('*')
                        .eq('user_email', user.email)
                        .order('id', { ascending: false });

                    if (error) {
                        console.error('‚ùå renderNotesFromDB: ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                        throw error;
                    }

                    console.log('‚úÖ renderNotesFromDB: ÿ™ŸÖ ÿ¨ŸÑÿ®', data?.length || 0, 'ŸÖŸÑÿßÿ≠ÿ∏ÿ©');

                    if (!data || data.length === 0) {
                        area.innerHTML = '<p style="text-align:center; color:var(--tab-text); padding:20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã</p>';
                        return;
                    }

                    let displayedCount = 0;
                    (data || []).forEach(note => {
                        let decryptedTitle = "", decryptedBody = "";
                        try {
                            const titleBytes = CryptoJS.AES.decrypt(note.title, secretKey);
                            decryptedTitle = titleBytes.toString(CryptoJS.enc.Utf8) || note.title || "ÿ®ÿØŸàŸÜ ÿπŸÜŸàÿßŸÜ";
                            const bodyBytes = CryptoJS.AES.decrypt(note.body, secretKey);
                            decryptedBody = bodyBytes.toString(CryptoJS.enc.Utf8) || note.body || "";
                        } catch (e) {
                            console.warn('‚ö†Ô∏è renderNotesFromDB: ŸÅÿ¥ŸÑ ŸÅŸÉ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ± ŸÑŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©', note.id, e);
                            decryptedTitle = note.title || "ÿÆÿ∑ÿ£ ŸÅŸä ŸÅŸÉ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±";
                            decryptedBody = note.body || "";
                        }

                        if (filter && !decryptedTitle.toLowerCase().includes(filter.toLowerCase())) return;

                        displayedCount++;
                        const div = document.createElement('div');
                        div.className = 'note-card';
                        div.onclick = () => openNoteModal(note.id, decryptedTitle, decryptedBody);
                        const safeTitle = escapeHtml(decryptedTitle);
                        const noteId = note.id;
                        div.innerHTML = `
                    <h4>${safeTitle}</h4>
                    <button type="button" class="note-delete-btn" data-note-id="${escapeHtml(String(noteId))}" style="color:#ff7675; cursor:pointer; background:none; border:none; font-size:1.3rem; line-height:1;">&times;</button>
                `;
                        div.querySelector('.note-delete-btn').onclick = function (ev) {
                            ev.stopPropagation();
                            deleteNoteFromDB(noteId);
                        };
                        area.appendChild(div);
                    });

                    console.log('‚úÖ renderNotesFromDB: ÿ™ŸÖ ÿπÿ±ÿ∂', displayedCount, 'ŸÖŸÑÿßÿ≠ÿ∏ÿ©');
                } catch (err) {
                    console.error('‚ùå renderNotesFromDB: ÿÆÿ∑ÿ£:', err);
                    area.innerHTML = '<p style="text-align:center; color:#ff7675; padding:20px;">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</p>';
                }
            }



            window.deleteNoteFromDB = async function (id) {
                console.log('üîµ deleteNoteFromDB: ÿ∑ŸÑÿ® ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©ÿå ID:', id);
                if (!confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©ÿü")) {
                    console.log('‚ö†Ô∏è deleteNoteFromDB: ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ∞ŸÅ');
                    return;
                }
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) {
                    console.error('‚ùå deleteNoteFromDB: ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ');
                    return;
                }
                const idVal = typeof id === 'string' && /^\d+$/.test(id) ? parseInt(id, 10) : id;
                try {
                    console.log('üóëÔ∏è deleteNoteFromDB: ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
                    const { error } = await window.supabase
                        .from('notes')
                        .delete()
                        .eq('id', idVal)
                        .eq('user_email', user.email);
                    if (error) {
                        console.error('‚ùå deleteNoteFromDB: ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                        throw error;
                    }
                    console.log('‚úÖ deleteNoteFromDB: ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠');
                    await renderNotesFromDB(document.getElementById('search-notes').value);
                    alert('‚úì ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                } catch (err) {
                    console.error('‚ùå deleteNoteFromDB: ÿÆÿ∑ÿ£:', err);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©: " + (err.message || err));
                }
            };

            window.filterNotes = function () {
                renderNotesFromDB(document.getElementById('search-notes').value);
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Bucket (ÿ±ŸÅÿπÿå ÿπÿ±ÿ∂ÿå ÿ™ÿπÿØŸäŸÑÿå ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅÿßÿ™)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            window.openUploadModal = function () {
                document.getElementById('upload-file-title').value = '';
                document.getElementById('upload-file-input').value = '';
                document.getElementById('upload-progress').style.display = 'none';
                document.getElementById('upload-modal').style.display = 'flex';
            };

            window.closeUploadModal = function () {
                document.getElementById('upload-modal').style.display = 'none';
            };

            window.confirmUpload = async function () {
                const titleInput = document.getElementById('upload-file-title');
                const fileInput = document.getElementById('upload-file-input');
                const progressDiv = document.getElementById('upload-progress');
                const progressBar = document.getElementById('progress-bar-fill');
                const progressText = document.getElementById('upload-progress-text');

                const title = titleInput.value.trim();
                const file = fileInput.files[0];

                if (!title || !file) {
                    alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ");
                    return;
                }

                progressDiv.style.display = 'block';
                progressText.textContent = 'ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ...';
                progressBar.style.width = '0%';

                const user = JSON.parse(localStorage.getItem('currentUser'));

                // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿßÿ± ŸÑŸäÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸàÿµŸàŸÑ ÿßŸÑÿπÿßŸÖ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ÿ≥ÿ™ÿÆÿØŸÖ Supabase Auth
                const timestamp = Date.now();
                const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                // ÿ≥ŸÜÿ∂ÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÅŸä ŸÖÿ¨ŸÑÿØ ÿπÿßŸÖ ŸÑÿ£ŸÜŸÜÿß ŸÜÿ≥ÿ™ÿÆÿØŸÖ ŸÜÿ∏ÿßŸÖ login ŸäÿØŸàŸä
                const storagePath = `public/${timestamp}_${sanitizedFileName}`;

                try {
                    // 1. ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ Storage
                    const { data: uploadData, error: uploadError } = await window.supabase.storage
                        .from(BUCKET_NAME)
                        .upload(storagePath, file);

                    if (uploadError) throw uploadError;

                    progressBar.style.width = '50%';
                    progressText.textContent = 'ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...';

                    // 2. ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ±ÿßÿ®ÿ∑
                    const { data: urlData } = window.supabase.storage
                        .from(BUCKET_NAME)
                        .getPublicUrl(storagePath);

                    // 3. ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ (ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÅŸÇÿ∑)
                    const { error: dbError } = await window.supabase
                        .from('bucket_files')
                        .insert([{
                            title: title,
                            filename: file.name,
                            storage_path: storagePath,
                            file_url: urlData.publicUrl,
                            filetype: file.type,
                            filesize: file.size,
                            user_email: user.email
                            // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ŸÑÿß ŸÜÿ±ÿ≥ŸÑ user_id ŸáŸÜÿß ŸÑÿ£ŸÜŸÜÿß ŸÜÿ≥ÿ™ÿÆÿØŸÖ ŸÜÿ∏ÿßŸÖ login ŸäÿØŸàŸä
                        }]);

                    if (dbError) throw dbError;

                    progressBar.style.width = '100%';
                    progressText.textContent = '‚úì ÿ™ŸÖ ÿßŸÑÿ±ŸÅÿπ ÿ®ŸÜÿ¨ÿßÿ≠!';

                    setTimeout(() => {
                        closeUploadModal();
                        renderBucketFiles();
                    }, 1500);

                } catch (err) {
                    console.error('Error:', err);
                    progressText.textContent = `‚úó ÿÆÿ∑ÿ£: ${err.message}`;
                    // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ ŸÖŸÜ ÿßŸÑŸÄ storage ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑŸá ŸÅŸä ÿßŸÑÿØÿßÿ™ÿßÿ®Ÿäÿ≤
                    await window.supabase.storage.from(BUCKET_NAME).remove([storagePath]);
                }
            };
            async function renderBucketFiles(filter = "") {
                const grid = document.getElementById('bucket-grid');
                const emptyState = document.getElementById('empty-bucket');
                grid.innerHTML = '';

                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;

                try {
                    let query = window.supabase
                        .from('bucket_files')
                        .select('*')
                        .eq('user_email', user.email)
                        .order('uploaded_at', { ascending: false });

                    if (filter) {
                        query = query.or(`title.ilike.%${filter}%,filename.ilike.%${filter}%`);
                    }

                    const { data, error } = await query;

                    if (error) throw error;

                    if (data.length === 0) {
                        emptyState.style.display = 'block';
                        grid.style.display = 'none';
                        return;
                    }

                    emptyState.style.display = 'none';
                    grid.style.display = 'grid';

                    data.forEach(file => {
                        const item = document.createElement('div');
                        item.className = 'bucket-item';

                        const isImage = file.filetype && file.filetype.startsWith('image/');
                        const isVideo = file.filetype && file.filetype.startsWith('video/');

                        let previewHTML = '';
                        if (isImage) {
                            previewHTML = `<img src="${file.file_url}" alt="${file.title}">`;
                        } else if (isVideo) {
                            previewHTML = `<video src="${file.file_url}"></video>`;
                        } else {
                            const icon = getFileIcon(file.filetype || '');
                            previewHTML = `<i class="file-icon ${icon}"></i>`;
                        }

                        const fileSize = formatFileSize(file.filesize);
                        const uploadDate = new Date(file.uploaded_at).toLocaleDateString('ar-EG');

                        item.innerHTML = `
                    <div class="bucket-preview">
                        ${previewHTML}
                    </div>
                    <div class="bucket-info">
                        <div class="bucket-title">${file.title}</div>
                        <div class="bucket-filename">${file.filename}</div>
                        <div class="bucket-meta">
                            <span>${fileSize}</span>
                            <span>${uploadDate}</span>
                        </div>
                        <div class="bucket-actions">
                            <button class="bucket-action-btn view-btn" onclick='viewFile(${JSON.stringify(file)})'>
                                <i class="fa-solid fa-eye"></i> ÿπÿ±ÿ∂
                            </button>
                            <button class="bucket-action-btn edit-btn" onclick='editFile("${file.storage_path}", "${file.title}")'>
                                <i class="fa-solid fa-edit"></i> ÿ™ÿπÿØŸäŸÑ
                            </button>
                            <button class="bucket-action-btn delete-btn" onclick='deleteFile("${file.storage_path}", "${file.title}")'>
                                <i class="fa-solid fa-trash"></i> ÿ≠ÿ∞ŸÅ
                            </button>
                        </div>
                    </div>
                `;

                        grid.appendChild(item);
                    });
                } catch (err) {
                    console.error('Render error:', err);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™");
                }
            }

            function getFileIcon(filetype) {
                if (filetype.includes('pdf')) return 'fa-solid fa-file-pdf';
                if (filetype.includes('word') || filetype.includes('document')) return 'fa-solid fa-file-word';
                if (filetype.includes('sheet') || filetype.includes('excel')) return 'fa-solid fa-file-excel';
                if (filetype.includes('text')) return 'fa-solid fa-file-alt';
                if (filetype.includes('zip') || filetype.includes('rar')) return 'fa-solid fa-file-archive';
                return 'fa-solid fa-file';
            }

            function formatFileSize(bytes) {
                if (!bytes) return '0 B';
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
            }

            window.viewFile = function (file) {
                const modal = document.getElementById('view-modal');
                const content = document.getElementById('view-content');

                const isImage = file.filetype && file.filetype.startsWith('image/');
                const isVideo = file.filetype && file.filetype.startsWith('video/');

                if (isImage) {
                    content.innerHTML = `<img src="${file.file_url}" alt="${file.title}" style="max-width: 100%; max-height: 90vh; border-radius: 10px;">`;
                } else if (isVideo) {
                    content.innerHTML = `<video src="${file.file_url}" controls style="max-width: 100%; max-height: 90vh; border-radius: 10px;"></video>`;
                } else {
                    content.innerHTML = `
                <div style="padding: 40px; text-align: center; background: var(--card-bg); border-radius: 10px;">
                    <i class="${getFileIcon(file.filetype)}" style="font-size: 5rem; color: var(--primary-teal); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--text-color); margin-bottom: 10px;">${file.title}</h3>
                    <p style="color: var(--tab-text); margin-bottom: 20px;">${file.filename}</p>
                    <a href="${file.file_url}" download="${file.filename}" target="_blank" style="background: var(--primary-teal); color: var(--bg-dark); padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block;">
                        <i class="fa-solid fa-download"></i> ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ
                    </a>
                </div>
            `;
                }

                modal.classList.add('active');
            };

            window.closeViewModal = function () {
                document.getElementById('view-modal').classList.remove('active');
            };

            window.editFile = function (storagePath, currentTitle) {
                document.getElementById('edit-file-id').value = storagePath;
                document.getElementById('edit-file-title').value = currentTitle;
                document.getElementById('edit-file-modal').style.display = 'flex';
            };

            window.closeEditFileModal = function () {
                document.getElementById('edit-file-modal').style.display = 'none';
            };

            window.saveFileEdit = async function () {
                const storagePath = document.getElementById('edit-file-id').value;
                const newTitle = document.getElementById('edit-file-title').value.trim();

                if (!newTitle) {
                    alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ŸÑŸÑŸÖŸÑŸÅ");
                    return;
                }

                const user = JSON.parse(localStorage.getItem('currentUser'));

                try {
                    const { error } = await window.supabase
                        .from('bucket_files')
                        .update({ title: newTitle })
                        .eq('storage_path', storagePath)
                        .eq('user_email', user.email);

                    if (error) throw error;

                    closeEditFileModal();
                    renderBucketFiles();
                } catch (err) {
                    console.error(err);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ");
                }
            };

            window.deleteFile = async function (storagePath, title) {
                if (!confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ "${title}"ÿü`)) return;

                const user = JSON.parse(localStorage.getItem('currentUser'));

                try {
                    // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    const { error: dbError } = await window.supabase
                        .from('bucket_files')
                        .delete()
                        .eq('storage_path', storagePath)
                        .eq('user_email', user.email);

                    if (dbError) throw dbError;

                    // ÿ≠ÿ∞ŸÅ ŸÖŸÜ Storage
                    const { error: storageError } = await window.supabase.storage
                        .from(BUCKET_NAME)
                        .remove([storagePath]);

                    if (storageError) {
                        console.warn('Storage deletion warning:', storageError);
                    }

                    renderBucketFiles();
                } catch (err) {
                    console.error(err);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ");
                }
            };

            window.filterBucketFiles = function () {
                renderBucketFiles(document.getElementById('bucket-search').value);
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ™ÿÆÿµŸäÿµ ÿßŸÑŸÖÿ∏Ÿáÿ±
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            let tempBgImageFile = null; // ŸÖŸÑŸÅ ŸÖÿ§ŸÇÿ™ ŸÑŸÑÿµŸàÿ±ÿ©

            window.openSettingsModal = function () {
                console.log('üîµ openSettingsModal: ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™');
                document.getElementById('settings-modal').classList.add('active');
                loadCurrentSettings();
            };

            window.closeSettingsModal = function () {
                console.log('üîµ closeSettingsModal: ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™');
                document.getElementById('settings-modal').classList.remove('active');
                tempBgImageFile = null;
            };

            function loadCurrentSettings() {
                console.log('üîµ loadCurrentSettings: ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©');

                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
                const navbar = document.getElementById('navbar');
                const navbarColor = window.getComputedStyle(navbar).backgroundColor;
                const bgColor = window.getComputedStyle(document.body).backgroundColor;

                // ÿ™ÿ≠ŸàŸäŸÑ RGB ÿ•ŸÑŸâ HEX
                const navbarHex = rgbToHex(navbarColor);
                const bgHex = rgbToHex(bgColor);

                document.getElementById('navbar-color-picker').value = navbarHex;
                document.getElementById('navbar-color-value').textContent = navbarHex;

                document.getElementById('bg-color-picker').value = bgHex;
                document.getElementById('bg-color-value').textContent = bgHex;

                // ÿ™ÿ≠ŸÖŸäŸÑ ÿµŸàÿ±ÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿ•ŸÜ Ÿàÿ¨ÿØÿ™
                const bgImage = document.body.style.backgroundImage;
                if (bgImage && bgImage !== 'none') {
                    const preview = document.getElementById('bg-preview');
                    preview.style.backgroundImage = bgImage;
                    preview.classList.add('active');
                }
            }

            function rgbToHex(rgb) {
                if (rgb.startsWith('#')) return rgb;
                const values = rgb.match(/\d+/g);
                if (!values || values.length < 3) return '#000000';
                const r = parseInt(values[0]).toString(16).padStart(2, '0');
                const g = parseInt(values[1]).toString(16).padStart(2, '0');
                const b = parseInt(values[2]).toString(16).padStart(2, '0');
                return `#${r}${g}${b}`;
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇŸäŸÖÿ© ÿßŸÑŸÑŸàŸÜ ÿπŸÜÿØ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±
            document.addEventListener('DOMContentLoaded', function () {
                const navbarPicker = document.getElementById('navbar-color-picker');
                const bgPicker = document.getElementById('bg-color-picker');

                if (navbarPicker) {
                    navbarPicker.addEventListener('input', function (e) {
                        document.getElementById('navbar-color-value').textContent = e.target.value;
                        // ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©
                        document.getElementById('navbar').style.backgroundColor = e.target.value;
                    });
                }

                if (bgPicker) {
                    bgPicker.addEventListener('input', function (e) {
                        document.getElementById('bg-color-value').textContent = e.target.value;
                        // ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©
                        document.body.style.backgroundColor = e.target.value;
                    });
                }

                // ŸÖÿπÿßŸÑÿ¨ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©
                const bgImageInput = document.getElementById('bg-image-input');
                if (bgImageInput) {
                    bgImageInput.addEventListener('change', function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            previewBackgroundImage(file);
                        }
                    });
                }
            });

            function previewBackgroundImage(file) {
                console.log('üîµ previewBackgroundImage: ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ©');

                if (file.size > 10 * 1024 * 1024) {
                    alert('ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã! ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 10MB');
                    return;
                }

                tempBgImageFile = file;
                const isVideo = file.type.startsWith('video/');
                const reader = new FileReader();

                reader.onload = function (e) {
                    const preview = document.getElementById('bg-preview');

                    if (isVideo) {
                        // Remove old bg image
                        document.body.style.backgroundImage = '';
                        document.body.classList.remove('custom-bg');

                        // Remove any existing bg video
                        const oldVid = document.getElementById('bg-video-el');
                        if (oldVid) oldVid.remove();

                        // Create fullscreen background video
                        const vid = document.createElement('video');
                        vid.id = 'bg-video-el';
                        vid.src = e.target.result;
                        vid.autoplay = true;
                        vid.loop = true;
                        vid.muted = true;
                        vid.playsInline = true;
                        vid.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;pointer-events:none;';
                        document.body.appendChild(vid);

                        // Show preview thumbnail
                        preview.style.backgroundImage = '';
                        preview.style.background = 'linear-gradient(135deg,#1a1a2e,#16213e)';
                        preview.innerHTML = `<button class="remove-bg-btn" onclick="removeBackgroundImage(event)"><i class="fa-solid fa-xmark"></i></button><span style="color:#4ade80;font-size:0.8rem;margin-top:8px;">üé¨ ŸÅŸäÿØŸäŸà</span>`;
                        preview.classList.add('active');
                    } else {
                        // Image background
                        const oldVid = document.getElementById('bg-video-el');
                        if (oldVid) oldVid.remove();

                        preview.style.backgroundImage = `url(${e.target.result})`;
                        preview.innerHTML = `<button class="remove-bg-btn" onclick="removeBackgroundImage(event)"><i class="fa-solid fa-xmark"></i></button>`;
                        preview.classList.add('active');

                        document.body.style.backgroundImage = `url(${e.target.result})`;
                        document.body.classList.add('custom-bg');
                    }
                };

                reader.readAsDataURL(file);
            }

            window.removeBackgroundImage = function (event) {
                event.stopPropagation();
                console.log('üîµ removeBackgroundImage: ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ©');

                const preview = document.getElementById('bg-preview');
                preview.style.backgroundImage = '';
                preview.style.background = '';
                preview.innerHTML = `<button class="remove-bg-btn" onclick="removeBackgroundImage(event)"><i class="fa-solid fa-xmark"></i></button>`;
                preview.classList.remove('active');

                tempBgImageFile = null;
                document.getElementById('bg-image-input').value = '';

                // Remove image background
                document.body.style.backgroundImage = '';
                document.body.classList.remove('custom-bg');

                // Remove video background
                const oldVid = document.getElementById('bg-video-el');
                if (oldVid) oldVid.remove();
            };

            window.saveUserPreferences = async function () {
                console.log('üîµ saveUserPreferences: ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÅÿ∂ŸäŸÑÿßÿ™');

                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) {
                    alert('ÿÆÿ∑ÿ£: ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ');
                    return;
                }

                try {
                    const navbarColor = document.getElementById('navbar-color-picker').value;
                    const bgColor = document.getElementById('bg-color-picker').value;

                    let bgImageUrl = null;
                    let bgImagePath = null;

                    // ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ© ÿ•ŸÜ Ÿàÿ¨ÿØÿ™
                    if (tempBgImageFile) {
                        console.log('üì§ saveUserPreferences: ÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ©...');
                        const timestamp = Date.now();
                        const sanitizedFileName = tempBgImageFile.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                        const storagePath = `backgrounds/${user.email}/${timestamp}_${sanitizedFileName}`;

                        const { data: uploadData, error: uploadError } = await window.supabase.storage
                            .from(BUCKET_NAME)
                            .upload(storagePath, tempBgImageFile);

                        if (uploadError) throw uploadError;

                        const { data: urlData } = window.supabase.storage
                            .from(BUCKET_NAME)
                            .getPublicUrl(storagePath);

                        bgImageUrl = urlData.publicUrl;
                        bgImagePath = storagePath;
                        console.log('‚úÖ saveUserPreferences: ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©');
                    }

                    // ÿ≠ŸÅÿ∏ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    console.log('üíæ saveUserPreferences: ÿ≠ŸÅÿ∏ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');

                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ™ŸÅÿ∂ŸäŸÑÿßÿ™ ÿ≥ÿßÿ®ŸÇÿ©
                    const { data: existing } = await window.supabase
                        .from('user_preferences')
                        .select('*')
                        .eq('user_email', user.email)
                        .single();

                    const bgType = tempBgImageFile
                        ? (tempBgImageFile.type.startsWith('video/') ? 'video' : 'image')
                        : (existing?.bg_type || 'image');

                    const preferences = {
                        user_email: user.email,
                        navbar_color: navbarColor,
                        bg_color: bgColor,
                        bg_image_url: bgImageUrl || (existing?.bg_image_url || null),
                        bg_image_path: bgImagePath || (existing?.bg_image_path || null),
                        bg_type: bgType,
                        updated_at: new Date().toISOString()
                    };

                    let result;
                    if (existing) {
                        // ÿ™ÿ≠ÿØŸäÿ´
                        result = await window.supabase
                            .from('user_preferences')
                            .update(preferences)
                            .eq('user_email', user.email);
                    } else {
                        // ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ÿØŸäÿØ
                        preferences.id = Date.now();
                        result = await window.supabase
                            .from('user_preferences')
                            .insert([preferences]);
                    }

                    if (result.error) throw result.error;

                    console.log('‚úÖ saveUserPreferences: ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ®ŸÜÿ¨ÿßÿ≠');

                    // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ŸÅÿ∂ŸäŸÑÿßÿ™
                    applyPreferences(preferences);

                    // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage ŸÑŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ
                    localStorage.setItem('userPreferences', JSON.stringify(preferences));

                    closeSettingsModal();
                    alert('‚úì ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÅÿ∂ŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');

                } catch (err) {
                    console.error('‚ùå saveUserPreferences: ÿÆÿ∑ÿ£:', err);
                    alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÅÿ∂ŸäŸÑÿßÿ™: ' + (err.message || err));
                }
            };

            async function loadUserPreferences() {
                console.log('üîµ loadUserPreferences: ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿ∂ŸäŸÑÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');

                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;

                try {
                    // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ localStorage ÿ£ŸàŸÑÿßŸã
                    const cached = localStorage.getItem('userPreferences');
                    if (cached) {
                        const preferences = JSON.parse(cached);
                        applyPreferences(preferences);
                    }

                    // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    const { data, error } = await window.supabase
                        .from('user_preferences')
                        .select('*')
                        .eq('user_email', user.email)
                        .single();

                    if (error) {
                        if (error.code !== 'PGRST116') { // ŸÑŸäÿ≥ ÿÆÿ∑ÿ£ "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™"
                            console.error('‚ùå loadUserPreferences: ÿÆÿ∑ÿ£:', error);
                        }
                        return;
                    }

                    if (data) {
                        console.log('‚úÖ loadUserPreferences: ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ∂ŸäŸÑÿßÿ™');
                        applyPreferences(data);
                        localStorage.setItem('userPreferences', JSON.stringify(data));
                    }

                } catch (err) {
                    console.error('‚ùå loadUserPreferences: ÿÆÿ∑ÿ£:', err);
                }
            }

            function applyPreferences(preferences) {
                console.log('üé® applyPreferences: ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ŸÅÿ∂ŸäŸÑÿßÿ™');

                if (preferences.navbar_color) {
                    document.getElementById('navbar').style.backgroundColor = preferences.navbar_color;
                }

                if (preferences.bg_color) {
                    document.body.style.backgroundColor = preferences.bg_color;
                }

                // Remove any existing bg video first
                const oldVid = document.getElementById('bg-video-el');
                if (oldVid) oldVid.remove();

                if (preferences.bg_image_url) {
                    const isVideo = preferences.bg_type === 'video' ||
                        /\.(mp4|webm|ogg)(\?|$)/i.test(preferences.bg_image_url);

                    if (isVideo) {
                        document.body.style.backgroundImage = '';
                        document.body.classList.remove('custom-bg');

                        const vid = document.createElement('video');
                        vid.id = 'bg-video-el';
                        vid.src = preferences.bg_image_url;
                        vid.autoplay = true;
                        vid.loop = true;
                        vid.muted = true;
                        vid.playsInline = true;
                        vid.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;pointer-events:none;';
                        document.body.appendChild(vid);
                    } else {
                        document.body.style.backgroundImage = `url(${preferences.bg_image_url})`;
                        document.body.classList.add('custom-bg');
                    }
                } else {
                    document.body.style.backgroundImage = '';
                    document.body.classList.remove('custom-bg');
                }
            }

            window.resetToDefaults = async function () {
                if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÑŸÑŸàÿ∂ÿπ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿü')) return;

                console.log('üîµ resetToDefaults: ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÑŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©');

                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;

                try {
                    // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    await window.supabase
                        .from('user_preferences')
                        .delete()
                        .eq('user_email', user.email);

                    // ÿ≠ÿ∞ŸÅ ŸÖŸÜ localStorage
                    localStorage.removeItem('userPreferences');

                    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ£ŸÑŸàÿßŸÜ
                    document.getElementById('navbar').style.backgroundColor = '';
                    document.body.style.backgroundColor = '';
                    document.body.style.backgroundImage = '';
                    document.body.classList.remove('custom-bg');

                    // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÅŸä Modal
                    loadCurrentSettings();

                    console.log('‚úÖ resetToDefaults: ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ');
                    alert('‚úì ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');

                } catch (err) {
                    console.error('‚ùå resetToDefaults: ÿÆÿ∑ÿ£:', err);
                    alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ');
                }
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ŸÖÿ§ŸÇÿ™ ÿ®ŸàŸÖŸàÿØŸàÿ±Ÿà ŸàÿßŸÑÿ´ŸäŸÖ
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            let timerInterval;
            let isRunning = false;
            let timeLeft = 25 * 60;

            window.toggleTimer = function () {
                const btn = document.getElementById('timer-btn');
                const container = document.getElementById('pomodoro');

                if (isRunning) {
                    clearInterval(timerInterval);
                    isRunning = false;
                    btn.innerHTML = '<i class="fa-solid fa-play"></i>';
                    container.classList.remove('timer-running');
                } else {
                    isRunning = true;
                    btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                    container.classList.add('timer-running');

                    timerInterval = setInterval(() => {
                        timeLeft--;
                        updateTimerDisplay();

                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            isRunning = false;
                            alert("ÿßŸÜÿ™ŸáŸâ ŸàŸÇÿ™ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤! ÿ£ÿ≠ÿ≥ŸÜÿ™ üéâ");
                            resetTimer();
                        }
                    }, 1000);
                }
            };

            function updateTimerDisplay() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('timer-minutes').textContent = minutes.toString().padStart(2, '0');
                document.getElementById('timer-seconds').textContent = seconds.toString().padStart(2, '0');
            }

            function resetTimer() {
                clearInterval(timerInterval);
                timeLeft = 25 * 60;
                isRunning = false;
                updateTimerDisplay();
                document.getElementById('timer-btn').innerHTML = '<i class="fa-solid fa-play"></i>';
                document.getElementById('pomodoro').classList.remove('timer-running');
            }



            window.toggleTheme = function () {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            };

            function updateThemeIcon(theme) {
                const icon = document.getElementById('theme-icon');
                if (theme === 'dark') {
                    icon.className = 'fa-solid fa-moon';
                } else {
                    icon.className = 'fa-solid fa-sun';
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸàÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function initApp() {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);

                updateTimerDisplay();
                renderNotesFromDB();
                loadUserPreferences(); // ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿ∂ŸäŸÑÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                window.switchView('week');
            }

            async function checkLoginStatus() {
                const user = localStorage.getItem('currentUser');
                if (user) {
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('app-wrapper').style.display = 'block';
                    const userData = JSON.parse(user);
                    showWelcomeScreen(userData.name);
                }
            }

            checkLoginStatus();

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Burger Menu Functions
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            window.toggleMobileMenu = function () {
                const nav = document.getElementById('mobile-nav');
                const overlay = document.getElementById('menu-overlay');
                nav.classList.toggle('active');
                overlay.classList.toggle('active');
            };

            window.closeMobileMenu = function () {
                const nav = document.getElementById('mobile-nav');
                const overlay = document.getElementById('menu-overlay');
                nav.classList.remove('active');
                overlay.classList.remove('active');
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Ramadan Functions
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            // State
            let ramadanPrayers = { fajr: false, dhuhr: false, asr: false, maghrib: false, isha: false };
            let ramadanKhatma = {};   // { juz1: true, juz2: false, ... }
            let ramadanTaraweeh = {}; // { day1: true, ... }

            window.showRamadanPage = function () {
                // Hide tasks & bucket pages
                document.getElementById('tasks-page').style.display = 'none';
                document.getElementById('bucket-page').classList.remove('active');
                const rp = document.getElementById('ramadan-page');
                rp.classList.add('active');
                rp.style.display = 'block';

                // Set today's date
                const today = new Date();
                const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('prayers-date').textContent = today.toLocaleDateString('ar-SA', opts);

                // Build grids if empty
                renderJuzGrid();
                renderTaraweehGrid();

                // Load data
                loadPrayers();
                loadKhatma();
                loadTaraweeh();
            };

            window.switchRamadanTab = function (tab) {
                document.querySelectorAll('.ramadan-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.ramadan-section').forEach(s => s.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById('ramadan-' + tab).classList.add('active');
            };

            // ‚îÄ‚îÄ Prayers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            window.togglePrayer = async function (prayer) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                ramadanPrayers[prayer] = !ramadanPrayers[prayer];
                updatePrayerUI(prayer);

                const today = new Date().toISOString().split('T')[0];
                const { error } = await window.supabase
                    .from('ramadan_prayers')
                    .upsert({
                        user_email: user.email,
                        prayer_date: today,
                        prayer_name: prayer,
                        is_done: ramadanPrayers[prayer]
                    }, { onConflict: 'user_email,prayer_date,prayer_name' });
                if (error) console.error('Prayer save error:', error);
            };

            function updatePrayerUI(prayer) {
                const card = document.getElementById('card-' + prayer);
                const check = document.getElementById('check-' + prayer);
                if (ramadanPrayers[prayer]) {
                    card.classList.add('done');
                    check.textContent = '‚úì';
                } else {
                    card.classList.remove('done');
                    check.textContent = '‚úì';
                }
            }

            async function loadPrayers() {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await window.supabase
                    .from('ramadan_prayers')
                    .select('*')
                    .eq('user_email', user.email)
                    .eq('prayer_date', today);
                if (error) { console.error(error); return; }
                ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => {
                    const row = data.find(r => r.prayer_name === p);
                    ramadanPrayers[p] = row ? row.is_done : false;
                    updatePrayerUI(p);
                });
            }

            // ‚îÄ‚îÄ Khatma ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function renderJuzGrid() {
                const grid = document.getElementById('juz-grid');
                if (grid.children.length > 0) return;
                for (let i = 1; i <= 30; i++) {
                    const div = document.createElement('div');
                    div.className = 'juz-item';
                    div.id = 'juz-' + i;
                    div.onclick = () => toggleJuz(i);
                    div.innerHTML = `<span class="juz-num">ÿ¨ÿ≤ÿ°</span><span class="juz-label">${i}</span>`;
                    grid.appendChild(div);
                }
            }

            window.toggleJuz = async function (juz) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                const key = 'juz' + juz;
                ramadanKhatma[key] = !ramadanKhatma[key];
                updateKhatmaUI();

                const { error } = await window.supabase
                    .from('ramadan_khatma')
                    .upsert({
                        user_email: user.email,
                        juz_number: juz,
                        is_done: ramadanKhatma[key]
                    }, { onConflict: 'user_email,juz_number' });
                if (error) console.error('Khatma save error:', error);
            };

            function updateKhatmaUI() {
                let done = 0;
                for (let i = 1; i <= 30; i++) {
                    const key = 'juz' + i;
                    const el = document.getElementById('juz-' + i);
                    if (!el) continue;
                    if (ramadanKhatma[key]) {
                        el.classList.add('done');
                        done++;
                    } else {
                        el.classList.remove('done');
                    }
                }
                const pct = Math.round((done / 30) * 100);
                document.getElementById('khatma-percent-text').textContent = `${done} / 30 ÿ¨ÿ≤ÿ° ‚Äî ${pct}%`;
                document.getElementById('khatma-progress-fill').style.width = pct + '%';
                document.getElementById('finish-khatma-btn').disabled = done < 30;
            }

            async function loadKhatma() {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                const { data, error } = await window.supabase
                    .from('ramadan_khatma')
                    .select('*')
                    .eq('user_email', user.email);
                if (error) { console.error(error); return; }
                ramadanKhatma = {};
                data.forEach(row => { ramadanKhatma['juz' + row.juz_number] = row.is_done; });
                updateKhatmaUI();
            }

            window.finishKhatma = async function () {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                const allDone = Object.keys(ramadanKhatma).filter(k => ramadanKhatma[k]).length === 30;
                if (!allDone) return;

                alert('üéâ ŸÖÿ®ÿ±ŸàŸÉ! ÿ£ÿ™ŸÖŸÖÿ™ ÿÆÿ™ŸÖÿ© ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ ŸÉÿßŸÖŸÑÿ©! ÿ®ÿßÿ±ŸÉ ÿßŸÑŸÑŸá ŸÅŸäŸÉ.');

                if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑÿ®ÿØÿ° ŸÅŸä ÿÆÿ™ŸÖÿ© ÿ¨ÿØŸäÿØÿ©ÿü ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ŸÇÿØŸÖ.')) return;

                // Reset state locally
                ramadanKhatma = {};

                // Reset all juz in Supabase
                const updates = [];
                for (let i = 1; i <= 30; i++) {
                    updates.push(
                        window.supabase
                            .from('ramadan_khatma')
                            .update({ is_done: false })
                            .eq('user_email', user.email)
                            .eq('juz_number', i)
                    );
                }
                await Promise.all(updates);

                // Reset UI
                updateKhatmaUI();
            };

            // ‚îÄ‚îÄ Taraweeh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function renderTaraweehGrid() {
                const grid = document.getElementById('taraweeh-grid');
                if (grid.children.length > 0) return;
                for (let i = 1; i <= 30; i++) {
                    const div = document.createElement('div');
                    div.className = 'taraweeh-item';
                    div.id = 'taraweeh-' + i;
                    div.onclick = () => toggleTaraweeh(i);
                    div.innerHTML = `<span class="day-num">ŸÑŸäŸÑÿ©</span><span class="day-label">${i}</span>`;
                    grid.appendChild(div);
                }
            }

            window.toggleTaraweeh = async function (day) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                const key = 'day' + day;
                ramadanTaraweeh[key] = !ramadanTaraweeh[key];
                updateTaraweehUI();

                const { error } = await window.supabase
                    .from('ramadan_taraweeh')
                    .upsert({
                        user_email: user.email,
                        day_number: day,
                        is_done: ramadanTaraweeh[key]
                    }, { onConflict: 'user_email,day_number' });
                if (error) console.error('Taraweeh save error:', error);
            };

            function updateTaraweehUI() {
                let done = 0;
                for (let i = 1; i <= 30; i++) {
                    const key = 'day' + i;
                    const el = document.getElementById('taraweeh-' + i);
                    if (!el) continue;
                    if (ramadanTaraweeh[key]) {
                        el.classList.add('done');
                        done++;
                    } else {
                        el.classList.remove('done');
                    }
                }
                const msg = document.getElementById('taraweeh-complete-msg');
                if (done === 30) {
                    msg.style.display = 'block';
                } else {
                    msg.style.display = 'none';
                }
            }

            async function loadTaraweeh() {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                const { data, error } = await window.supabase
                    .from('ramadan_taraweeh')
                    .select('*')
                    .eq('user_email', user.email);
                if (error) { console.error(error); return; }
                ramadanTaraweeh = {};
                data.forEach(row => { ramadanTaraweeh['day' + row.day_number] = row.is_done; });
                updateTaraweehUI();
            }

        })();

    </script>
</body>

</html>
