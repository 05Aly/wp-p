<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WP Planner 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* 1. تعريف المتغيرات الشاملة للمودين */
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f8fafc;
            --input-bg: #0f172a;
            --tab-inactive: #334155;
            --tab-text: #94a3b8;
            --border-color: #334155;
            --header-bg: #1e293b;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --primary-teal: #2dd4bf;
        }

        [data-theme="light"] {
            --bg-dark: #f1f5f9;
            --card-bg: #ffffff;
            --text-color: #0f172a;
            --input-bg: #f8fafc;
            --tab-inactive: #e2e8f0;
            --tab-text: #475569;
            --border-color: #cbd5e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .main-content {
            margin-top: 80px;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header h1 {
            color: var(--primary-teal);
            margin-bottom: 15px;
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
        }

        .progress-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .progress-bar-container {
            background: #334155;
            height: 12px;
            border-radius: 10px;
            width: 50%;
            margin: 15px auto;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary-teal), #0d9488);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(45, 212, 191, 0.5);
        }

        .add-task-area {
            margin-bottom: 30px;
            text-align: center;
        }

        .input-group {
            display: inline-flex;
            gap: 12px;
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
            justify-content: center;
        }

        input,
        select,
        textarea {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 14px;
            border-radius: 8px;
            outline: none;
            transition: 0.3s;
            font-family: inherit;
            font-size: 0.95rem;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-teal);
            box-shadow: 0 0 8px rgba(45, 212, 191, 0.2);
        }

        #task-input {
            min-width: 250px;
            flex: 1;
        }

        .add-btn {
            background: var(--primary-teal);
            color: var(--bg-dark);
            cursor: pointer;
            border: none;
            font-weight: bold;
            padding: 10px 25px;
            border-radius: 8px;
            transition: 0.3s;
            font-size: 1rem;
        }

        .add-btn:hover {
            background: #0d9488;
            box-shadow: 0 0 15px rgba(13, 148, 136, 0.3);
        }

        .main-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }




        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-btn {
            background: var(--tab-inactive);
            color: var(--tab-text);
            border: none;
            padding: 8px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .nav-btn:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .nav-btn.active {
            background: var(--primary-teal);
            color: var(--bg-dark);
            font-weight: bold;
        }

        .notes-word,
        .bucket-btn {
            background: none;
            border: 1px solid var(--primary-teal);
            color: var(--primary-teal);
            padding: 8px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s ease;
        }

        .notes-word:hover,
        .bucket-btn:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .app-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-name {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary-teal);
            letter-spacing: 0.5px;
        }

        .theme-icon-container {
            font-size: 1.4rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: 0.3s;
            background: var(--tab-inactive);
            color: var(--text-color);
        }

        .theme-icon-container:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .logout-link {
            background: none;
            border: 1px solid #ff7675;
            color: #ff7675;
            width: 38px;
            height: 38px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
            font-size: 1.1rem;
        }

        .logout-link:hover {
            background: #ff7675;
            color: white;
        }

        .pomodoro-container {
            display: flex;
            align-items: center;
            background: var(--input-bg);
            padding: 5px 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            gap: 10px;
        }

        .timer-display {
            font-family: 'monospace';
            font-weight: bold;
            color: var(--primary-teal);
            font-size: 1.1rem;
            min-width: 55px;
        }

        #timer-btn {
            background: var(--primary-teal);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: 0.3s;
        }

        #timer-btn:hover {
            background: #0d9488;
            transform: scale(1.1);
        }

        .timer-running {
            box-shadow: 0 0 10px rgba(45, 212, 191, 0.5);
            border-color: var(--primary-teal);
        }

        .sub-nav {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .sub-tab {
            background: var(--tab-inactive);
            color: var(--tab-text);
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .sub-tab:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .sub-tab.active {
            background: var(--primary-teal);
            color: var(--bg-dark);
            box-shadow: 0 0 15px rgba(45, 212, 191, 0.4);
            font-weight: 600;
        }

        .columns-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            animation: fadeInUp 0.4s ease;
        }

        .column {
            background: var(--card-bg);
            min-height: 400px;
            border-radius: 20px;
            padding: 20px;
            border-top: 5px solid transparent;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .todo-col {
            border-color: var(--accent-red);
        }

        .doing-col {
            border-color: var(--accent-yellow);
        }

        .done-col {
            border-color: var(--accent-green);
        }

        .col-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .col-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--text-color);
            font-weight: 600;
        }

        .count {
            background: var(--tab-inactive);
            color: var(--text-color);
            padding: 4px 14px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
            min-height: 100px;
            transition: background 0.2s;
            border-radius: 10px;
        }

        .task-list.drag-over,
        .column.drag-over {
            background: rgba(45, 212, 191, 0.08);
        }

        .task-item {
            background: var(--input-bg);
            color: var(--text-color);
            margin-bottom: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
            animation: fadeIn 0.3s ease;
            cursor: grab;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            border-color: var(--primary-teal);
            box-shadow: 0 4px 12px rgba(45, 212, 191, 0.1);
        }

        .task-item.dragging {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--primary-teal);
            transform: scale(0.95);
        }

        .task-item:active {
            cursor: grabbing;
        }

        .importance-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
        }

        .dot-urgent {
            background: var(--accent-red);
        }

        .dot-medium {
            background: var(--accent-yellow);
        }

        .dot-normal {
            background: var(--accent-green);
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -350px;
            width: 320px;
            height: 100%;
            background: var(--card-bg);
            z-index: 2000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.4);
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-header {
            background-color: var(--primary-teal);
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--bg-dark);
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--bg-dark);
            font-size: 1.8rem;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: 0.3s;
        }

        .close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .note-inputs {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .note-inputs input,
        .note-inputs textarea {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 12px;
            border-radius: 8px;
            font-family: inherit;
            outline: none;
            font-size: 0.95rem;
            transition: 0.3s;
        }

        .note-inputs input:focus,
        .note-inputs textarea:focus {
            border-color: var(--primary-teal);
            box-shadow: 0 0 8px rgba(45, 212, 191, 0.2);
        }

        .note-inputs textarea {
            height: 120px;
            resize: none;
        }

        .add-note-btn {
            background-color: var(--primary-teal);
            color: var(--bg-dark);
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.3s;
        }

        .add-note-btn:hover {
            background-color: #0d9488;
        }

        .notes-display-area {
            padding: 0 20px 20px 20px;
            overflow-y: auto;
            flex: 1;
        }

        .note-card {
            background: var(--input-bg);
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 10px;
            border-right: 4px solid var(--primary-teal);
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-card:hover {
            background: var(--tab-inactive);
            transform: translateX(-5px);
        }

        .note-card h4 {
            margin: 0;
            color: var(--text-color);
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-body textarea {
            height: 200px;
            resize: none;
        }

        .save-edit-btn {
            background-color: var(--primary-teal);
            color: var(--bg-dark);
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .save-edit-btn:hover {
            background-color: #0d9488;
        }

        /* ============= Bucket Styles ============= */
        .bucket-page {
            display: none;
            padding-top: 80px;
            animation: fadeInUp 0.4s ease;
        }

        .bucket-page.active {
            display: block;
        }

        .bucket-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .bucket-header h1 {
            color: var(--primary-teal);
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .bucket-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .upload-btn {
            background: var(--primary-teal);
            color: var(--bg-dark);
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-btn:hover {
            background: #0d9488;
            transform: translateY(-2px);
        }

        #bucket-search {
            min-width: 300px;
            padding: 12px 20px;
            border-radius: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .bucket-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 20px;
        }

        .bucket-item {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: 0.3s;
            animation: fadeIn 0.3s ease;
        }

        .bucket-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(45, 212, 191, 0.2);
            border-color: var(--primary-teal);
        }

        .bucket-preview {
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--input-bg);
            overflow: hidden;
            position: relative;
        }

        .bucket-preview img,
        .bucket-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .bucket-preview .file-icon {
            font-size: 4rem;
            color: var(--primary-teal);
        }

        .bucket-info {
            padding: 15px;
        }

        .bucket-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-teal);
            font-size: 1.1rem;
        }

        .bucket-filename {
            font-size: 0.85rem;
            margin-bottom: 8px;
            color: var(--tab-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bucket-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--tab-text);
            margin-bottom: 12px;
        }

        .bucket-actions {
            display: flex;
            gap: 10px;
        }

        .bucket-action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            font-size: 0.9rem;
        }

        .view-btn {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .view-btn:hover {
            background: #0d9488;
        }

        .delete-btn {
            background: var(--accent-red);
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .edit-btn {
            background: var(--accent-yellow);
            color: var(--bg-dark);
        }

        .edit-btn:hover {
            background: #d97706;
        }

        .empty-bucket {
            text-align: center;
            padding: 60px 20px;
            color: var(--tab-text);
        }

        .empty-bucket i {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-bucket p {
            font-size: 1.2rem;
        }

        /* Modal للعرض */
        .view-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }

        .view-modal.active {
            display: flex;
        }

        .view-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .view-modal-content img,
        .view-modal-content video {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 10px;
        }

        .close-view-modal {
            position: absolute;
            top: -40px;
            right: 0;
            background: var(--accent-red);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        .close-view-modal:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .upload-progress {
            margin-top: 15px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .progress-item {
            margin-bottom: 10px;
            padding: 10px;
            background: var(--input-bg);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .progress-item.success {
            border-right: 3px solid var(--accent-green);
        }

        .progress-item.error {
            border-right: 3px solid var(--accent-red);
        }

        .progress-bar-upload {
            width: 100%;
            height: 8px;
            background: var(--tab-inactive);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary-teal);
            width: 0%;
            transition: width 0.3s;
        }

        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .welcome-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .welcome-content {
            text-align: center;
            animation: welcomeSlide 0.8s ease-out;
        }

        .welcome-content h2 {
            font-size: 3rem;
            color: var(--primary-teal);
            margin-bottom: 20px;
            font-weight: 800;
        }

        .welcome-content .user-name {
            font-size: 2.5rem;
            color: var(--text-color);
            font-weight: 600;
            margin-bottom: 40px;
        }

        .welcome-content p {
            font-size: 1.2rem;
            color: var(--tab-text);
            margin-bottom: 30px;
        }

        .start-btn {
            background: var(--primary-teal);
            color: var(--bg-dark);
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(45, 212, 191, 0.3);
        }

        .start-btn:hover {
            background: #0d9488;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(45, 212, 191, 0.5);
        }

        @keyframes welcomeSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-box {
            background: var(--card-bg);
            padding: 45px 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.5);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .auth-box h2 {
            color: var(--primary-teal);
            margin-bottom: 30px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .auth-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .auth-box input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
        }

        .auth-box input:focus {
            border-color: var(--primary-teal);
            box-shadow: 0 0 12px rgba(45, 212, 191, 0.2);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: var(--primary-teal);
            color: var(--bg-dark);
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .auth-btn:hover {
            background: #0d9488;
            transform: translateY(-2px);
        }

        .auth-box p {
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--tab-text);
        }

        .auth-box a {
            color: var(--primary-teal);
            text-decoration: none;
            font-weight: bold;
            transition: 0.3s;
        }

        .auth-box a:hover {
            text-decoration: underline;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============= Burger Menu Drawer (Always Visible) ============= */
        .burger-menu {
            display: flex;
            background: var(--tab-inactive);
            color: var(--text-color);
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.3rem;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .burger-menu:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
            transform: scale(1.05);
        }

        .burger-menu i {
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .burger-menu.active i {
            transform: rotate(180deg);
        }

        /* The nav-right is now a fixed right-side drawer */
        .nav-right {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: var(--card-bg);
            flex-direction: column;
            padding: 0;
            gap: 0;
            box-shadow: -8px 0 30px rgba(0, 0, 0, 0.4);
            border-left: 1px solid var(--border-color);
            z-index: 1500;
            display: flex;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-right.active {
            transform: translateX(0);
        }

        /* Drawer Header */
        .drawer-header {
            background: linear-gradient(135deg, var(--primary-teal), #0d9488);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .drawer-header h3 {
            color: var(--bg-dark);
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
        }

        .drawer-close-btn {
            background: rgba(0, 0, 0, 0.15);
            border: none;
            color: var(--bg-dark);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        .drawer-close-btn:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Drawer Nav Items */
        .drawer-nav-items {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .drawer-nav-items .nav-btn,
        .drawer-nav-items .notes-word,
        .drawer-nav-items .bucket-btn,
        .drawer-nav-items .settings-btn,
        .drawer-nav-items .ramadan-btn {
            width: 100%;
            text-align: right;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ramadan-btn {
            background: linear-gradient(135deg, #1a3a2a, #0d4a2a);
            border: 1px solid #2d7a4a;
            color: #4ade80;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        .ramadan-btn:hover {
            background: linear-gradient(135deg, #2d7a4a, #1a5c35);
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.3);
            transform: translateX(-3px);
        }

        /* Drawer Pomodoro */
        .drawer-pomodoro {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .drawer-pomodoro .pomodoro-container {
            width: 100%;
            justify-content: center;
        }

        /* Overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1400;
            display: none;
            backdrop-filter: blur(2px);
            transition: opacity 0.35s ease;
            opacity: 0;
        }

        .menu-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-nav {
                padding: 10px 15px;
            }

            .input-group {
                flex-direction: column;
            }

            .columns-container {
                grid-template-columns: 1fr;
            }

            .bucket-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============= Settings Modal Styles ============= */
        .settings-btn {
            background: var(--tab-inactive);
            color: var(--text-color);
            border: 1px solid var(--primary-teal);
            padding: 8px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-btn:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            backdrop-filter: blur(5px);
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 600px;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .settings-header h2 {
            color: var(--primary-teal);
            margin: 0;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: 0.3s;
        }

        .settings-close:hover {
            background: var(--accent-red);
            color: white;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            color: var(--text-color);
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--input-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .color-picker-group label {
            flex: 1;
            color: var(--text-color);
            font-weight: 500;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker-wrapper input[type="color"] {
            width: 60px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        .color-picker-wrapper input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker-wrapper input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .color-value {
            font-family: monospace;
            color: var(--tab-text);
            font-size: 0.9rem;
            min-width: 80px;
        }

        .bg-image-section {
            padding: 20px;
            background: var(--input-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .bg-image-upload {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: var(--card-bg);
        }

        .upload-area:hover {
            border-color: var(--primary-teal);
            background: var(--input-bg);
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--primary-teal);
            margin-bottom: 10px;
        }

        .upload-area p {
            color: var(--tab-text);
            margin: 5px 0;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .bg-preview {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px solid var(--border-color);
            display: none;
            position: relative;
        }

        .bg-preview.active {
            display: block;
        }

        .remove-bg-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-red);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        .remove-bg-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .settings-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .settings-save-btn,
        .settings-reset-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .settings-save-btn {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .settings-save-btn:hover {
            background: #0d9488;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(45, 212, 191, 0.3);
        }

        .settings-reset-btn {
            background: var(--tab-inactive);
            color: var(--text-color);
        }

        .settings-reset-btn:hover {
            background: var(--accent-red);
            color: white;
        }

        .preview-note {
            background: var(--input-bg);
            padding: 12px;
            border-radius: 8px;
            border-right: 3px solid var(--primary-teal);
            margin-top: 15px;
        }

        .preview-note p {
            margin: 0;
            color: var(--tab-text);
            font-size: 0.9rem;
        }

        /* تخصيص الخلفية */
        body.custom-bg {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        body.custom-bg::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
        }

        @media (max-width: 768px) {
            .settings-content {
                width: 95%;
                padding: 20px;
            }

            .color-picker-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .settings-actions {
                flex-direction: column;
            }
        }

        /* ============= Advanced Drag & Drop ============= */
        .drag-hover-glow {
            background-color: var(--primary-teal) !important;
            color: var(--bg-dark) !important;
            box-shadow: 0 0 15px var(--primary-teal);
            transform: scale(1.1);
            animation: pulse-glow 1.5s infinite;
        }

        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 10px rgba(45, 212, 191, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(45, 212, 191, 1);
            }

            100% {
                box-shadow: 0 0 10px rgba(45, 212, 191, 0.5);
            }
        }

        /* ============= Adhkar Section Styles ============= */
        .adhkar-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 700px;
            margin: 0 auto;
        }

        .adhkar-type-card {
            background: linear-gradient(135deg, #0d3d22, #1a5c35);
            border: 1px solid #2d7a4a;
            border-radius: 18px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.35s ease;
            position: relative;
            overflow: hidden;
        }

        .adhkar-type-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.06) 0%, transparent 70%);
            pointer-events: none;
        }

        .adhkar-type-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(74, 222, 128, 0.2);
            border-color: #4ade80;
        }

        .adhkar-type-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .adhkar-type-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 8px;
        }

        .adhkar-type-desc {
            font-size: 0.9rem;
            color: #86efac;
            margin-bottom: 15px;
        }

        .adhkar-type-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .adhkar-type-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 3px;
            width: 0%;
            transition: width 0.6s ease;
        }

        .adhkar-type-percent {
            font-size: 0.85rem;
            color: #fbbf24;
            font-weight: 600;
        }

        /* Adhkar Active Overlay */
        .adhkar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 42, 26, 0.98) 0%, rgba(13, 61, 34, 0.98) 100%);
            z-index: 6000;
            display: none;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
            overflow: hidden;
        }


        .adhkar-overlay.active {
            display: flex;
        }

        .adhkar-overlay-header {
            width: 100%;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .adhkar-overlay-title {
            color: #fbbf24;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .adhkar-close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .adhkar-close-btn:hover {
            background: rgba(239, 68, 68, 0.5);
            border-color: #ef4444;
        }

        /* Progress bar in overlay */
        .adhkar-progress-container {
            width: 90%;
            max-width: 600px;
            margin: 0 auto 20px;
            flex-shrink: 0;
        }

        .adhkar-progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #86efac;
        }

        .adhkar-progress-track {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .adhkar-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #fbbf24);
            background-size: 200% 100%;
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            animation: shimmerGold 2s linear infinite;
        }

        @keyframes shimmerGold {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .adhkar-progress-fill.complete {
            background: linear-gradient(90deg, #4ade80, #22c55e);
            animation: none;
        }

        /* Dhikr card in overlay */
        .adhkar-content-area {
            flex: 1;
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 10px;
            padding-bottom: 130px;
            /* مساحة للأزرار الثابتة */
            overflow-y: auto;
            min-height: 0;
        }


        .adhkar-text-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 35px 30px;
            width: 100%;
            text-align: center;
            position: relative;
            transition: all 0.4s ease;
        }

        .adhkar-text-card::before {
            content: '\201C';
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 4rem;
            color: rgba(251, 191, 36, 0.15);
            font-family: serif;
            line-height: 1;
        }

        .adhkar-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            line-height: 2;
            margin-bottom: 20px;
            direction: rtl;
        }

        .adhkar-count-label {
            display: inline-block;
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            padding: 5px 18px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .adhkar-status-badge {
            display: inline-block;
            margin-top: 12px;
            padding: 4px 14px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .adhkar-status-badge.done {
            background: rgba(74, 222, 128, 0.15);
            color: #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .adhkar-status-badge.pending {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        /* Controls */
        .adhkar-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 6100;
            display: flex;
            justify-content: center;
            padding: 15px 20px 25px;
            background: linear-gradient(to top, rgba(10, 30, 20, 1) 70%, transparent);
        }

        .adhkar-controls>.adhkar-nav-btns {
            width: 100%;
            max-width: 600px;
        }

        .adhkar-nav-btns {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .adhkar-nav-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            padding: 10px 22px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .adhkar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .adhkar-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .adhkar-done-btn {
            background: linear-gradient(135deg, #2d7a4a, #1a5c35);
            border: 1px solid #4ade80;
            color: #4ade80;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .adhkar-done-btn:hover {
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.4);
            transform: translateY(-2px);
        }

        .adhkar-done-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .adhkar-done-btn.already-done {
            background: rgba(74, 222, 128, 0.15);
            border-color: #4ade80;
            color: #4ade80;
        }

        /* Completion celebration */
        .adhkar-complete-msg {
            text-align: center;
            padding: 30px;
            display: none;
        }

        .adhkar-complete-msg.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .adhkar-complete-msg .emoji {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .adhkar-complete-msg h3 {
            color: #4ade80;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .adhkar-complete-msg p {
            color: #86efac;
            font-size: 1rem;
        }

        /* Inline Tasbih Counter inside Adhkar */
        .adhkar-counter-area {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 25px;
        }

        .adhkar-counter-area.active {
            display: flex;
        }

        .adhkar-tap-circle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(74, 222, 128, 0.1));
            border: 3px solid rgba(251, 191, 36, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .adhkar-tap-circle:active {
            transform: scale(0.92);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(74, 222, 128, 0.2));
            border-color: #fbbf24;
        }

        .adhkar-tap-circle.completed {
            border-color: #4ade80;
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(74, 222, 128, 0.1));
        }

        .adhkar-tap-count {
            font-size: 2.2rem;
            font-weight: 800;
            color: #fbbf24;
            line-height: 1;
        }

        .adhkar-tap-circle.completed .adhkar-tap-count {
            color: #4ade80;
        }

        .adhkar-tap-target {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        .adhkar-counter-progress {
            width: 160px;
            height: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 15px;
        }

        .adhkar-counter-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #4ade80);
            width: 0%;
            transition: width 0.2s ease;
            border-radius: 3px;
        }

        .adhkar-tap-hint {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .adhkar-tap-circle {
                width: 120px;
                height: 120px;
            }

            .adhkar-tap-count {
                font-size: 1.8rem;
            }

            .adhkar-text {
                font-size: 1.2rem;
                line-height: 1.8;
            }

            .adhkar-text-card {
                padding: 25px 20px;
            }

            .adhkar-overlay-title {
                font-size: 1.1rem;
            }
        }

        /* ============= Ramadan Section Styles ============= */
        .ramadan-page {
            display: none;
            padding-top: 90px;
            animation: fadeInUp 0.4s ease;
        }

        .ramadan-page.active {
            display: block;
        }

        .ramadan-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, #0a2a1a 0%, #0d3d22 50%, #0a2a1a 100%);
            border-radius: 20px;
            border: 1px solid #2d7a4a;
            position: relative;
            overflow: hidden;
        }

        .ramadan-header::before {
            content: '🌙';
            position: absolute;
            font-size: 8rem;
            opacity: 0.07;
            top: -10px;
            left: 20px;
        }

        .ramadan-header h1 {
            color: #4ade80;
            font-size: 2.2rem;
            margin-bottom: 8px;
        }

        .ramadan-header p {
            color: #86efac;
            font-size: 1rem;
        }

        .ramadan-tabs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .ramadan-tab {
            background: var(--tab-inactive);
            color: var(--tab-text);
            border: none;
            padding: 10px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: 0.3s;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .ramadan-tab:hover {
            background: #2d7a4a;
            color: #4ade80;
        }

        .ramadan-tab.active {
            background: linear-gradient(135deg, #2d7a4a, #1a5c35);
            color: #4ade80;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.3);
        }

        .ramadan-section {
            display: none;
            animation: fadeInUp 0.3s ease;
        }

        .ramadan-section.active {
            display: block;
        }

        /* Tasbih Section Styles */
        .tasbih-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .tasbih-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .tasbih-card:hover {
            border-color: #fbbf24;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.15);
        }

        .tasbih-icon {
            font-size: 2.5rem;
            color: #fbbf24;
            margin-bottom: 15px;
        }

        .tasbih-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 10px;
            font-family: 'Amiri', serif;
            /* Or keep current font */
        }

        .tasbih-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            border-top: 1px dashed var(--border-color);
            padding-top: 15px;
        }

        .tasbih-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tasbih-stat-label {
            font-size: 0.8rem;
            color: var(--tab-text);
            margin-bottom: 4px;
        }

        .tasbih-stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-teal);
        }

        /* Active Tasbih Overlay */
        .tasbih-active-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 3000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .tasbih-active-overlay.active {
            display: flex;
        }

        .tasbih-active-header {
            position: absolute;
            top: 30px;
            width: 100%;
            display: flex;
            justify-content: flex-start;
            padding: 0 30px;
        }

        .tasbih-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .tasbih-close-btn:hover {
            color: #fbbf24;
            transform: scale(1.1);
        }

        .tasbih-active-title {
            font-size: 3rem;
            color: #fbbf24;
            margin-bottom: 40px;
            font-family: 'Amiri', serif;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
            text-align: center;
        }

        .tasbih-counter-area {
            position: relative;
            width: 280px;
            height: 280px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: radial-gradient(circle, #1a5c35 0%, #0d3d22 100%);
            box-shadow: 0 0 40px rgba(74, 222, 128, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s ease;
            -webkit-tap-highlight-color: transparent;
            border: 8px solid rgba(251, 191, 36, 0.1);
        }

        .tasbih-counter-area:active,
        .tasbih-counter-area.clicked {
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.5), inset 0 0 30px rgba(0, 0, 0, 0.7);
        }

        .tasbih-progress-ring {
            position: absolute;
            top: -8px;
            left: -8px;
            width: calc(100% + 16px);
            height: calc(100% + 16px);
            border-radius: 50%;
            background: conic-gradient(#fbbf24 var(--progress, 0%), transparent 0);
            z-index: -1;
            transition: --progress 0.2s ease-out;
            mask: radial-gradient(transparent 68%, #000 70%);
            -webkit-mask: radial-gradient(transparent 68%, #000 70%);
        }

        /* Need custom property registration to animate conic-gradient in modern browsers */
        @property --progress {
            syntax: '<percentage>';
            inherits: false;
            initial-value: 0%;
        }

        .tasbih-count-display {
            font-size: 5rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .tasbih-active-stats {
            margin-top: 50px;
            display: flex;
            gap: 40px;
            background: rgba(0, 0, 0, 0.4);
            padding: 20px 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tasbih-active-stat {
            text-align: center;
        }

        .tasbih-active-stat span {
            display: block;
            color: var(--tab-text);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .tasbih-active-stat strong {
            display: block;
            color: white;
            font-size: 1.5rem;
        }

        @media (max-width: 600px) {
            .tasbih-counter-area {
                width: 220px;
                height: 220px;
            }

            .tasbih-count-display {
                font-size: 4rem;
            }

            .tasbih-active-title {
                font-size: 2.2rem;
            }
        }

        /* Prayers Section */
        .prayers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            max-width: 900px;
            margin: 0 auto;
        }

        .prayer-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .prayer-card:hover {
            border-color: #4ade80;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(74, 222, 128, 0.15);
        }

        .prayer-card.done {
            background: linear-gradient(135deg, #0d3d22, #1a5c35);
            border-color: #4ade80;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
        }

        .prayer-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .prayer-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .prayer-check {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            font-size: 1rem;
        }

        .prayer-card.done .prayer-check {
            background: #4ade80;
            border-color: #4ade80;
            color: #0a2a1a;
        }

        /* Khatma Section */
        .khatma-progress-bar-wrap {
            background: var(--tab-inactive);
            height: 14px;
            border-radius: 10px;
            margin: 0 auto 25px;
            max-width: 600px;
            overflow: hidden;
        }

        .khatma-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.4);
        }

        .khatma-percent {
            text-align: center;
            color: #4ade80;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .juz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            max-width: 900px;
            margin: 0 auto 25px;
        }

        .juz-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            user-select: none;
        }

        .juz-item:hover {
            border-color: #4ade80;
            transform: scale(1.05);
        }

        .juz-item.done {
            background: linear-gradient(135deg, #0d3d22, #1a5c35);
            border-color: #4ade80;
            color: #4ade80;
        }

        .juz-item .juz-num {
            font-size: 0.75rem;
            color: var(--tab-text);
            display: block;
            margin-bottom: 3px;
        }

        .juz-item .juz-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .juz-item.done .juz-num,
        .juz-item.done .juz-label {
            color: #4ade80;
        }

        .finish-khatma-btn {
            display: block;
            margin: 0 auto;
            background: linear-gradient(135deg, #2d7a4a, #1a5c35);
            color: #4ade80;
            border: 1px solid #4ade80;
            padding: 14px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .finish-khatma-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .finish-khatma-btn:not(:disabled):hover {
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.4);
            transform: translateY(-2px);
        }

        /* Taraweeh Section */
        .taraweeh-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            max-width: 900px;
            margin: 0 auto;
        }

        .taraweeh-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            user-select: none;
        }

        .taraweeh-item:hover {
            border-color: #4ade80;
            transform: scale(1.05);
        }

        .taraweeh-item.done {
            background: linear-gradient(135deg, #0d3d22, #1a5c35);
            border-color: #4ade80;
        }

        .taraweeh-item .day-num {
            font-size: 0.75rem;
            color: var(--tab-text);
            display: block;
            margin-bottom: 3px;
        }

        .taraweeh-item .day-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .taraweeh-item.done .day-num,
        .taraweeh-item.done .day-label {
            color: #4ade80;
        }

        .taraweeh-complete-msg {
            text-align: center;
            padding: 20px;
            color: #4ade80;
            font-size: 1.2rem;
            font-weight: 700;
            display: none;
        }

        .ramadan-card-wrap {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--border-color);
            max-width: 960px;
            margin: 0 auto;
        }

        /* History Styles */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .history-item {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-date {
            font-size: 0.8rem;
            color: var(--tab-text);
        }

        /* ── Advanced Task Dashboard (Folder Style) ── */
        .task-item.folder-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .task-item.folder-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-teal);
            opacity: 0.7;
        }

        .task-item.folder-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-teal);
        }

        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .folder-title {
            font-weight: bold;
            font-size: 1.05rem;
            color: var(--text-color);
        }

        .folder-meta {
            font-size: 0.85rem;
            color: var(--tab-text);
            display: flex;
            gap: 10px;
        }

        /* Side Panel (Task Details) */
        .side-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 5000;
            display: none;
            backdrop-filter: blur(3px);
        }

        .side-panel {
            position: fixed;
            top: 0;
            right: -100%;
            /* Hidden by default */
            width: 90%;
            max-width: 500px;
            height: 100%;
            background: var(--card-bg);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
            z-index: 5001;
            transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
        }

        .side-panel.open {
            right: 0;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .panel-section {
            margin-bottom: 25px;
        }

        .panel-section h4 {
            color: var(--primary-teal);
            margin-bottom: 15px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subtask-list {
            list-style: none;
            padding: 0;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--input-bg);
            border-radius: 6px;
            margin-bottom: 8px;
            transition: 0.2s;
        }

        .subtask-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .date-group {
            display: flex;
            gap: 15px;
        }

        .date-input-wrap {
            flex: 1;
        }

        .date-input-wrap label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.8rem;
            color: var(--tab-text);
        }

        .date-input-wrap input {
            width: 100%;
            padding: 8px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
        }

        .panel-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        /* ═══════════════════════════════════════════════════════
           ميزة الفرق - Teams Feature CSS
        ═══════════════════════════════════════════════════════ */

        /* صفحة الفريق الرئيسية */
        .team-page {
            display: none !important;
            padding-top: 80px;
            min-height: 100vh;
            animation: fadeInUp 0.4s ease;
        }

        .team-page.active {
            display: block !important;
        }

        /* شريط أدوات الفريق العلوي */
        .team-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px 20px 0;
            flex-wrap: wrap;
            max-width: 1400px;
            margin: 0 auto;
        }

        .team-select-wrapper {
            position: relative;
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }

        .team-select-wrapper select {
            width: 100%;
            padding: 10px 14px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-color);
            font-size: 0.95rem;
            cursor: pointer;
        }

        .team-toolbar-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.25s ease;
            white-space: nowrap;
        }

        .team-toolbar-btn.primary {
            background: var(--primary-teal);
            color: var(--bg-dark);
        }

        .team-toolbar-btn.primary:hover {
            background: #0d9488;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 212, 191, 0.35);
        }

        .team-toolbar-btn.secondary {
            background: var(--tab-inactive);
            color: var(--tab-text);
            border: 1px solid var(--border-color);
        }

        .team-toolbar-btn.secondary:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
            border-color: var(--primary-teal);
        }

        .team-toolbar-btn.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .team-toolbar-btn.danger:hover {
            background: var(--accent-red);
            color: white;
        }

        .team-name-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: linear-gradient(135deg, rgba(45, 212, 191, 0.15), rgba(13, 148, 136, 0.1));
            border: 1px solid rgba(45, 212, 191, 0.3);
            border-radius: 10px;
            color: var(--primary-teal);
            font-weight: 700;
            font-size: 1rem;
        }

        /* التخطيط الرئيسي للكانبان + السجل */
        .team-workspace {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        @media (max-width: 1024px) {
            .team-workspace {
                grid-template-columns: 1fr;
            }

            .team-activity-panel {
                order: -1;
            }
        }

        /* Kanban للمهام */
        .team-kanban {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 768px) {
            .team-kanban {
                grid-template-columns: 1fr;
            }

            .team-workspace {
                padding: 12px;
            }
        }

        .team-column {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            border-top: 4px solid transparent;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .team-col-todo {
            border-top-color: var(--accent-red);
        }

        .team-col-doing {
            border-top-color: var(--accent-yellow);
        }

        .team-col-done {
            border-top-color: var(--accent-green);
        }

        .team-col-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .team-col-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 700;
        }

        .team-col-count {
            background: var(--tab-inactive);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .team-task-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* بطاقة مهمة الفريق */
        .team-task-card {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            transition: all 0.25s ease;
            position: relative;
            backdrop-filter: blur(4px);
        }

        .team-task-card:hover {
            border-color: var(--primary-teal);
            box-shadow: 0 4px 16px rgba(45, 212, 191, 0.12);
            transform: translateY(-2px);
        }

        .team-task-card-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
            color: var(--text-color);
            line-height: 1.4;
        }

        .team-task-card-desc {
            font-size: 0.82rem;
            color: var(--tab-text);
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .team-task-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
        }

        /* chip العضو المسؤول */
        .assignee-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(45, 212, 191, 0.1);
            border: 1px solid rgba(45, 212, 191, 0.25);
            border-radius: 20px;
            padding: 3px 10px 3px 4px;
            max-width: 160px;
        }

        .assignee-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-teal);
            color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .assignee-name {
            font-size: 0.78rem;
            color: var(--primary-teal);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unassigned-chip {
            font-size: 0.78rem;
            color: var(--tab-text);
            font-style: italic;
        }

        /* تاريخ الاستحقاق */
        .task-due-chip {
            font-size: 0.75rem;
            color: var(--tab-text);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .task-due-chip.overdue {
            color: var(--accent-red);
        }

        /* أزرار إجراءات البطاقة */
        .team-task-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .task-action-btn {
            flex: 1;
            min-width: 0;
            padding: 5px 8px;
            border-radius: 7px;
            border: 1px solid var(--border-color);
            background: var(--tab-inactive);
            color: var(--tab-text);
            font-size: 0.78rem;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
            text-align: center;
        }

        .task-action-btn:hover {
            background: var(--primary-teal);
            color: var(--bg-dark);
            border-color: var(--primary-teal);
        }

        .task-action-btn.del-btn:hover {
            background: var(--accent-red);
            color: white;
            border-color: var(--accent-red);
        }

        /* زر إضافة مهمة في العمود */
        .add-team-task-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 10px;
            background: none;
            color: var(--tab-text);
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .add-team-task-btn:hover {
            border-color: var(--primary-teal);
            color: var(--primary-teal);
            background: rgba(45, 212, 191, 0.05);
        }

        /* لوحة سجل النشاط */
        .team-activity-panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            max-height: 600px;
        }

        .activity-panel-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 14px;
            font-weight: 700;
            color: var(--primary-teal);
            font-size: 0.95rem;
        }

        .activity-log-list {
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 4px;
        }

        .activity-log-list::-webkit-scrollbar {
            width: 4px;
        }

        .activity-log-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .activity-log-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .activity-item {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 10px 12px;
            border-right: 3px solid var(--primary-teal);
            animation: fadeIn 0.35s ease;
        }

        .activity-item-actor {
            font-weight: 600;
            font-size: 0.82rem;
            color: var(--primary-teal);
            margin-bottom: 3px;
        }

        .activity-item-text {
            font-size: 0.8rem;
            color: var(--text-color);
            line-height: 1.4;
        }

        .activity-item-time {
            font-size: 0.72rem;
            color: var(--tab-text);
            margin-top: 4px;
        }

        .activity-empty {
            text-align: center;
            color: var(--tab-text);
            font-size: 0.88rem;
            padding: 30px 0;
        }

        /* حالة فارغة */
        .team-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--tab-text);
        }

        .team-empty-state .empty-icon {
            font-size: 3.5rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .team-empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .team-empty-state p {
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        /* شريط البحث عن أعضاء */
        .member-search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--input-bg);
            margin-top: 6px;
        }

        .member-search-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            cursor: pointer;
            transition: 0.2s;
            border-bottom: 1px solid var(--border-color);
        }

        .member-search-item:last-child {
            border-bottom: none;
        }

        .member-search-item:hover {
            background: rgba(45, 212, 191, 0.08);
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-teal);
            color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .member-item-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .member-item-email {
            font-size: 0.78rem;
            color: var(--tab-text);
        }

        .member-invite-btn {
            padding: 5px 12px;
            background: var(--primary-teal);
            color: var(--bg-dark);
            border: none;
            border-radius: 7px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: 0.2s;
        }

        .member-invite-btn:hover {
            background: #0d9488;
        }

        .member-invite-btn:disabled {
            background: var(--tab-inactive);
            color: var(--tab-text);
            cursor: default;
        }

        /* قائمة الأعضاء الحاليين */
        .current-members-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .current-member-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--input-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .current-member-role {
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .role-owner {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-yellow);
        }

        .role-manager {
            background: rgba(45, 212, 191, 0.15);
            color: var(--primary-teal);
        }

        .role-member {
            background: var(--tab-inactive);
            color: var(--tab-text);
        }

        .remove-member-btn {
            padding: 4px 10px;
            background: rgba(239, 68, 68, 0.12);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.25);
            border-radius: 7px;
            cursor: pointer;
            font-size: 0.78rem;
            transition: 0.2s;
        }

        .remove-member-btn:hover {
            background: var(--accent-red);
            color: white;
        }

        /* Modal الفريق */
        .team-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            backdrop-filter: blur(4px);
        }

        .team-modal.open {
            display: flex;
        }

        .team-modal-box {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 28px;
            width: 90%;
            max-width: 480px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: fadeInUp 0.35s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .team-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .team-modal-header h3 {
            margin: 0;
            color: var(--primary-teal);
            font-size: 1.2rem;
        }

        .team-modal-close {
            background: none;
            border: none;
            color: var(--tab-text);
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .team-modal-close:hover {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .team-modal-body {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .team-modal-body label {
            font-size: 0.85rem;
            color: var(--tab-text);
            margin-bottom: 4px;
            display: block;
        }

        .team-modal-body input,
        .team-modal-body select,
        .team-modal-body textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.9rem;
            transition: 0.25s;
        }

        .team-modal-body input:focus,
        .team-modal-body select:focus,
        .team-modal-body textarea:focus {
            border-color: var(--primary-teal);
            box-shadow: 0 0 8px rgba(45, 212, 191, 0.2);
            outline: none;
        }

        .team-modal-body textarea {
            height: 90px;
            resize: none;
        }

        .team-modal-submit {
            width: 100%;
            padding: 12px;
            background: var(--primary-teal);
            color: var(--bg-dark);
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.25s;
            margin-top: 6px;
        }

        .team-modal-submit:hover {
            background: #0d9488;
            box-shadow: 0 4px 14px rgba(45, 212, 191, 0.35);
        }

        .team-modal-divider {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 4px 0;
        }

        .team-modal-section-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--tab-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Realtime pulse */
        .realtime-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5);
            }

            70% {
                box-shadow: 0 0 0 7px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        /* حالة الفريق الكاملة */
        .no-team-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            color: var(--tab-text);
            text-align: center;
            padding: 30px;
        }

        .no-team-selected .big-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .no-team-selected h2 {
            color: var(--text-color);
            margin-bottom: 10px;
        }

        /* ═══════════════════════════════════════════════════
           صندوق الدردشة الجماعية - Team Chat CSS
        ═══════════════════════════════════════════════════ */

        /* حاوية التخطيط الكاملة (كانبان + دردشة جنب بجنب) */
        .team-main-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 16px;
            padding: 20px;
            max-width: 1500px;
            margin: 0 auto;
        }

        @media (max-width: 1200px) {
            .team-main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* لوحة الكانبان الجانبية في التخطيط الجديد */
        .team-left-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* صندوق الدردشة */
        .team-chat-box {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 560px;
            position: sticky;
            top: 90px;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 700;
            color: var(--primary-teal);
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .chat-header-icon {
            font-size: 1.1rem;
        }

        /* منطقة الرسائل */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        /* فقاعة الرسالة */
        .chat-msg {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: fadeIn 0.25s ease;
        }

        .chat-msg.mine {
            align-self: flex-end;
            align-items: flex-end;
        }

        .chat-msg.theirs {
            align-self: flex-start;
            align-items: flex-start;
        }

        .chat-msg-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 3px;
        }

        .chat-msg-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-teal);
            color: var(--bg-dark);
            font-size: 0.65rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chat-msg.mine .chat-msg-avatar {
            background: var(--accent-yellow);
        }

        .chat-msg-name {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--tab-text);
        }

        .chat-msg-time {
            font-size: 0.65rem;
            color: var(--tab-text);
            opacity: 0.7;
        }

        .chat-msg-bubble {
            padding: 9px 13px;
            border-radius: 14px;
            font-size: 0.87rem;
            line-height: 1.5;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .chat-msg.theirs .chat-msg-bubble {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-top-right-radius: 4px;
            color: var(--text-color);
        }

        .chat-msg.mine .chat-msg-bubble {
            background: linear-gradient(135deg, var(--primary-teal), #0d9488);
            color: #0f172a;
            font-weight: 500;
            border-bottom-right-radius: 4px;
        }

        /* رسالة النظام / اليوم */
        .chat-date-divider {
            text-align: center;
            font-size: 0.72rem;
            color: var(--tab-text);
            padding: 4px 0;
            position: relative;
        }

        .chat-date-divider::before,
        .chat-date-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 28%;
            height: 1px;
            background: var(--border-color);
        }

        .chat-date-divider::before {
            right: 0;
        }

        .chat-date-divider::after {
            left: 0;
        }

        /* حالة فارغة */
        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--tab-text);
            font-size: 0.88rem;
            gap: 8px;
            opacity: 0.7;
        }

        .chat-empty-icon {
            font-size: 2.5rem;
        }

        /* شريط الإدخال */
        .chat-input-area {
            padding: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            align-items: flex-end;
            flex-shrink: 0;
            background: var(--card-bg);
            border-radius: 0 0 16px 16px;
        }

        .chat-input-wrap {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 12px;
            transition: border-color 0.2s;
            display: flex;
            align-items: center;
        }

        .chat-input-wrap:focus-within {
            border-color: var(--primary-teal);
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.1);
        }

        .chat-textarea {
            width: 100%;
            background: none;
            border: none;
            outline: none;
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.875rem;
            resize: none;
            max-height: 100px;
            line-height: 1.5;
            direction: rtl;
        }

        .chat-textarea::placeholder {
            color: var(--tab-text);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--primary-teal);
            color: var(--bg-dark);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .chat-send-btn:hover {
            background: #0d9488;
            transform: scale(1.05);
        }

        .chat-send-btn:disabled {
            background: var(--tab-inactive);
            color: var(--tab-text);
            cursor: not-allowed;
            transform: none;
        }

        /* مؤشر الكتابة  */
        .chat-typing-hint {
            font-size: 0.7rem;
            color: var(--tab-text);
            padding: 0 12px 6px;
            min-height: 18px;
            opacity: 0.8;
        }
    </style>
</head>


<body>

    <!-- Modal للإعدادات -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-content" onclick="event.stopPropagation()">
            <div class="settings-header">
                <h2><i class="fa-solid fa-palette"></i> تخصيص المظهر</h2>
                <button class="settings-close" onclick="closeSettingsModal()">×</button>
            </div>

            <!-- قسم الألوان -->
            <div class="settings-section">
                <h3><i class="fa-solid fa-droplet"></i> الألوان</h3>

                <div class="color-picker-group">
                    <label>لون شريط التنقل</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="navbar-color-picker" value="#1e293b">
                        <span class="color-value" id="navbar-color-value">#1e293b</span>
                    </div>
                </div>

                <div class="color-picker-group">
                    <label>لون الخلفية</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="bg-color-picker" value="#0f172a">
                        <span class="color-value" id="bg-color-value">#0f172a</span>
                    </div>
                </div>
            </div>

            <!-- قسم صورة/فيديو الخلفية -->
            <div class="settings-section">
                <h3><i class="fa-solid fa-image"></i> خلفية التطبيق</h3>

                <div class="bg-image-section">
                    <div class="bg-image-upload">
                        <div class="upload-area" onclick="document.getElementById('bg-image-input').click()">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <p><strong>اضغط لرفع صورة أو فيديو</strong></p>
                            <p style="font-size: 0.85rem;">JPG, PNG, GIF, MP4, WEBM (حتى 10MB)</p>
                            <input type="file" id="bg-image-input" accept="image/*,video/mp4,video/webm,video/ogg">
                        </div>

                        <div id="bg-preview" class="bg-preview">
                            <button class="remove-bg-btn" onclick="removeBackgroundImage(event)">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>

                    <div class="preview-note">
                        <p><i class="fa-solid fa-info-circle"></i> ملاحظة: الخلفية ستظهر خلف جميع العناصر</p>
                    </div>
                </div>
            </div>

            <!-- أزرار الإجراءات -->
            <div class="settings-actions">
                <button class="settings-save-btn" onclick="saveUserPreferences()">
                    <i class="fa-solid fa-check"></i>
                    حفظ التغييرات
                </button>
                <button class="settings-reset-btn" onclick="resetToDefaults()">
                    <i class="fa-solid fa-rotate-left"></i>
                    إعادة تعيين
                </button>
            </div>
        </div>
    </div>

    <!-- Modal للملاحظات -->
    <div id="note-modal" class="modal-overlay" onclick="closeNoteModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3 style="color: var(--primary-teal)">تعديل الملاحظة</h3>
                <button onclick="closeNoteModal()"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-note-id">
                <input type="text" id="edit-note-title" placeholder="العنوان">
                <textarea id="edit-note-body" placeholder="المحتوى..."></textarea>
                <button class="save-edit-btn" onclick="saveNoteEdit()">حفظ التعديلات</button>
            </div>
        </div>
    </div>

    <!-- Modal للعرض -->
    <div id="view-modal" class="view-modal">
        <div class="view-modal-content">
            <button class="close-view-modal" onclick="closeViewModal()">&times;</button>
            <div id="view-content"></div>
        </div>
    </div>

    <!-- Modal لرفع الملفات -->
    <div id="upload-modal" class="modal-overlay" onclick="closeUploadModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3 style="color: var(--primary-teal)">رفع ملف جديد</h3>
                <button onclick="closeUploadModal()"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="upload-file-title" placeholder="اسم الملف (للبحث والعرض)">
                <input type="file" id="upload-file-input" accept="*/*"
                    style="padding: 12px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color);">
                <button class="save-edit-btn" onclick="confirmUpload()">رفع الملف</button>
                <div id="upload-progress" class="upload-progress" style="display: none;">
                    <div class="progress-item">
                        <span id="upload-progress-text">جاري رفع الملف...</span>
                        <div class="progress-bar-upload">
                            <div id="progress-bar-fill" class="progress-bar-fill"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لتعديل الملف -->
    <div id="edit-file-modal" class="modal-overlay" onclick="closeEditFileModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3 style="color: var(--primary-teal)">تعديل الملف</h3>
                <button onclick="closeEditFileModal()"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-file-id">
                <input type="text" id="edit-file-title" placeholder="اسم الملف">
                <button class="save-edit-btn" onclick="saveFileEdit()">حفظ التعديلات</button>
            </div>
        </div>
    </div>

    <!-- شاشة تسجيل الدخول -->
    <div id="auth-container" class="auth-overlay">
        <div class="auth-box" id="login-box">
            <h2>تسجيل الدخول</h2>
            <div class="auth-inputs">
                <input type="text" id="login-identifier" placeholder="البريد الإلكتروني أو الاسم">
                <input type="password" id="login-password" placeholder="كلمة المرور">
            </div>
            <button onclick="login()" class="auth-btn">دخول</button>
            <p>ليس لديك حساب؟ <a href="javascript:void(0);" onclick="showSignup()">إنشاء حساب جديد</a></p>
        </div>

        <div class="auth-box" id="signup-box" style="display: none;">
            <h2>إنشاء حساب</h2>
            <div class="auth-inputs">
                <input type="text" id="signup-name" placeholder="الاسم الكامل">
                <input type="email" id="signup-email" placeholder="البريد الإلكتروني">
                <input type="password" id="signup-password" placeholder="كلمة المرور">
                <input type="password" id="signup-confirm" placeholder="تأكيد كلمة المرور">
            </div>
            <button onclick="signup()" class="auth-btn">تسجيل</button>
            <p>لديك حساب بالفعل؟ <a href="javascript:void(0);" onclick="showLogin()">تسجيل الدخول</a></p>
        </div>
    </div>

    <div id="app-wrapper" style="display: none;">

        <!-- شاشة الترحيب -->
        <div id="welcome-screen" class="welcome-screen" style="display: none;">
            <div class="welcome-content">
                <h2>مرحباً</h2>
                <div class="user-name" id="welcome-user-name"></div>
                <p>استعد لتحقيق أهدافك وإنجاز مهامك! 🚀</p>
                <button class="start-btn" onclick="closeWelcomeScreen()">ابدأ الآن</button>
            </div>
        </div>

        <!-- Overlay for burger menu -->
        <div id="menu-overlay" class="menu-overlay" onclick="closeMobileMenu()"></div>

        <!-- Drawer (slides from right) — outside nav so it's truly fixed -->
        <div class="nav-right" id="mobile-nav">
            <!-- Drawer Header -->
            <div class="drawer-header">
                <h3>📋 القائمة الرئيسية</h3>
                <button class="drawer-close-btn" onclick="closeMobileMenu()">✕</button>
            </div>

            <!-- Drawer Nav Items -->
            <div class="drawer-nav-items">
                <button class="nav-btn" onclick="switchView('week'); closeMobileMenu()">
                    <i class="fa-solid fa-calendar-week"></i> الأسابيع
                </button>
                <button class="nav-btn" onclick="switchView('month'); closeMobileMenu()">
                    <i class="fa-solid fa-calendar"></i> الشهور
                </button>
                <button class="nav-btn" onclick="switchView('year'); closeMobileMenu()">
                    <i class="fa-solid fa-calendar-days"></i> السنة
                </button>
                <button class="notes-word" onclick="toggleNotes(); closeMobileMenu()">
                    <i class="fa-solid fa-note-sticky"></i> ملاحظات
                </button>
                <button class="bucket-btn" onclick="showBucketPage(); closeMobileMenu()">
                    <i class="fa-solid fa-folder"></i> Bucket
                </button>
                <button class="settings-btn" onclick="openSettingsModal(); closeMobileMenu()">
                    <i class="fa-solid fa-palette"></i> الإعدادات
                </button>
                <button class="ramadan-btn" onclick="showRamadanPage(); closeMobileMenu()">
                    🌙 رمضان
                </button>
                <button class="nav-btn" onclick="openHistoryModal(); closeMobileMenu()">
                    <i class="fa-solid fa-clock-rotate-left"></i> سجل المهام
                </button>
                <button class="nav-btn" onclick="showTeamPage(); closeMobileMenu()"
                    style="background:linear-gradient(135deg,rgba(45,212,191,0.15),rgba(13,148,136,0.1)); border:1px solid rgba(45,212,191,0.3); color:var(--primary-teal); font-weight:700;">
                    <i class="fa-solid fa-users"></i> مساحات الفريق
                </button>
            </div>

            <!-- Pomodoro at bottom of drawer -->
            <div class="drawer-pomodoro">
                <div class="pomodoro-container" id="pomodoro">
                    <div class="timer-display">
                        <span id="timer-minutes">25</span>:<span id="timer-seconds">00</span>
                    </div>
                    <button onclick="toggleTimer()" id="timer-btn" title="ابدأ التركيز">
                        <i class="fa-solid fa-play"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- شريط التنقل -->
        <nav class="main-nav" id="navbar">
            <button class="burger-menu" id="burger-btn" onclick="toggleMobileMenu()">
                <i class="fa-solid fa-bars"></i>
            </button>

            <div class="nav-left">
                <div class="app-brand">
                    <span class="app-name">WP 2026</span>
                    <div id="theme-icon-btn" class="theme-icon-container" onclick="toggleTheme()">
                        <i id="theme-icon" class="fa-solid fa-moon"></i>
                    </div>
                </div>
                <button onclick="logout()" class="logout-link" title="تسجيل الخروج">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </nav>

        <!-- Sidebar الملاحظات -->
        <div id="notes-sidebar" class="sidebar">
            <div class="sidebar-header">
                <button class="close-btn" onclick="toggleNotes()">×</button>
                <h3>الملاحظات الشخصية</h3>
            </div>

            <div class="note-inputs">
                <input type="text" id="note-title" placeholder="عنوان الملاحظة">
                <textarea id="note-body" placeholder="المحتوى..."></textarea>
                <button class="add-note-btn" onclick="addNote()">إضافة</button>
            </div>

            <hr style="border: 0.5px solid var(--border-color); margin: 10px 20px;">

            <div style="padding: 0 20px;">
                <input type="text" id="search-notes" placeholder="بحث في العناوين..." oninput="filterNotes()"
                    style="width: 100%; padding: 8px; border-radius: 5px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color);">
            </div>

            <div id="notes-list" class="notes-display-area"></div>
        </div>

        <!-- صفحة المهام الرئيسية -->
        <div id="tasks-page" class="container main-content">
            <header>
                <h1 id="view-title">الأهداف الأسبوعية</h1>
                <div class="progress-section" id="progress-area">
                    <div class="progress-bar-container">
                        <div id="main-progress" class="progress-bar"></div>
                    </div>
                    <p id="progress-percent-text">تم إنجاز 0%</p>
                </div>
            </header>

            <section class="add-task-area">
                <div class="input-group">
                    <input type="text" id="task-input" placeholder="اكتب المهمة هنا...">
                    <select id="task-importance">
                        <option value="urgent">عاجلة (أحمر)</option>
                        <option value="medium">متوسطة (أصفر)</option>
                        <option value="normal">عادية (أخضر)</option>
                    </select>
                    <select id="task-recursion">
                        <option value="">مرة واحدة</option>
                        <option value="daily">يومياً</option>
                        <option value="weekly">أسبوعياً</option>
                        <option value="monthly">شهرياً</option>
                    </select>
                    <button onclick="addNewTask()" class="add-btn">إضافة</button>
                </div>
            </section>

            <nav class="sub-nav" id="sub-nav"></nav>

            <main class="columns-container">
                <div id="col-todo" class="column todo-col" ondrop="drop(event)" ondragover="allowDrop(event)"
                    ondragleave="dragLeave(event)">
                    <div class="col-header">
                        <h3>للقيام 🔴</h3><span class="count" id="count-todo">0</span>
                    </div>
                    <ul id="list-todo" class="task-list"></ul>
                </div>
                <div id="col-doing" class="column doing-col" ondrop="drop(event)" ondragover="allowDrop(event)"
                    ondragleave="dragLeave(event)">
                    <div class="col-header">
                        <h3>جاري العمل 🚧</h3><span class="count" id="count-doing">0</span>
                    </div>
                    <ul id="list-doing" class="task-list"></ul>
                </div>
                <div id="col-done" class="column done-col" ondrop="drop(event)" ondragover="allowDrop(event)"
                    ondragleave="dragLeave(event)">
                    <div class="col-header">
                        <h3>منجز ✅</h3><span class="count" id="count-done">0</span>
                    </div>
                    <ul id="list-done" class="task-list"></ul>
                </div>
            </main>
        </div>

        <!-- Side Panel for Task Details -->
        <div id="side-panel-overlay" class="side-panel-overlay" onclick="closeTaskPanel()"></div>
        <div id="side-panel" class="side-panel">
            <div class="panel-header">
                <h3 id="panel-task-title" contenteditable="true"
                    style="outline:none; border-bottom:1px dashed var(--tab-text); padding-bottom:2px;">عنوان المهمة
                </h3>
                <button onclick="closeTaskPanel()"
                    style="background:none; border:none; color:var(--text-color); font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="panel-body">
                <!-- Dates -->
                <div class="panel-section">
                    <h4><i class="fa-regular fa-calendar"></i> المواعيد</h4>
                    <div class="date-group">
                        <div class="date-input-wrap">
                            <label>تاريخ البدء</label>
                            <input type="datetime-local" id="task-start-date">
                        </div>
                        <div class="date-input-wrap">
                            <label>تاريخ الاستحقاق</label>
                            <input type="datetime-local" id="task-due-date">
                        </div>
                    </div>
                </div>

                <!-- Recurrence -->
                <div class="panel-section">
                    <h4><i class="fa-solid fa-rotate"></i> التكرار</h4>
                    <select id="task-recurrencerule"
                        style="width:100%; padding:10px; background:var(--input-bg); color:var(--text-color); border:1px solid var(--border-color); border-radius:8px;">
                        <option value="">بدون تكرار</option>
                        <option value='{"type":"daily"}'>يومياً</option>
                        <option value='{"type":"weekly"}'>أسبوعياً</option>
                        <option value='{"type":"monthly"}'>شهرياً</option>
                    </select>
                </div>

                <!-- Subtasks -->
                <div class="panel-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0;"><i class="fa-solid fa-list-check"></i> المهام الفرعية</h4>
                        <span id="subtask-progress" style="font-size:0.8rem; color:var(--tab-text);">0/0</span>
                    </div>
                    <ul id="subtask-list" class="subtask-list"></ul>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <input type="text" id="new-subtask-input" placeholder="إضافة مهمة فرعية..."
                            style="flex:1; padding:8px; border-radius:6px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color);">
                        <button onclick="addSubtask()"
                            style="padding:8px 12px; background:var(--primary-teal); color:var(--bg-dark); border:none; border-radius:6px; cursor:pointer;">+</button>
                    </div>
                </div>

                <!-- Notes -->
                <div class="panel-section">
                    <h4><i class="fa-regular fa-note-sticky"></i> ملاحظات تفصيلية</h4>
                    <textarea id="task-notes" placeholder="اكتب تفاصيل إضافية هنا..."
                        style="width:100%; height:120px; padding:10px; background:var(--input-bg); color:var(--text-color); border:1px solid var(--border-color); border-radius:8px; resize:vertical;"></textarea>
                </div>
            </div>
            <div class="panel-footer">
                <button onclick="deleteCurrentTask()"
                    style="background:var(--accent-red); color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;">حذف
                    المهمة</button>
                <button onclick="saveTaskDetails()"
                    style="background:var(--primary-teal); color:var(--bg-dark); padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">حفظ
                    التغييرات</button>
            </div>
        </div>

        <!-- صفحة Bucket -->
        <div id="bucket-page" class="bucket-page container">
            <div class="bucket-header">
                <h1><i class="fa-solid fa-folder-open"></i> مساحة التخزين</h1>
                <p style="color: var(--tab-text);">رفع وإدارة الملفات والصور والفيديوهات (بدون حد أقصى للحجم)</p>
            </div>

            <div class="bucket-controls">
                <button class="upload-btn" onclick="openUploadModal()">
                    <i class="fa-solid fa-upload"></i>
                    رفع ملف جديد
                </button>
                <input type="text" id="bucket-search" placeholder="🔍 البحث في الملفات..."
                    oninput="filterBucketFiles()">
            </div>

            <div id="bucket-grid" class="bucket-grid"></div>

            <div id="empty-bucket" class="empty-bucket" style="display: none;">
                <i class="fa-solid fa-folder-open"></i>
                <p>لا توجد ملفات حالياً</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">ابدأ برفع ملفاتك الأولى!</p>
            </div>
        </div>

        <!-- صفحة رمضان -->
        <div id="ramadan-page" class="ramadan-page container">
            <div class="ramadan-header">
                <h1>🌙 رمضان كريم</h1>
                <p>تتبع عباداتك وأهدافك الرمضانية</p>
            </div>

            <!-- تبويبات رمضان -->
            <div class="ramadan-tabs">
                <button class="ramadan-tab" onclick="switchRamadanTab('prayers')">🕌 الصلوات</button>
                <button class="ramadan-tab" onclick="switchRamadanTab('khatma')">📖 ختمة القرآن</button>
                <button class="ramadan-tab" onclick="switchRamadanTab('taraweeh')">🌟 صلاة التراويح</button>
                <button class="ramadan-tab" onclick="switchRamadanTab('tasbih')">📿 المسبحة الإلكترونية</button>
                <button class="ramadan-tab" onclick="switchRamadanTab('adhkar')">🤲 الأذكار</button>
            </div>

            <!-- قسم الصلوات -->
            <div id="ramadan-prayers" class="ramadan-section active">
                <div class="ramadan-card-wrap">
                    <h2 style="text-align:center; color:#4ade80; margin-bottom:20px; font-size:1.3rem;">
                        صلوات اليوم — <span id="prayers-date"></span>
                    </h2>
                    <div class="prayers-grid">
                        <div class="prayer-card" id="card-fajr" onclick="togglePrayer('fajr')">
                            <span class="prayer-icon">🌅</span>
                            <div class="prayer-name">الفجر</div>
                            <div class="prayer-check" id="check-fajr">✓</div>
                        </div>
                        <div class="prayer-card" id="card-dhuhr" onclick="togglePrayer('dhuhr')">
                            <span class="prayer-icon">☀️</span>
                            <div class="prayer-name">الظهر</div>
                            <div class="prayer-check" id="check-dhuhr">✓</div>
                        </div>
                        <div class="prayer-card" id="card-asr" onclick="togglePrayer('asr')">
                            <span class="prayer-icon">🌤️</span>
                            <div class="prayer-name">العصر</div>
                            <div class="prayer-check" id="check-asr">✓</div>
                        </div>
                        <div class="prayer-card" id="card-maghrib" onclick="togglePrayer('maghrib')">
                            <span class="prayer-icon">🌇</span>
                            <div class="prayer-name">المغرب</div>
                            <div class="prayer-check" id="check-maghrib">✓</div>
                        </div>
                        <div class="prayer-card" id="card-isha" onclick="togglePrayer('isha')">
                            <span class="prayer-icon">🌙</span>
                            <div class="prayer-name">العشاء</div>
                            <div class="prayer-check" id="check-isha">✓</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم ختمة القرآن -->
            <div id="ramadan-khatma" class="ramadan-section">
                <div class="ramadan-card-wrap">
                    <h2 style="text-align:center; color:#4ade80; margin-bottom:15px; font-size:1.3rem;">📖 ختمة القرآن
                        الكريم</h2>
                    <div class="khatma-percent" id="khatma-percent-text">0 / 30 جزء — 0%</div>
                    <div class="khatma-progress-bar-wrap">
                        <div class="khatma-progress-fill" id="khatma-progress-fill"></div>
                    </div>
                    <div class="juz-grid" id="juz-grid"></div>
                    <button class="finish-khatma-btn" id="finish-khatma-btn" disabled onclick="finishKhatma()">
                        🎉 انهاء الختمة
                    </button>
                </div>
            </div>

            <!-- قسم صلاة التراويح -->
            <div id="ramadan-taraweeh" class="ramadan-section">
                <div class="ramadan-card-wrap">
                    <h2 style="text-align:center; color:#4ade80; margin-bottom:20px; font-size:1.3rem;">🌟 صلاة التراويح
                        — 30 ليلة</h2>
                    <div class="taraweeh-complete-msg" id="taraweeh-complete-msg">
                        🎉 ماشاء الله! أتممت صلاة التراويح كاملة!
                    </div>
                    <div class="taraweeh-grid" id="taraweeh-grid"></div>
                </div>
            </div>
            <!-- قسم الأذكار -->
            <div id="ramadan-adhkar" class="ramadan-section">
                <div class="ramadan-card-wrap">
                    <h2 style="text-align:center; color:#4ade80; margin-bottom:25px; font-size:1.3rem;">🤲 أذكار الصباح
                        والمساء</h2>
                    <div class="adhkar-cards-grid">
                        <div class="adhkar-type-card" onclick="openAdhkar('morning')">
                            <span class="adhkar-type-icon">🌅</span>
                            <div class="adhkar-type-title">أذكار الصباح</div>
                            <div class="adhkar-type-desc">بعد صلاة الفجر حتى طلوع الشمس</div>
                            <div class="adhkar-type-progress">
                                <div class="adhkar-type-progress-fill" id="morning-card-progress"></div>
                            </div>
                            <div class="adhkar-type-percent" id="morning-card-percent">0%</div>
                        </div>
                        <div class="adhkar-type-card" onclick="openAdhkar('evening')">
                            <span class="adhkar-type-icon">🌇</span>
                            <div class="adhkar-type-title">أذكار المساء</div>
                            <div class="adhkar-type-desc">بعد صلاة العصر حتى المغرب</div>
                            <div class="adhkar-type-progress">
                                <div class="adhkar-type-progress-fill" id="evening-card-progress"></div>
                            </div>
                            <div class="adhkar-type-percent" id="evening-card-percent">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم المسبحة الإلكترونية -->
            <div id="ramadan-tasbih" class="ramadan-section">
                <div class="ramadan-card-wrap">
                    <h2 style="text-align:center; color:#4ade80; margin-bottom:20px; font-size:1.3rem;">📿 المسبحة
                        الإلكترونية</h2>
                    <div class="tasbih-grid">
                        <div class="tasbih-card" onclick="openTasbih('subhanallah', 'سبحان الله')">
                            <div class="tasbih-icon">🤲</div>
                            <div class="tasbih-title">سبحان الله</div>
                            <div class="tasbih-stats">
                                <div class="tasbih-stat-item">
                                    <span class="tasbih-stat-label">الإجمالي</span>
                                    <span class="tasbih-stat-value" id="total-subhanallah">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="tasbih-card" onclick="openTasbih('alhamdulillah', 'الحمد لله')">
                            <div class="tasbih-icon">📿</div>
                            <div class="tasbih-title">الحمد لله</div>
                            <div class="tasbih-stats">
                                <div class="tasbih-stat-item">
                                    <span class="tasbih-stat-label">الإجمالي</span>
                                    <span class="tasbih-stat-value" id="total-alhamdulillah">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="tasbih-card" onclick="openTasbih('allahuakbar', 'الله أكبر')">
                            <div class="tasbih-icon">🕌</div>
                            <div class="tasbih-title">الله أكبر</div>
                            <div class="tasbih-stats">
                                <div class="tasbih-stat-item">
                                    <span class="tasbih-stat-label">الإجمالي</span>
                                    <span class="tasbih-stat-value" id="total-allahuakbar">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="tasbih-card" onclick="openTasbih('lailahaillallah', 'لا إله إلا الله')">
                            <div class="tasbih-icon">✨</div>
                            <div class="tasbih-title">لا إله إلا الله</div>
                            <div class="tasbih-stats">
                                <div class="tasbih-stat-item">
                                    <span class="tasbih-stat-label">الإجمالي</span>
                                    <span class="tasbih-stat-value" id="total-lailahaillallah">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة المسبحة النشطة -->
    <div class="tasbih-active-overlay" id="tasbih-active-overlay">
        <div class="tasbih-active-header">
            <button class="tasbih-close-btn" onclick="closeTasbih()">✕</button>
        </div>
        <div class="tasbih-active-title" id="tasbih-active-title">سبحان الله</div>
        <div class="tasbih-counter-area" id="tasbih-counter-area" onclick="incrementTasbih()">
            <div class="tasbih-progress-ring" id="tasbih-progress-ring"></div>
            <div class="tasbih-count-display" id="tasbih-count-display">0</div>
        </div>
        <div class="tasbih-active-stats">
            <div class="tasbih-active-stat">
                <span>العدد الحالي</span>
                <strong id="tasbih-current-session">0</strong>
            </div>
            <div class="tasbih-active-stat">
                <span>الإجمالي العام</span>
                <strong id="tasbih-total-count">0</strong>
            </div>
        </div>
    </div>

    <!-- نافذة الأذكار النشطة -->
    <div class="adhkar-overlay" id="adhkar-overlay">
        <div class="adhkar-overlay-header">
            <div class="adhkar-overlay-title" id="adhkar-overlay-title">🌅 أذكار الصباح</div>
            <button class="adhkar-close-btn" onclick="closeAdhkar()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="adhkar-progress-container">
            <div class="adhkar-progress-info">
                <span id="adhkar-progress-label">الذكر 1 من 10</span>
                <span id="adhkar-progress-percent">0%</span>
            </div>
            <div class="adhkar-progress-track">
                <div class="adhkar-progress-fill" id="adhkar-progress-fill"></div>
            </div>
        </div>
        <div class="adhkar-content-area">
            <div class="adhkar-text-card" id="adhkar-text-card">
                <div class="adhkar-text" id="adhkar-text"></div>
                <div class="adhkar-count-label" id="adhkar-count-label">العدد: 1</div>
                <div><span class="adhkar-status-badge pending" id="adhkar-status-badge">لم يُقرأ بعد</span></div>

                <!-- عداد مسبحة مدمج -->
                <div class="adhkar-counter-area" id="adhkar-counter-area">
                    <div class="adhkar-tap-circle" id="adhkar-tap-circle" onclick="adhkarTapCount()">
                        <div class="adhkar-tap-count" id="adhkar-tap-count">0</div>
                        <div class="adhkar-tap-target" id="adhkar-tap-target">/ 100</div>
                    </div>
                    <div class="adhkar-counter-progress">
                        <div class="adhkar-counter-progress-fill" id="adhkar-counter-fill"></div>
                    </div>
                    <div class="adhkar-tap-hint">اضغط للعدّ</div>
                </div>
            </div>
            <div class="adhkar-complete-msg" id="adhkar-complete-msg">
                <div class="emoji">🎉</div>
                <h3>ماشاء الله! أتممت الأذكار</h3>
                <p>جعلها الله في ميزان حسناتك</p>
            </div>
        </div>
        <div class="adhkar-controls">
            <div class="adhkar-nav-btns">
                <button class="adhkar-nav-btn" id="adhkar-prev-btn" onclick="adhkarPrev()"><i
                        class="fa-solid fa-arrow-right"></i> السابق</button>
                <button class="adhkar-done-btn" id="adhkar-mark-btn" onclick="adhkarMarkDone()" style="flex:1;"><i
                        class="fa-solid fa-check"></i> تم</button>
                <button class="adhkar-nav-btn" id="adhkar-next-btn" onclick="adhkarNext()">التالي <i
                        class="fa-solid fa-arrow-left"></i></button>
            </div>
        </div>
    </div>

    <!-- Modal سجل المهام -->
    <div id="history-modal" class="modal-overlay" onclick="closeHistoryModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--primary-teal)">سجل المهام المنجزة (All Time)</h3>
                <button onclick="closeHistoryModal()"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="history-loading" style="text-align:center; display:none;">جاري التحميل...</div>
                <div id="history-list" class="history-list"></div>
            </div>
        </div>
    </div>
    <!-- Side Panel for Task Details -->
    <div id="side-panel-overlay" class="side-panel-overlay" onclick="closeTaskPanel()"></div>
    <div id="side-panel" class="side-panel">
        <div class="panel-header">
            <h3 id="panel-task-title" contenteditable="true"
                style="outline:none; border-bottom:1px dashed var(--tab-text); padding-bottom:2px;">عنوان المهمة</h3>
            <button onclick="closeTaskPanel()"
                style="background:none; border:none; color:var(--text-color); font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="panel-body">
            <!-- Dates -->
            <div class="panel-section">
                <h4><i class="fa-regular fa-calendar"></i> المواعيد</h4>
                <div class="date-group">
                    <div class="date-input-wrap">
                        <label>تاريخ البدء</label>
                        <input type="datetime-local" id="task-start-date">
                    </div>
                    <div class="date-input-wrap">
                        <label>تاريخ الاستحقاق</label>
                        <input type="datetime-local" id="task-due-date">
                    </div>
                </div>
            </div>

            <!-- Recurrence -->
            <div class="panel-section">
                <h4><i class="fa-solid fa-rotate"></i> التكرار</h4>
                <select id="task-recurrencerule"
                    style="width:100%; padding:10px; background:var(--input-bg); color:var(--text-color); border:1px solid var(--border-color); border-radius:8px;">
                    <option value="">بدون تكرار</option>
                    <option value='{"type":"daily"}'>يومياً</option>
                    <option value='{"type":"weekly"}'>أسبوعياً</option>
                    <option value='{"type":"monthly"}'>شهرياً</option>
                </select>
            </div>

            <!-- Subtasks -->
            <div class="panel-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0;"><i class="fa-solid fa-list-check"></i> المهام الفرعية</h4>
                    <span id="subtask-progress" style="font-size:0.8rem; color:var(--tab-text);">0/0</span>
                </div>
                <ul id="subtask-list" class="subtask-list"></ul>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="new-subtask-input" placeholder="إضافة مهمة فرعية..."
                        style="flex:1; padding:8px; border-radius:6px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color);">
                    <button onclick="addSubtask()"
                        style="padding:8px 12px; background:var(--primary-teal); color:var(--bg-dark); border:none; border-radius:6px; cursor:pointer;">+</button>
                </div>
            </div>

            <!-- Notes -->
            <div class="panel-section">
                <h4><i class="fa-regular fa-note-sticky"></i> ملاحظات تفصيلية</h4>
                <textarea id="task-notes" placeholder="اكتب تفاصيل إضافية هنا..."
                    style="width:100%; height:120px; padding:10px; background:var(--input-bg); color:var(--text-color); border:1px solid var(--border-color); border-radius:8px; resize:vertical;"></textarea>
            </div>
        </div>
        <div class="panel-footer">
            <button onclick="deleteCurrentTask()"
                style="background:var(--accent-red); color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;">حذف
                المهمة</button>
            <button onclick="saveTaskDetails()"
                style="background:var(--primary-teal); color:var(--bg-dark); padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">حفظ
                التغييرات</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════
         صفحة مساحات العمل الجماعية - Team Workspace Page
    ═══════════════════════════════════════════════════════ -->
    <div id="team-page" class="team-page">

        <!-- شريط الأدوات العلوي -->
        <div class="team-toolbar">
            <div class="team-name-badge">
                <i class="fa-solid fa-users"></i>
                <span id="team-page-title">مساحات الفريق</span>
                <span class="realtime-dot" id="realtime-indicator" style="display:none;"></span>
            </div>

            <div class="team-select-wrapper">
                <select id="team-select" onchange="onTeamSelected()">
                    <option value="">-- اختر فريقاً --</option>
                </select>
            </div>

            <button class="team-toolbar-btn primary" onclick="openCreateTeamModal()">
                <i class="fa-solid fa-plus"></i>
                إنشاء فريق
            </button>

            <button class="team-toolbar-btn secondary" id="manage-members-btn" onclick="openManageMembersModal()"
                style="display:none;">
                <i class="fa-solid fa-user-gear"></i>
                إدارة الأعضاء
            </button>

            <button class="team-toolbar-btn secondary" id="add-task-global-btn" onclick="openAddTeamTaskModal('todo')"
                style="display:none;">
                <i class="fa-solid fa-list-check"></i>
                مهمة جديدة
            </button>
        </div>

        <!-- حالة: لم يُختر فريق بعد -->
        <div class="no-team-selected" id="no-team-placeholder">
            <div class="big-icon">👥</div>
            <h2>أهلاً بك في مساحات الفريق</h2>
            <p>اختر فريقاً من القائمة أعلاه، أو أنشئ فريقاً جديداً للبدء في التعاون.</p>
            <button class="team-toolbar-btn primary" onclick="openCreateTeamModal()"
                style="max-width:200px; padding:14px 24px; font-size:1rem;">
                <i class="fa-solid fa-plus"></i> إنشاء فريق جديد
            </button>
        </div>


        <!-- التخطيط الرئيسي: كانبان + سجل + دردشة -->
        <div class="team-main-layout" id="team-workspace-content" style="display:none;">


            <!-- الجهة اليسرى: Kanban + سجل النشاط -->
            <div class="team-left-panel">

                <!-- لوحة Kanban -->
                <div class="team-kanban">
                    <!-- للقيام -->
                    <div class="team-column team-col-todo">
                        <div class="team-col-header">
                            <h3>📋 للقيام</h3>
                            <span class="team-col-count" id="team-count-todo">0</span>
                        </div>
                        <ul class="team-task-list" id="team-list-todo"></ul>
                        <button class="add-team-task-btn" onclick="openAddTeamTaskModal('todo')">
                            <i class="fa-solid fa-plus"></i> إضافة مهمة
                        </button>
                    </div>
                    <!-- جاري العمل -->
                    <div class="team-column team-col-doing">
                        <div class="team-col-header">
                            <h3>🚧 جاري العمل</h3>
                            <span class="team-col-count" id="team-count-doing">0</span>
                        </div>
                        <ul class="team-task-list" id="team-list-doing"></ul>
                        <button class="add-team-task-btn" onclick="openAddTeamTaskModal('doing')">
                            <i class="fa-solid fa-plus"></i> إضافة مهمة
                        </button>
                    </div>
                    <!-- منجز -->
                    <div class="team-column team-col-done">
                        <div class="team-col-header">
                            <h3>✅ منجز</h3>
                            <span class="team-col-count" id="team-count-done">0</span>
                        </div>
                        <ul class="team-task-list" id="team-list-done"></ul>
                        <button class="add-team-task-btn" onclick="openAddTeamTaskModal('done')">
                            <i class="fa-solid fa-plus"></i> إضافة مهمة
                        </button>
                    </div>
                </div><!-- end .team-kanban -->

                <!-- سجل النشاط -->
                <div class="team-activity-panel">
                    <div class="activity-panel-header">
                        <i class="fa-solid fa-clock-rotate-left"></i> سجل النشاط
                    </div>
                    <div class="activity-log-list" id="activity-log-list">
                        <div class="activity-empty">لا يوجد نشاط بعد</div>
                    </div>
                </div>

            </div><!-- end .team-left-panel -->

            <!-- الجهة اليمنى: صندوق الدردشة -->
            <div class="team-chat-box" id="team-chat-box">

                <!-- رأس الدردشة -->
                <div class="chat-header">
                    <span class="chat-header-icon">💬</span>
                    <span>دردشة الفريق</span>
                    <span class="realtime-dot" style="margin-right:auto;"></span>
                </div>

                <!-- منطقة الرسائل -->
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-empty">
                        <div class="chat-empty-icon">💬</div>
                        <span>لا توجد رسائل بعد — كن أول من يتحدث!</span>
                    </div>
                </div>

                <!-- مؤشر الكتابة -->
                <div class="chat-typing-hint" id="chat-typing-hint"></div>

                <!-- حقل الإدخال -->
                <div class="chat-input-area">
                    <div class="chat-input-wrap">
                        <textarea id="chat-input" class="chat-textarea" placeholder="اكتب رسالة..." rows="1"
                            onkeydown="chatHandleKeydown(event)" oninput="chatAutoResize(this)"></textarea>
                    </div>
                    <button class="chat-send-btn" id="chat-send-btn" onclick="sendChatMessage()" title="إرسال (Enter)">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>

            </div><!-- end .team-chat-box -->

        </div><!-- end .team-main-layout -->
    </div><!-- end #team-page -->




    <!-- ═══════════════════════════════════════════════════
         Modal إنشاء فريق جديد
    ═══════════════════════════════════════════════════ -->
    <div class="team-modal" id="create-team-modal">
        <div class="team-modal-box">
            <div class="team-modal-header">
                <h3><i class="fa-solid fa-users"></i> إنشاء فريق جديد</h3>
                <button class="team-modal-close" onclick="closeCreateTeamModal()">×</button>
            </div>
            <div class="team-modal-body">
                <div>
                    <label>اسم الفريق</label>
                    <input type="text" id="new-team-name" placeholder="مثال: فريق التسويق">
                </div>
                <button class="team-modal-submit" onclick="submitCreateTeam()">
                    <i class="fa-solid fa-plus"></i> إنشاء الفريق
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         Modal إدارة الأعضاء
    ═══════════════════════════════════════════════════ -->
    <div class="team-modal" id="manage-members-modal">
        <div class="team-modal-box">
            <div class="team-modal-header">
                <h3><i class="fa-solid fa-user-gear"></i> إدارة الأعضاء</h3>
                <button class="team-modal-close" onclick="closeManageMembersModal()">×</button>
            </div>
            <div class="team-modal-body">

                <!-- قسم دعوة عضو جديد -->
                <div>
                    <p class="team-modal-section-title">دعوة عضو جديد</p>
                    <input type="text" id="member-search-input" placeholder="ابحث باسم المستخدم أو البريد..."
                        oninput="searchUsersDebounced()">
                    <div class="member-search-results" id="member-search-results" style="display:none;"></div>
                </div>

                <hr class="team-modal-divider">

                <!-- قائمة الأعضاء الحاليين -->
                <div>
                    <p class="team-modal-section-title">أعضاء الفريق الحاليون</p>
                    <div class="current-members-list" id="current-members-list">
                        <div style="text-align:center; color:var(--tab-text); padding:15px;">جاري التحميل...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         Modal إضافة مهمة للفريق
    ═══════════════════════════════════════════════════ -->
    <div class="team-modal" id="add-team-task-modal">
        <div class="team-modal-box">
            <div class="team-modal-header">
                <h3><i class="fa-solid fa-list-check"></i> إضافة مهمة للفريق</h3>
                <button class="team-modal-close" onclick="closeAddTeamTaskModal()">×</button>
            </div>
            <div class="team-modal-body">
                <input type="hidden" id="task-initial-status" value="todo">
                <div>
                    <label>عنوان المهمة *</label>
                    <input type="text" id="new-team-task-title" placeholder="اكتب عنوان المهمة">
                </div>
                <div>
                    <label>الوصف (اختياري)</label>
                    <textarea id="new-team-task-desc" placeholder="تفاصيل إضافية..."></textarea>
                </div>
                <div>
                    <label>تعيين إلى عضو</label>
                    <select id="new-team-task-assignee">
                        <option value="">-- بدون تعيين --</option>
                    </select>
                </div>
                <div>
                    <label>تاريخ الاستحقاق (اختياري)</label>
                    <input type="date" id="new-team-task-due">
                </div>
                <button class="team-modal-submit" onclick="submitAddTeamTask()">
                    <i class="fa-solid fa-plus"></i> إضافة المهمة
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         Modal تعيين مسؤول لمهمة موجودة
    ═══════════════════════════════════════════════════ -->
    <div class="team-modal" id="assign-task-modal">
        <div class="team-modal-box">
            <div class="team-modal-header">
                <h3><i class="fa-solid fa-user-check"></i> تعيين مسؤول</h3>
                <button class="team-modal-close" onclick="closeAssignTaskModal()">×</button>
            </div>
            <div class="team-modal-body">
                <input type="hidden" id="assign-task-id">
                <div>
                    <label>اختر العضو المسؤول</label>
                    <select id="assign-member-select">
                        <option value="">-- بدون تعيين --</option>
                    </select>
                </div>
                <button class="team-modal-submit" onclick="submitAssignMember()">
                    <i class="fa-solid fa-check"></i> تأكيد التعيين
                </button>
            </div>
        </div>
    </div>

    <!-- ─── Auth Script مستقل: يُشغَّل قبل الـ IIFE ويضمن توفر دوال تسجيل الدخول ─── -->
    <script>
        (function authInit() {
            // تهيئة Supabase
            const _URL = 'https://vpazkdotoxabplvfukoq.supabase.co';
            const _KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwYXprZG90b3hhYnBsdmZ1a29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjkwOTIsImV4cCI6MjA4NDAwNTA5Mn0.3x8TVlW8kkPr9Qg0gF5Pq4V3qeszubSt2VmJi7wKzZ4';
            try {
                const _lib = (typeof supabase !== 'undefined') ? supabase : window.supabase;
                if (_lib && typeof _lib.createClient === 'function') {
                    window.supabase = _lib.createClient(_URL, _KEY);
                }
            } catch (e) { console.error('Supabase init failed:', e); }

            // دوال المصادقة
            window.showSignup = function () {
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('signup-box').style.display = 'block';
            };
            window.showLogin = function () {
                document.getElementById('signup-box').style.display = 'none';
                document.getElementById('login-box').style.display = 'block';
            };
            window.login = async function () {
                const identifier = document.getElementById('login-identifier').value.trim();
                const password = document.getElementById('login-password').value;
                if (!identifier || !password) { alert('يرجى إدخال البيانات'); return; }
                if (!window.supabase) { alert('خطأ في الاتصال، أعد تحميل الصفحة'); return; }
                try {
                    const { data, error } = await window.supabase
                        .from('users').select('*')
                        .or(`email.eq.${identifier},name.eq.${identifier}`)
                        .eq('password', password).single();
                    if (error || !data) { alert('خطأ في البيانات المدخلة'); return; }
                    localStorage.setItem('currentUser', JSON.stringify(data));
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('app-wrapper').style.display = 'block';
                    if (typeof window.showWelcomeScreen === 'function') window.showWelcomeScreen(data.name);
                } catch (err) { console.error(err); alert('حدث خطأ أثناء تسجيل الدخول'); }
            };
            window.signup = async function () {
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const confirm = document.getElementById('signup-confirm').value;
                if (!name || !email || !password) { alert('يرجى ملء كافة الخانات'); return; }
                if (password !== confirm) { alert('كلمات المرور غير متطابقة'); return; }
                if (!window.supabase) { alert('خطأ في الاتصال، أعد تحميل الصفحة'); return; }
                try {
                    const { error } = await window.supabase
                        .from('users').insert([{ name, email, password, xp: 0 }]);
                    if (error) { alert('هذا البريد أو الاسم مسجل مسبقاً'); return; }
                    alert('تم إنشاء الحساب بنجاح!');
                    window.showLogin();
                } catch (err) { console.error(err); alert('حدث خطأ أثناء التسجيل'); }
            };
            window.logout = function () {
                if (confirm('هل تريد تسجيل الخروج؟')) {
                    localStorage.removeItem('currentUser');
                    location.reload();
                }
            };
        })();
    </script>

    <script>
        (function () {
            'use strict';



            // ═══════════════════════════════════════════════════════════════
            // الإعدادات والاتصال
            // ═══════════════════════════════════════════════════════════════
            const SUPABASE_URL = 'https://vpazkdotoxabplvfukoq.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwYXprZG90b3hhYnBsdmZ1a29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjkwOTIsImV4cCI6MjA4NDAwNTA5Mn0.3x8TVlW8kkPr9Qg0gF5Pq4V3qeszubSt2VmJi7wKzZ4';

            // تهيئة Supabase مع حماية من الأخطاء
            try {
                if (typeof window.supabase?.createClient === 'function') {
                    window.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                } else if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                } else {
                    console.error('Supabase library not loaded!');
                }
            } catch (e) {
                console.error('Supabase init error:', e);
            }

            const BUCKET_NAME = 'user-files';


            // ═══════════════════════════════════════════════════════════════
            // حالة التطبيق
            // ═══════════════════════════════════════════════════════════════
            window.appState = {
                view: 'week',
                currentSub: '',
                currentPage: 'tasks'
            };

            const subData = {
                week: ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'],
                month: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
                year: ['2026']
            };

            function escapeHtml(str) {
                if (str == null || typeof str !== 'string') return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            // ═══════════════════════════════════════════════════════════════
            // المصادقة (تسجيل الدخول / إنشاء حساب)
            // ═══════════════════════════════════════════════════════════════
            window.showSignup = function () {
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('signup-box').style.display = 'block';
            };

            window.showLogin = function () {
                document.getElementById('signup-box').style.display = 'none';
                document.getElementById('login-box').style.display = 'block';
            };

            window.signup = async function () {
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const confirm = document.getElementById('signup-confirm').value;

                if (!name || !email || !password) {
                    alert("يرجى ملء كافة الخانات");
                    return;
                }
                if (password !== confirm) {
                    alert("كلمات المرور غير متطابقة");
                    return;
                }

                try {
                    const { data, error } = await window.supabase
                        .from('users')
                        .insert([{ name, email, password, xp: 0 }])
                        .select();

                    if (error) {
                        alert("هذا البريد أو الاسم مسجل مسبقاً");
                        return;
                    }

                    alert("تم إنشاء الحساب بنجاح!");
                    window.showLogin();
                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء التسجيل");
                }
            };

            window.login = async function () {
                const identifier = document.getElementById('login-identifier').value.trim();
                const password = document.getElementById('login-password').value;

                if (!identifier || !password) {
                    alert("يرجى إدخال البيانات");
                    return;
                }

                try {
                    const { data, error } = await window.supabase
                        .from('users')
                        .select('*')
                        .or(`email.eq.${identifier},name.eq.${identifier}`)
                        .eq('password', password)
                        .single();

                    if (error || !data) {
                        alert("خطأ في البيانات المدخلة");
                        return;
                    }

                    localStorage.setItem('currentUser', JSON.stringify(data));
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('app-wrapper').style.display = 'block';
                    showWelcomeScreen(data.name);
                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء تسجيل الدخول");
                }
            };

            window.logout = function () {
                if (confirm("هل تريد تسجيل الخروج؟")) {
                    localStorage.removeItem('currentUser');
                    location.reload();
                }
            };

            // ═══════════════════════════════════════════════════════════════
            // الصفحات (المهام / Bucket)
            // ═══════════════════════════════════════════════════════════════
            window.showBucketPage = function () {
                window.appState.currentPage = 'bucket';
                document.getElementById('tasks-page').style.display = 'none';
                document.getElementById('bucket-page').classList.add('active');
                const rp = document.getElementById('ramadan-page');
                if (rp) { rp.classList.remove('active'); rp.style.display = 'none'; }
                // إخفاء صفحة الفرق
                const tp = document.getElementById('team-page');
                if (tp) { tp.classList.remove('active'); tp.style.display = ''; }
                renderBucketFiles();
            };

            window.showTasksPage = function () {
                window.appState.currentPage = 'tasks';
                document.getElementById('bucket-page').classList.remove('active');
                document.getElementById('tasks-page').style.display = 'block';
                const rp = document.getElementById('ramadan-page');
                if (rp) { rp.classList.remove('active'); rp.style.display = 'none'; }
                // إخفاء صفحة الفرق
                const tp = document.getElementById('team-page');
                if (tp) { tp.classList.remove('active'); tp.style.display = ''; }
            };

            // === باقي الوظائف ===
            function showWelcomeScreen(userName) {
                const welcomeScreen = document.getElementById('welcome-screen');
                const userNameEl = document.getElementById('welcome-user-name');

                userNameEl.textContent = userName;
                welcomeScreen.style.display = 'flex';
            }

            window.closeWelcomeScreen = function () {
                const welcomeScreen = document.getElementById('welcome-screen');
                welcomeScreen.classList.add('fade-out');

                setTimeout(() => {
                    welcomeScreen.style.display = 'none';
                    welcomeScreen.classList.remove('fade-out');
                    initApp();
                }, 500);
            };

            function getTodayName() {
                const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                return days[new Date().getDay()];
            }

            function getCurrentMonthName() {
                const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                return months[new Date().getMonth()];
            }

            window.switchView = function (viewType) {
                window.showTasksPage();
                window.appState.view = viewType;

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                if (event && event.target && event.target.classList.contains('nav-btn')) {
                    event.target.classList.add('active');
                } else {
                    const btns = document.querySelectorAll('.nav-btn');
                    btns.forEach(b => {
                        if (b.getAttribute('onclick').includes(viewType)) b.classList.add('active');
                    });
                }

                const titles = {
                    week: 'الأهداف الأسبوعية',
                    month: 'أهداف الشهور',
                    year: 'أهداف السنة'
                };

                document.getElementById('view-title').innerText = titles[viewType];
                document.getElementById('progress-area').style.display = viewType === 'year' ? 'none' : 'block';

                renderSubNav();

                let defaultSub;
                if (viewType === 'week') {
                    defaultSub = getTodayName();
                } else if (viewType === 'month') {
                    defaultSub = getCurrentMonthName();
                } else {
                    defaultSub = subData[viewType][0];
                }

                switchSub(defaultSub);
            };

            // ═══════════════════════════════════════════════════════════════
            // المهام (عرض، إضافة، حذف، سحب وإفلات)
            // ═══════════════════════════════════════════════════════════════

            let dragTimeout; // For Auto-Open on Hover
            window.draggedTaskId = null; // Persists ID across tab re-renders

            function renderSubNav() {
                const nav = document.getElementById('sub-nav');
                nav.innerHTML = '';

                if (window.appState.view === 'year') return;

                subData[window.appState.view].forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'sub-tab';
                    btn.innerText = item;
                    btn.onclick = () => switchSub(item);

                    // Advanced Drag & Drop to Tab
                    btn.ondragover = (e) => {
                        e.preventDefault();
                    };

                    btn.ondragenter = (e) => {
                        e.preventDefault();
                        btn.classList.add('drag-hover-glow');

                        // Auto-Open: switch tab after 450ms of hovering
                        clearTimeout(dragTimeout);
                        dragTimeout = setTimeout(() => {
                            if (window.appState.currentSub !== item) {
                                switchSub(item);
                            }
                        }, 450);
                    };

                    btn.ondragleave = (e) => {
                        btn.classList.remove('drag-hover-glow');
                        clearTimeout(dragTimeout); // Cancel auto-open if left too early
                    };

                    btn.ondrop = (e) => {
                        btn.classList.remove('drag-hover-glow');
                        clearTimeout(dragTimeout);
                        dropToTab(e, item);
                    };

                    if (item === window.appState.currentSub) {
                        btn.classList.add('active');
                    }
                    nav.appendChild(btn);
                });

                // Add "Move to Tomorrow" button if in Week view
                if (window.appState.view === 'week') {
                    const moveBtn = document.createElement('button');
                    moveBtn.className = 'sub-tab';
                    moveBtn.style.background = 'var(--accent-yellow)';
                    moveBtn.style.color = 'var(--bg-dark)';
                    moveBtn.innerHTML = '<i class="fa-solid fa-angles-left"></i> ترحيل للغد';
                    moveBtn.onclick = moveIncompleteStatsToNextDay;
                    moveBtn.title = "نقل المهام غير المكتملة لليوم التالي";
                    nav.appendChild(moveBtn);
                }
            }

            function switchSub(item) {
                window.appState.currentSub = item;
                renderSubNav();
                renderTasksFromDB();
            }

            window.addNewTask = async function () {
                const input = document.getElementById('task-input');
                const text = input.value.trim();

                if (!text) {
                    alert("اكتب المهمة أولاً");
                    return;
                }

                const importance = document.getElementById('task-importance').value;
                const recursionEl = document.getElementById('task-recursion');
                const recursionType = recursionEl ? recursionEl.value : '';

                let recurrenceRule = null;
                if (recursionType) {
                    recurrenceRule = { type: recursionType };
                }

                const user = JSON.parse(localStorage.getItem('currentUser'));

                // --- منطق التشفير ---
                const secretKey = user.password;
                const encryptedText = CryptoJS.AES.encrypt(text, secretKey).toString();
                // -------------------

                const newTask = {
                    id: Date.now(), // Fixed: Restore ID generation
                    text: encryptedText,
                    importance,
                    status: 'todo',
                    recursion: recursionType || 'none', // FIXED: Satisfy NOT NULL constraint
                    recurrence_rule: recurrenceRule, // NEW: JSON field
                    view: window.appState.view,
                    sub: window.appState.currentSub,
                    user_email: user.email,
                    last_created: new Date().toLocaleDateString()
                };

                try {
                    const { error } = await window.supabase
                        .from('tasks')
                        .insert([newTask]);

                    if (error) throw error;

                    input.value = '';
                    // Reset selection
                    if (recursionEl) recursionEl.value = "";

                    renderTasksFromDB();
                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء إضافة المهمة: " + (err.message || err));
                }
            };


            window.deleteTaskFromDB = async function (id) {
                if (!confirm("هل تريد حذف هذه المهمة؟")) return;

                try {
                    const { error } = await window.supabase
                        .from('tasks')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    renderTasksFromDB();
                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء حذف المهمة");
                }
            };


            function updateCounts(counts) {
                document.getElementById('count-todo').innerText = counts.todo;
                document.getElementById('count-doing').innerText = counts.doing;
                document.getElementById('count-done').innerText = counts.done;
            }

            function updateProgress(counts) {
                const total = counts.todo + counts.doing + counts.done;
                const percentage = total > 0 ? Math.round((counts.done / total) * 100) : 0;
                const progressBar = document.getElementById('main-progress');
                if (progressBar) progressBar.style.width = percentage + '%';
                const progressTextEl = document.getElementById('progress-percent-text');
                if (progressTextEl) progressTextEl.textContent = 'تم إنجاز ' + percentage + '%';
            }





            async function renderTasksFromDB() {
                const lists = {
                    todo: document.getElementById('list-todo'),
                    doing: document.getElementById('list-doing'),
                    done: document.getElementById('list-done')
                };

                Object.values(lists).forEach(list => { if (list) list.innerHTML = ''; });

                const user = JSON.parse(localStorage.getItem('currentUser'));
                const secretKey = user.password;
                const counts = { todo: 0, doing: 0, done: 0 };

                try {
                    // Only fetch Top-Level tasks (parent_id IS NULL) to avoid cluttering board with subtasks
                    const { data, error } = await window.supabase
                        .from('tasks')
                        .select('*')
                        .eq('user_email', user.email)
                        .eq('view', window.appState.view)
                        .eq('sub', window.appState.currentSub)
                        .is('parent_id', null); // IMPORTANT: Only top level

                    if (error) throw error;

                    data.forEach(task => {
                        let decryptedText = "خطأ في فك التشفير";
                        try {
                            const bytes = CryptoJS.AES.decrypt(task.text, secretKey);
                            decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                            if (!decryptedText) decryptedText = task.text;
                        } catch (e) {
                            decryptedText = task.text;
                        }

                        const li = document.createElement('li');
                        li.className = 'task-item folder-card'; // New Style Class
                        li.id = task.id;
                        li.draggable = true;

                        li.ondragstart = (e) => {
                            e.dataTransfer.setData("text", e.target.id);
                            window.draggedTaskId = e.target.id;
                            e.target.classList.add('dragging');
                        };
                        li.ondragend = (e) => {
                            e.target.classList.remove('dragging');
                            window.draggedTaskId = null;
                        };

                        // Folder Click -> Open Panel
                        // We use a specific area for click or just the whole card? 
                        // Let's make the whole card clickable EXCEPT the delete button.
                        li.onclick = (e) => {
                            // prevent if delete btn clicked
                            if (e.target.closest('.delete-btn')) return;
                            openTaskPanel(task.id);
                        };

                        const safeText = escapeHtml(decryptedText);

                        // Icons based on dates?
                        let dateIcons = '';
                        if (task.recurrence_rule) dateIcons += '<i class="fa-solid fa-rotate" title="متكرر"></i> ';
                        if (task.due_date) dateIcons += '<i class="fa-regular fa-clock" title="له موعد"></i> ';

                        li.innerHTML = `
                            <div class="folder-header">
                                <span class="folder-title">${safeText}</span>
                                <span class="importance-dot dot-${task.importance}"></span>
                            </div>
                            <div class="folder-meta">
                                ${dateIcons}
                                <span>${task.last_created || ''}</span>
                            </div>
                            <!-- Delete button (small x) -->
                            <button type="button" class="delete-btn" onclick="deleteTaskFromDB(${task.id}); event.stopPropagation();" 
                                    style="position:absolute; top:10px; left:10px; background:none; border:none; color:#ff7675; cursor:pointer;">&times;</button>
                        `;

                        if (lists[task.status]) {
                            lists[task.status].appendChild(li);
                            counts[task.status]++;
                        }
                    });

                    updateCounts(counts);
                    updateProgress(counts);

                } catch (err) {
                    console.error("Render Error:", err);
                }
            }


            // ── Advanced Task Logic ─────────────────────────────────────────────
            let currentOpenTaskId = null;

            window.openTaskPanel = async function (taskId) {
                currentOpenTaskId = taskId;
                const panel = document.getElementById('side-panel');
                const overlay = document.getElementById('side-panel-overlay');

                // Show panel styling
                panel.classList.add('open');
                overlay.style.display = 'block';

                // Load Data
                const user = JSON.parse(localStorage.getItem('currentUser'));
                try {
                    // Fetch Main Task
                    const { data: task, error } = await window.supabase
                        .from('tasks')
                        .select('*')
                        .eq('id', taskId)
                        .single();

                    if (error) throw error;

                    // Decrypt Title/Notes
                    let title = task.text;
                    let notes = task.notes || "";
                    try {
                        const bytes = CryptoJS.AES.decrypt(task.text, user.password);
                        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                        if (decrypted) title = decrypted;

                        if (task.notes) {
                            // Notes are currently plain text
                        }
                    } catch (e) { console.warn("Decrypt error", e); }

                    document.getElementById('panel-task-title').innerText = title;
                    document.getElementById('task-notes').value = notes;

                    // Dates - Supabase returns ISO strings
                    if (task.start_date) document.getElementById('task-start-date').value = task.start_date.slice(0, 16);
                    else document.getElementById('task-start-date').value = "";

                    if (task.due_date) document.getElementById('task-due-date').value = task.due_date.slice(0, 16);
                    else document.getElementById('task-due-date').value = "";

                    // Recurrence
                    if (task.recurrence_rule) {
                        document.getElementById('task-recurrencerule').value = JSON.stringify(task.recurrence_rule); // simple mapping
                    } else {
                        document.getElementById('task-recurrencerule').value = "";
                    }

                    // Fetch Subtasks
                    await renderSubtasks(taskId);

                } catch (err) {
                    console.error("Error opening task panel:", err);
                    alert("فشل تحميل تفاصيل المهمة");
                }
            };

            window.closeTaskPanel = function () {
                const panel = document.getElementById('side-panel');
                const overlay = document.getElementById('side-panel-overlay');
                panel.classList.remove('open');
                overlay.style.display = 'none';
                currentOpenTaskId = null;
            };

            async function renderSubtasks(parentId) {
                const list = document.getElementById('subtask-list');
                list.innerHTML = '<li style="text-align:center; color:gray;">جاري التحميل...</li>';
                const user = JSON.parse(localStorage.getItem('currentUser'));

                const { data, error } = await window.supabase
                    .from('tasks')
                    .select('*')
                    .eq('parent_id', parentId)
                    .order('id', { ascending: true }); // created order

                if (error) {
                    list.innerHTML = '<li style="color:red;">خطأ في التحميل</li>';
                    return;
                }

                list.innerHTML = '';
                let completedCount = 0;

                data.forEach(sub => {
                    let title = sub.text;
                    try {
                        const bytes = CryptoJS.AES.decrypt(sub.text, user.password);
                        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                        if (decrypted) title = decrypted;
                    } catch (e) { }

                    if (sub.status === 'done') completedCount++;

                    const li = document.createElement('li');
                    li.className = `subtask-item ${sub.status === 'done' ? 'completed' : ''}`;
                    li.innerHTML = `
                        <input type="checkbox" ${sub.status === 'done' ? 'checked' : ''} onchange="toggleSubtask(${sub.id}, this.checked)">
                        <span style="flex:1;">${escapeHtml(title)}</span>
                        <button onclick="deleteSubtask(${sub.id})" style="background:none; border:none; color:#ef4444; cursor:pointer;">&times;</button>
                    `;
                    list.appendChild(li);
                });

                document.getElementById('subtask-progress').innerText = `${completedCount}/${data.length}`;
            }

            window.addSubtask = async function () {
                const input = document.getElementById('new-subtask-input');
                const text = input.value.trim();
                if (!text || !currentOpenTaskId) return;

                const user = JSON.parse(localStorage.getItem('currentUser'));
                const encryptedText = CryptoJS.AES.encrypt(text, user.password).toString();

                const newSub = {
                    id: Date.now(),
                    text: encryptedText,
                    status: 'todo',
                    parent_id: currentOpenTaskId,
                    user_email: user.email,
                    importance: 'normal', // default
                    view: 'subtask', // marker
                    sub: 'none'
                };

                const { error } = await window.supabase.from('tasks').insert([newSub]);
                if (error) {
                    alert('خطأ في الإضافة');
                    console.error(error);
                } else {
                    input.value = '';
                    renderSubtasks(currentOpenTaskId);
                }
            };

            window.toggleSubtask = async function (id, isChecked) {
                const status = isChecked ? 'done' : 'todo';
                await window.supabase.from('tasks').update({ status }).eq('id', id);
                renderSubtasks(currentOpenTaskId);
            };

            window.deleteSubtask = async function (id) {
                if (!confirm('حذف المهمة الفرعية؟')) return;
                await window.supabase.from('tasks').delete().eq('id', id);
                renderSubtasks(currentOpenTaskId);
            };

            window.saveTaskDetails = async function () {
                if (!currentOpenTaskId) return;

                const title = document.getElementById('panel-task-title').innerText.trim();
                const notes = document.getElementById('task-notes').value;
                const startDate = document.getElementById('task-start-date').value || null;
                const dueDate = document.getElementById('task-due-date').value || null;
                const recurrenceRaw = document.getElementById('task-recurrencerule').value;
                let recurrenceRule = null;
                if (recurrenceRaw) {
                    try { recurrenceRule = JSON.parse(recurrenceRaw); } catch (e) { }
                }

                const user = JSON.parse(localStorage.getItem('currentUser'));
                const encryptedTitle = CryptoJS.AES.encrypt(title, user.password).toString();

                const updates = {
                    text: encryptedTitle,
                    notes: notes,
                    start_date: startDate,
                    due_date: dueDate,
                    recurrence_rule: recurrenceRule
                };

                const { error } = await window.supabase.from('tasks').update(updates).eq('id', currentOpenTaskId);

                if (error) {
                    alert('فشل الحفظ');
                    console.error(error);
                } else {
                    alert('تم الحفظ بنجاح');
                    renderTasksFromDB(); // Refresh main view
                    closeTaskPanel();
                }
            };

            window.deleteCurrentTask = async function () {
                await deleteTaskFromDB(currentOpenTaskId);
                closeTaskPanel();
            };

            async function renderTasksFromDB() {
                const lists = {
                    todo: document.getElementById('list-todo'),
                    doing: document.getElementById('list-doing'),
                    done: document.getElementById('list-done')
                };

                Object.values(lists).forEach(list => { if (list) list.innerHTML = ''; });

                const user = JSON.parse(localStorage.getItem('currentUser'));
                const secretKey = user.password;
                const counts = { todo: 0, doing: 0, done: 0 };

                try {
                    // Modified logic: Fetch tasks for the whole VIEW (e.g. all week)
                    // Then filter client-side to handle Recurrence (Daily tasks show everyday)
                    const { data, error } = await window.supabase
                        .from('tasks')
                        .select('*')
                        .eq('user_email', user.email)
                        .eq('view', window.appState.view)
                        // .eq('sub', window.appState.currentSub)  <-- REMOVED to allow fetching daily tasks from other days
                        .is('parent_id', null);

                    if (error) throw error;


                    data.forEach(task => {
                        // --- Recurrence & View Filter ---
                        let shouldShow = false;

                        // 1. Direct Match
                        if (task.sub === window.appState.currentSub) {
                            shouldShow = true;
                        }

                        // 2. Recurrence (Daily)
                        if (task.recurrence_rule && task.recurrence_rule.type === 'daily') {
                            shouldShow = true;
                        }

                        if (!shouldShow) return;
                        // --------------------------------

                        let decryptedText = "خطأ في فك التشفير";
                        try {
                            const bytes = CryptoJS.AES.decrypt(task.text, secretKey);
                            decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                            if (!decryptedText) decryptedText = task.text;
                        } catch (e) {
                            decryptedText = task.text;
                        }

                        const li = document.createElement('li');
                        li.className = 'task-item folder-card'; // New Style Class
                        li.id = task.id;
                        li.draggable = true;

                        li.ondragstart = (e) => {
                            e.dataTransfer.setData("text", e.target.id);
                            window.draggedTaskId = e.target.id;
                            e.target.classList.add('dragging');
                        };
                        li.ondragend = (e) => {
                            e.target.classList.remove('dragging');
                            window.draggedTaskId = null;
                        };

                        // Folder Click -> Open Panel
                        // But exclude delete button
                        li.onclick = (e) => {
                            if (e.target.closest('.delete-btn')) return;
                            openTaskPanel(task.id);
                        };

                        const safeText = escapeHtml(decryptedText);

                        let dateIcons = '';
                        if (task.recurrence_rule) dateIcons += '<i class="fa-solid fa-rotate" title="متكرر"></i> ';
                        if (task.due_date) dateIcons += '<i class="fa-regular fa-clock" title="له موعد"></i> ';

                        li.innerHTML = `
                            <div class="folder-header">
                                <span class="folder-title">${safeText}</span>
                                <span class="importance-dot dot-${task.importance}"></span>
                            </div>
                            <div class="folder-meta">
                                ${dateIcons}
                                <span>${task.last_created || ''}</span>
                            </div>
                            <!-- Delete button (small x) -->
                            <button type="button" class="delete-btn" onclick="deleteTaskFromDB(${task.id}); event.stopPropagation();" 
                                    style="position:absolute; top:10px; left:10px; background:none; border:none; color:#ff7675; cursor:pointer;">&times;</button>
                        `;

                        if (lists[task.status]) {
                            lists[task.status].appendChild(li);
                            counts[task.status]++;
                        }
                    });

                    updateCounts(counts);
                    updateProgress(counts);

                } catch (err) {
                    console.error("Render Error:", err);
                }
            }

            window.allowDrop = function (e) {
                e.preventDefault();
                e.currentTarget.classList.add('drag-over');
            };

            window.dragLeave = function (e) {
                e.currentTarget.classList.remove('drag-over');
            };

            window.drop = async function (e) {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');

                let id = parseInt(e.dataTransfer.getData("text"), 10);
                if (!id && window.draggedTaskId) {
                    id = parseInt(window.draggedTaskId, 10);
                }
                if (!id) return;

                const targetId = e.currentTarget.id || '';
                const newStatus = targetId.replace('list-', '').replace('col-', '');
                if (!['todo', 'doing', 'done'].includes(newStatus)) return;

                const taskElement = document.getElementById(id);
                if (taskElement) {
                    taskElement.style.opacity = '0.5';
                }

                try {
                    const { error } = await window.supabase
                        .from('tasks')
                        .update({
                            status: newStatus,
                            sub: window.appState.currentSub,
                            view: window.appState.view
                        })
                        .eq('id', id);
                    if (error) throw error;
                    await renderTasksFromDB();
                } catch (err) {
                    console.error("Column Drag & Drop Error:", err);
                    alert("⚠️ حدث خطأ أثناء النقل. سيتم التراجع.");
                    await renderTasksFromDB();
                }
            };

            window.dropToTab = async function (e, targetSub) {
                e.preventDefault();
                e.target.classList.remove('drag-hover-glow');

                let id = parseInt(e.dataTransfer.getData("text"), 10);
                if (!id && window.draggedTaskId) {
                    id = parseInt(window.draggedTaskId, 10);
                }

                if (!id) return;

                // Optimistic UI: Remove task visually first
                const taskElement = document.getElementById(id);
                const originalStatus = taskElement ? taskElement.parentNode.id.replace('list-', '') : null;
                const originalSub = window.appState.currentSub;

                if (taskElement) {
                    taskElement.style.display = 'none'; // Hide immediately
                }

                try {
                    const { error } = await window.supabase
                        .from('tasks')
                        .update({ sub: targetSub })
                        .eq('id', id);

                    if (error) throw error;
                    // If successful, just re-render to update counts
                    renderTasksFromDB();
                } catch (err) {
                    console.error("Advanced Drag & Drop Error:", err);
                    alert("⚠️ فشل نقل المهمة، تم التراجع عن الإجراء.");

                    // Revert Optimistic UI
                    if (taskElement) {
                        taskElement.style.display = ''; // Show back
                    }
                }

            };

            window.moveIncompleteStatsToNextDay = async function () {
                if (window.appState.view !== 'week') return;

                const currentDayIndex = subData.week.indexOf(window.appState.currentSub);
                if (currentDayIndex === -1 || currentDayIndex === 6) {
                    alert("لا يمكن الترحيل من هذا اليوم (الجمعة أو غير معرف)");
                    return;
                }

                const nextDay = subData.week[currentDayIndex + 1];

                if (!confirm(`هل أنت متأكد من نقل جميع المهام غير المكتملة من ${window.appState.currentSub} إلى ${nextDay}؟`)) return;

                const user = JSON.parse(localStorage.getItem('currentUser'));

                try {
                    // 1. Fetch incomplete tasks for current day
                    const { data: tasksToMove, error: fetchError } = await window.supabase
                        .from('tasks')
                        .select('id')
                        .eq('user_email', user.email)
                        .eq('view', 'week')
                        .eq('sub', window.appState.currentSub)
                        .neq('status', 'done')
                        .is('parent_id', null);

                    if (fetchError) throw fetchError;

                    if (!tasksToMove || tasksToMove.length === 0) {
                        alert("لا توجد مهام غير مكتملة للترحيل.");
                        return;
                    }

                    const ids = tasksToMove.map(t => t.id);

                    // 2. Update them to next day
                    const { error: updateError } = await window.supabase
                        .from('tasks')
                        .update({ sub: nextDay })
                        .in('id', ids);

                    if (updateError) throw updateError;

                    alert(`تم ترحيل ${ids.length} مهمة إلى ${nextDay}`);
                    renderTasksFromDB();

                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء الترحيل");
                }
            };

            window.toggleNotes = function () {
                const sidebar = document.getElementById('notes-sidebar');
                sidebar.classList.toggle('active');
                // تحميل الملاحظات عند فتح الـ sidebar
                if (sidebar.classList.contains('active')) {
                    renderNotesFromDB();
                }
            };

            window.openNoteModal = function (id, title, body) {
                document.getElementById('edit-note-id').value = id;
                document.getElementById('edit-note-title').value = title;
                document.getElementById('edit-note-body').value = body;
                document.getElementById('note-modal').style.display = 'flex';
            };

            window.closeNoteModal = function () {
                document.getElementById('note-modal').style.display = 'none';
            };

            window.saveNoteEdit = async function () {
                console.log('🔵 saveNoteEdit: بدء حفظ التعديلات');
                const idRaw = (document.getElementById('edit-note-id').value || '').trim();
                const title = (document.getElementById('edit-note-title').value || '').trim();
                const body = (document.getElementById('edit-note-body').value || '').trim();

                if (!idRaw) {
                    console.error('❌ saveNoteEdit: معرف الملاحظة فارغ');
                    alert("خطأ: معرف الملاحظة غير صالح.");
                    return;
                }
                if (!title && !body) {
                    console.warn('⚠️ saveNoteEdit: العنوان والمحتوى فارغان');
                    alert("أدخل عنواناً أو محتوى للملاحظة.");
                    return;
                }
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user || !user.password) {
                    console.error('❌ saveNoteEdit: بيانات المستخدم غير صحيحة');
                    alert("فشل الحصول على مفتاح التشفير.");
                    return;
                }

                try {
                    const secretKey = user.password;
                    console.log('🔐 saveNoteEdit: تشفير البيانات...');
                    const encryptedTitle = CryptoJS.AES.encrypt(title, secretKey).toString();
                    const encryptedBody = CryptoJS.AES.encrypt(body, secretKey).toString();
                    const idVal = /^\d+$/.test(idRaw) ? parseInt(idRaw, 10) : idRaw;

                    console.log('💾 saveNoteEdit: تحديث في قاعدة البيانات، ID:', idVal);
                    const { data, error } = await window.supabase
                        .from('notes')
                        .update({ title: encryptedTitle, body: encryptedBody })
                        .eq('id', idVal)
                        .eq('user_email', user.email)
                        .select('id');

                    if (error) {
                        console.error('❌ saveNoteEdit: خطأ في قاعدة البيانات:', error);
                        throw error;
                    }
                    if (!data || data.length === 0) {
                        console.error('❌ saveNoteEdit: لم يتم العثور على الملاحظة');
                        alert("لم يتم العثور على الملاحظة أو لا توجد صلاحية لتعديلها.");
                        return;
                    }

                    console.log('✅ saveNoteEdit: تم التحديث بنجاح');
                    closeNoteModal();
                    await renderNotesFromDB(document.getElementById('search-notes').value);
                    alert('✓ تم حفظ التعديلات بنجاح');
                } catch (err) {
                    console.error('❌ saveNoteEdit: خطأ:', err);
                    alert("خطأ أثناء التعديل: " + (err && err.message ? err.message : err));
                }
            };

            window.addNote = async function () {
                const titleEl = document.getElementById('note-title');
                const bodyEl = document.getElementById('note-body');
                const user = JSON.parse(localStorage.getItem('currentUser'));

                console.log('🔵 addNote: بدء إضافة ملاحظة جديدة');

                if (!titleEl || !bodyEl) {
                    console.error('❌ addNote: عناصر الإدخال غير موجودة');
                    alert("خطأ: عناصر الإدخال غير موجودة");
                    return;
                }

                const title = titleEl.value.trim();
                const body = bodyEl.value.trim();

                if (!title || !body) {
                    console.warn('⚠️ addNote: الحقول فارغة');
                    alert("أكمل بيانات الملاحظة (العنوان والمحتوى)");
                    return;
                }

                if (!user || !user.password) {
                    console.error('❌ addNote: بيانات المستخدم غير صحيحة');
                    alert("خطأ: لم يتم العثور على بيانات المستخدم");
                    return;
                }

                try {
                    // --- منطق التشفير ---
                    const secretKey = user.password;
                    console.log('🔐 addNote: تشفير البيانات...');
                    const encryptedTitle = CryptoJS.AES.encrypt(title, secretKey).toString();
                    const encryptedBody = CryptoJS.AES.encrypt(body, secretKey).toString();

                    const newNote = {
                        id: Date.now(),
                        title: encryptedTitle,
                        body: encryptedBody,
                        user_email: user.email
                    };

                    console.log('💾 addNote: حفظ في قاعدة البيانات...');
                    const { data, error } = await window.supabase
                        .from('notes')
                        .insert([newNote])
                        .select();

                    if (error) {
                        console.error('❌ addNote: خطأ في قاعدة البيانات:', error);
                        throw error;
                    }

                    console.log('✅ addNote: تم الحفظ بنجاح:', data);
                    titleEl.value = '';
                    bodyEl.value = '';
                    await renderNotesFromDB();
                    alert('✓ تم إضافة الملاحظة بنجاح');
                } catch (err) {
                    console.error('❌ addNote: خطأ:', err);
                    alert("حدث خطأ أثناء إضافة الملاحظة: " + (err.message || err));
                }
            };

            // ═══════════════════════════════════════════════════════════════
            // الملاحظات (عرض، إضافة، تعديل، حذف)
            // ═══════════════════════════════════════════════════════════════
            async function renderNotesFromDB(filter = "") {
                console.log('🔵 renderNotesFromDB: بدء تحميل الملاحظات، فلتر:', filter);
                const area = document.getElementById('notes-list');
                if (!area) {
                    console.error('❌ renderNotesFromDB: عنصر notes-list غير موجود');
                    return;
                }
                area.innerHTML = '';
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) {
                    console.warn('⚠️ renderNotesFromDB: المستخدم غير مسجل دخول');
                    return;
                }
                const secretKey = user.password;
                try {
                    console.log('📡 renderNotesFromDB: جلب البيانات من Supabase...');
                    const { data, error } = await window.supabase
                        .from('notes')
                        .select('*')
                        .eq('user_email', user.email)
                        .order('id', { ascending: false });

                    if (error) {
                        console.error('❌ renderNotesFromDB: خطأ في قاعدة البيانات:', error);
                        throw error;
                    }

                    console.log('✅ renderNotesFromDB: تم جلب', data?.length || 0, 'ملاحظة');

                    if (!data || data.length === 0) {
                        area.innerHTML = '<p style="text-align:center; color:var(--tab-text); padding:20px;">لا توجد ملاحظات حالياً</p>';
                        return;
                    }

                    let displayedCount = 0;
                    (data || []).forEach(note => {
                        let decryptedTitle = "", decryptedBody = "";
                        try {
                            const titleBytes = CryptoJS.AES.decrypt(note.title, secretKey);
                            decryptedTitle = titleBytes.toString(CryptoJS.enc.Utf8) || note.title || "بدون عنوان";
                            const bodyBytes = CryptoJS.AES.decrypt(note.body, secretKey);
                            decryptedBody = bodyBytes.toString(CryptoJS.enc.Utf8) || note.body || "";
                        } catch (e) {
                            console.warn('⚠️ renderNotesFromDB: فشل فك التشفير للملاحظة', note.id, e);
                            decryptedTitle = note.title || "خطأ في فك التشفير";
                            decryptedBody = note.body || "";
                        }

                        if (filter && !decryptedTitle.toLowerCase().includes(filter.toLowerCase()) && !decryptedBody.toLowerCase().includes(filter.toLowerCase())) {
                            return;
                        }

                        const noteCard = document.createElement('div');
                        noteCard.className = 'note-card';
                        noteCard.onclick = () => openNoteModal(note.id, decryptedTitle, decryptedBody);

                        // زر حذف الملاحظة
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.className = 'note-delete-btn';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteNote(note.id);
                        };

                        noteCard.innerHTML = `<h4>${escapeHtml(decryptedTitle)}</h4><div class="note-preview">${escapeHtml(decryptedBody)}</div>`;
                        noteCard.appendChild(deleteBtn);
                        area.appendChild(noteCard);
                        displayedCount++;
                    });

                    if (displayedCount === 0) {
                        area.innerHTML = '<p style="text-align:center; color:var(--tab-text); padding:20px;">لا توجد نتائج</p>';
                    }
                } catch (err) {
                    console.error('❌ renderNotesFromDB: خطأ غير متوقع:', err);
                    area.innerHTML = '<p style="text-align:center; color:#ff7675; padding:20px;">حدث خطأ في تحميل الملاحظات</p>';
                }
            }


            // ── History Logic ─────────────────────────────────────────────
            window.openHistoryModal = async function () {
                document.getElementById('history-modal').style.display = 'flex';
                document.getElementById('history-list').innerHTML = '';
                document.getElementById('history-loading').style.display = 'block';

                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;

                try {
                    const { data, error } = await window.supabase
                        .from('tasks')
                        .select('*')
                        .eq('user_email', user.email)
                        .order('id', { ascending: false })
                        .limit(50);

                    if (error) throw error;

                    document.getElementById('history-loading').style.display = 'none';
                    const list = document.getElementById('history-list');

                    if (!data || data.length === 0) {
                        list.innerHTML = '<p style="text-align:center; color:var(--tab-text);">لا يوجد سجل مهام.</p>';
                        return;
                    }

                    data.forEach(task => {
                        let decryptedText = "نص مشفر";
                        try {
                            const bytes = CryptoJS.AES.decrypt(task.text, user.password);
                            decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                            if (!decryptedText) decryptedText = task.text;
                        } catch (e) {
                            decryptedText = task.text;
                        }

                        const div = document.createElement('div');
                        div.className = 'history-item';

                        let statusIcon = '';
                        if (task.status === 'done') statusIcon = '✅';
                        else if (task.status === 'doing') statusIcon = '🚧';
                        else statusIcon = '🔴';

                        const safeText = escapeHtml(decryptedText);
                        div.innerHTML = `
                            <div>
                                <div style="font-weight:bold; color:var(--text-color);">${safeText}</div>
                                <div class="history-date">${task.last_created || ''} (${task.view} - ${task.sub})</div>
                            </div>
                            <div style="font-size:1.2rem;">${statusIcon}</div>
                        `;
                        list.appendChild(div);
                    });

                } catch (err) {
                    console.error(err);
                    document.getElementById('history-loading').style.display = 'none';
                    document.getElementById('history-list').innerHTML = '<p style="color:red; text-align:center;">حدث خطأ في تحميل السجل</p>';
                }
            };

            window.closeHistoryModal = function () {
                document.getElementById('history-modal').style.display = 'none';
            };

            window.deleteNoteFromDB = async function (id) {
                console.log('🔵 deleteNoteFromDB: طلب حذف الملاحظة، ID:', id);
                if (!confirm("هل تريد حذف هذه الملاحظة؟")) {
                    console.log('⚠️ deleteNoteFromDB: تم إلغاء الحذف');
                    return;
                }
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) {
                    console.error('❌ deleteNoteFromDB: المستخدم غير مسجل دخول');
                    return;
                }
                const idVal = typeof id === 'string' && /^\d+$/.test(id) ? parseInt(id, 10) : id;
                try {
                    console.log('🗑️ deleteNoteFromDB: حذف من قاعدة البيانات...');
                    const { error } = await window.supabase
                        .from('notes')
                        .delete()
                        .eq('id', idVal)
                        .eq('user_email', user.email);
                    if (error) {
                        console.error('❌ deleteNoteFromDB: خطأ في قاعدة البيانات:', error);
                        throw error;
                    }
                    console.log('✅ deleteNoteFromDB: تم الحذف بنجاح');
                    await renderNotesFromDB(document.getElementById('search-notes').value);
                    alert('✓ تم حذف الملاحظة بنجاح');
                } catch (err) {
                    console.error('❌ deleteNoteFromDB: خطأ:', err);
                    alert("حدث خطأ أثناء حذف الملاحظة: " + (err.message || err));
                }
            };

            window.filterNotes = function () {
                renderNotesFromDB(document.getElementById('search-notes').value);
            };

            // ═══════════════════════════════════════════════════════════════
            // Bucket (رفع، عرض، تعديل، حذف الملفات)
            // ═══════════════════════════════════════════════════════════════
            window.openUploadModal = function () {
                document.getElementById('upload-file-title').value = '';
                document.getElementById('upload-file-input').value = '';
                document.getElementById('upload-progress').style.display = 'none';
                document.getElementById('upload-modal').style.display = 'flex';
            };

            window.closeUploadModal = function () {
                document.getElementById('upload-modal').style.display = 'none';
            };

            window.confirmUpload = async function () {
                const titleInput = document.getElementById('upload-file-title');
                const fileInput = document.getElementById('upload-file-input');
                const progressDiv = document.getElementById('upload-progress');
                const progressBar = document.getElementById('progress-bar-fill');
                const progressText = document.getElementById('upload-progress-text');

                const title = titleInput.value.trim();
                const file = fileInput.files[0];

                if (!title || !file) {
                    alert("يرجى إكمال البيانات واختيار ملف");
                    return;
                }

                progressDiv.style.display = 'block';
                progressText.textContent = 'جاري رفع الملف...';
                progressBar.style.width = '0%';

                const user = JSON.parse(localStorage.getItem('currentUser'));

                // تحسين اسم المسار ليتوافق مع صلاحيات الوصول العام إذا لم تستخدم Supabase Auth
                const timestamp = Date.now();
                const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                // سنضع الملفات في مجلد عام لأننا نستخدم نظام login يدوي
                const storagePath = `public/${timestamp}_${sanitizedFileName}`;

                try {
                    // 1. رفع الملف إلى Storage
                    const { data: uploadData, error: uploadError } = await window.supabase.storage
                        .from(BUCKET_NAME)
                        .upload(storagePath, file);

                    if (uploadError) throw uploadError;

                    progressBar.style.width = '50%';
                    progressText.textContent = 'جاري حفظ البيانات...';

                    // 2. الحصول على الرابط
                    const { data: urlData } = window.supabase.storage
                        .from(BUCKET_NAME)
                        .getPublicUrl(storagePath);

                    // 3. حفظ البيانات في الجدول (تأكد من إرسال الحقول المطلوبة فقط)
                    const { error: dbError } = await window.supabase
                        .from('bucket_files')
                        .insert([{
                            title: title,
                            filename: file.name,
                            storage_path: storagePath,
                            file_url: urlData.publicUrl,
                            filetype: file.type,
                            filesize: file.size,
                            user_email: user.email
                            // ملاحظة: لا نرسل user_id هنا لأننا نستخدم نظام login يدوي
                        }]);

                    if (dbError) throw dbError;

                    progressBar.style.width = '100%';
                    progressText.textContent = '✓ تم الرفع بنجاح!';

                    setTimeout(() => {
                        closeUploadModal();
                        renderBucketFiles();
                    }, 1500);

                } catch (err) {
                    console.error('Error:', err);
                    progressText.textContent = `✗ خطأ: ${err.message}`;
                    // محاولة حذف الملف من الـ storage إذا فشل تسجيله في الداتابيز
                    await window.supabase.storage.from(BUCKET_NAME).remove([storagePath]);
                }
            };
            async function renderBucketFiles(filter = "") {
                const grid = document.getElementById('bucket-grid');
                const emptyState = document.getElementById('empty-bucket');
                grid.innerHTML = '';

                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;

                try {
                    let query = window.supabase
                        .from('bucket_files')
                        .select('*')
                        .eq('user_email', user.email)
                        .order('uploaded_at', { ascending: false });

                    if (filter) {
                        query = query.or(`title.ilike.%${filter}%,filename.ilike.%${filter}%`);
                    }

                    const { data, error } = await query;

                    if (error) throw error;

                    if (data.length === 0) {
                        emptyState.style.display = 'block';
                        grid.style.display = 'none';
                        return;
                    }

                    emptyState.style.display = 'none';
                    grid.style.display = 'grid';

                    data.forEach(file => {
                        const item = document.createElement('div');
                        item.className = 'bucket-item';

                        const isImage = file.filetype && file.filetype.startsWith('image/');
                        const isVideo = file.filetype && file.filetype.startsWith('video/');

                        let previewHTML = '';
                        if (isImage) {
                            previewHTML = `<img src="${file.file_url}" alt="${file.title}">`;
                        } else if (isVideo) {
                            previewHTML = `<video src="${file.file_url}"></video>`;
                        } else {
                            const icon = getFileIcon(file.filetype || '');
                            previewHTML = `<i class="file-icon ${icon}"></i>`;
                        }

                        const fileSize = formatFileSize(file.filesize);
                        const uploadDate = new Date(file.uploaded_at).toLocaleDateString('ar-EG');

                        item.innerHTML = `
                    <div class="bucket-preview">
                        ${previewHTML}
                    </div>
                    <div class="bucket-info">
                        <div class="bucket-title">${file.title}</div>
                        <div class="bucket-filename">${file.filename}</div>
                        <div class="bucket-meta">
                            <span>${fileSize}</span>
                            <span>${uploadDate}</span>
                        </div>
                        <div class="bucket-actions">
                            <button class="bucket-action-btn view-btn" onclick='viewFile(${JSON.stringify(file)})'>
                                <i class="fa-solid fa-eye"></i> عرض
                            </button>
                            <button class="bucket-action-btn edit-btn" onclick='editFile("${file.storage_path}", "${file.title}")'>
                                <i class="fa-solid fa-edit"></i> تعديل
                            </button>
                            <button class="bucket-action-btn delete-btn" onclick='deleteFile("${file.storage_path}", "${file.title}")'>
                                <i class="fa-solid fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;

                        grid.appendChild(item);
                    });
                } catch (err) {
                    console.error('Render error:', err);
                    alert("حدث خطأ في عرض الملفات");
                }
            }

            function getFileIcon(filetype) {
                if (filetype.includes('pdf')) return 'fa-solid fa-file-pdf';
                if (filetype.includes('word') || filetype.includes('document')) return 'fa-solid fa-file-word';
                if (filetype.includes('sheet') || filetype.includes('excel')) return 'fa-solid fa-file-excel';
                if (filetype.includes('text')) return 'fa-solid fa-file-alt';
                if (filetype.includes('zip') || filetype.includes('rar')) return 'fa-solid fa-file-archive';
                return 'fa-solid fa-file';
            }

            function formatFileSize(bytes) {
                if (!bytes) return '0 B';
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
            }

            window.viewFile = function (file) {
                const modal = document.getElementById('view-modal');
                const content = document.getElementById('view-content');

                const isImage = file.filetype && file.filetype.startsWith('image/');
                const isVideo = file.filetype && file.filetype.startsWith('video/');

                if (isImage) {
                    content.innerHTML = `<img src="${file.file_url}" alt="${file.title}" style="max-width: 100%; max-height: 90vh; border-radius: 10px;">`;
                } else if (isVideo) {
                    content.innerHTML = `<video src="${file.file_url}" controls style="max-width: 100%; max-height: 90vh; border-radius: 10px;"></video>`;
                } else {
                    content.innerHTML = `
                <div style="padding: 40px; text-align: center; background: var(--card-bg); border-radius: 10px;">
                    <i class="${getFileIcon(file.filetype)}" style="font-size: 5rem; color: var(--primary-teal); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--text-color); margin-bottom: 10px;">${file.title}</h3>
                    <p style="color: var(--tab-text); margin-bottom: 20px;">${file.filename}</p>
                    <a href="${file.file_url}" download="${file.filename}" target="_blank" style="background: var(--primary-teal); color: var(--bg-dark); padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block;">
                        <i class="fa-solid fa-download"></i> تحميل الملف
                    </a>
                </div>
            `;
                }

                modal.classList.add('active');
            };

            window.closeViewModal = function () {
                document.getElementById('view-modal').classList.remove('active');
            };

            window.editFile = function (storagePath, currentTitle) {
                document.getElementById('edit-file-id').value = storagePath;
                document.getElementById('edit-file-title').value = currentTitle;
                document.getElementById('edit-file-modal').style.display = 'flex';
            };

            window.closeEditFileModal = function () {
                document.getElementById('edit-file-modal').style.display = 'none';
            };

            window.saveFileEdit = async function () {
                const storagePath = document.getElementById('edit-file-id').value;
                const newTitle = document.getElementById('edit-file-title').value.trim();

                if (!newTitle) {
                    alert("يرجى إدخال اسم للملف");
                    return;
                }

                const user = JSON.parse(localStorage.getItem('currentUser'));

                try {
                    const { error } = await window.supabase
                        .from('bucket_files')
                        .update({ title: newTitle })
                        .eq('storage_path', storagePath)
                        .eq('user_email', user.email);

                    if (error) throw error;

                    closeEditFileModal();
                    renderBucketFiles();
                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء تعديل الملف");
                }
            };

            window.deleteFile = async function (storagePath, title) {
                if (!confirm(`هل تريد حذف الملف "${title}"؟`)) return;

                const user = JSON.parse(localStorage.getItem('currentUser'));

                try {
                    // حذف من قاعدة البيانات
                    const { error: dbError } = await window.supabase
                        .from('bucket_files')
                        .delete()
                        .eq('storage_path', storagePath)
                        .eq('user_email', user.email);

                    if (dbError) throw dbError;

                    // حذف من Storage
                    const { error: storageError } = await window.supabase.storage
                        .from(BUCKET_NAME)
                        .remove([storagePath]);

                    if (storageError) {
                        console.warn('Storage deletion warning:', storageError);
                    }

                    renderBucketFiles();
                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء حذف الملف");
                }
            };

            window.filterBucketFiles = function () {
                renderBucketFiles(document.getElementById('bucket-search').value);
            };

            // ═══════════════════════════════════════════════════════════════
            // إعدادات تخصيص المظهر
            // ═══════════════════════════════════════════════════════════════

            let tempBgImageFile = null; // ملف مؤقت للصورة

            window.openSettingsModal = function () {
                console.log('🔵 openSettingsModal: فتح نافذة الإعدادات');
                document.getElementById('settings-modal').classList.add('active');
                loadCurrentSettings();
            };

            window.closeSettingsModal = function () {
                console.log('🔵 closeSettingsModal: إغلاق نافذة الإعدادات');
                document.getElementById('settings-modal').classList.remove('active');
                tempBgImageFile = null;
            };

            function loadCurrentSettings() {
                console.log('🔵 loadCurrentSettings: تحميل الإعدادات الحالية');

                // تحميل الألوان الحالية
                const navbar = document.getElementById('navbar');
                const navbarColor = window.getComputedStyle(navbar).backgroundColor;
                const bgColor = window.getComputedStyle(document.body).backgroundColor;

                // تحويل RGB إلى HEX
                const navbarHex = rgbToHex(navbarColor);
                const bgHex = rgbToHex(bgColor);

                document.getElementById('navbar-color-picker').value = navbarHex;
                document.getElementById('navbar-color-value').textContent = navbarHex;

                document.getElementById('bg-color-picker').value = bgHex;
                document.getElementById('bg-color-value').textContent = bgHex;

                // تحميل صورة الخلفية إن وجدت
                const bgImage = document.body.style.backgroundImage;
                if (bgImage && bgImage !== 'none') {
                    const preview = document.getElementById('bg-preview');
                    preview.style.backgroundImage = bgImage;
                    preview.classList.add('active');
                }
            }

            function rgbToHex(rgb) {
                if (rgb.startsWith('#')) return rgb;
                const values = rgb.match(/\d+/g);
                if (!values || values.length < 3) return '#000000';
                const r = parseInt(values[0]).toString(16).padStart(2, '0');
                const g = parseInt(values[1]).toString(16).padStart(2, '0');
                const b = parseInt(values[2]).toString(16).padStart(2, '0');
                return `#${r}${g}${b}`;
            }

            // تحديث قيمة اللون عند التغيير
            document.addEventListener('DOMContentLoaded', function () {
                const navbarPicker = document.getElementById('navbar-color-picker');
                const bgPicker = document.getElementById('bg-color-picker');

                if (navbarPicker) {
                    navbarPicker.addEventListener('input', function (e) {
                        document.getElementById('navbar-color-value').textContent = e.target.value;
                        // معاينة مباشرة
                        document.getElementById('navbar').style.backgroundColor = e.target.value;
                    });
                }

                if (bgPicker) {
                    bgPicker.addEventListener('input', function (e) {
                        document.getElementById('bg-color-value').textContent = e.target.value;
                        // معاينة مباشرة
                        document.body.style.backgroundColor = e.target.value;
                    });
                }

                // معالج رفع الصورة
                const bgImageInput = document.getElementById('bg-image-input');
                if (bgImageInput) {
                    bgImageInput.addEventListener('change', function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            previewBackgroundImage(file);
                        }
                    });
                }
            });

            function previewBackgroundImage(file) {
                console.log('🔵 previewBackgroundImage: معاينة الخلفية');

                if (file.size > 10 * 1024 * 1024) {
                    alert('حجم الملف كبير جداً! الحد الأقصى 10MB');
                    return;
                }

                tempBgImageFile = file;
                const isVideo = file.type.startsWith('video/');
                const reader = new FileReader();

                reader.onload = function (e) {
                    const preview = document.getElementById('bg-preview');

                    if (isVideo) {
                        // Remove old bg image
                        document.body.style.backgroundImage = '';
                        document.body.classList.remove('custom-bg');

                        // Remove any existing bg video
                        const oldVid = document.getElementById('bg-video-el');
                        if (oldVid) oldVid.remove();

                        // Create fullscreen background video
                        const vid = document.createElement('video');
                        vid.id = 'bg-video-el';
                        vid.src = e.target.result;
                        vid.autoplay = true;
                        vid.loop = true;
                        vid.muted = true;
                        vid.playsInline = true;
                        vid.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;pointer-events:none;';
                        document.body.appendChild(vid);

                        // Show preview thumbnail
                        preview.style.backgroundImage = '';
                        preview.style.background = 'linear-gradient(135deg,#1a1a2e,#16213e)';
                        preview.innerHTML = `<button class="remove-bg-btn" onclick="removeBackgroundImage(event)"><i class="fa-solid fa-xmark"></i></button><span style="color:#4ade80;font-size:0.8rem;margin-top:8px;">🎬 فيديو</span>`;
                        preview.classList.add('active');
                    } else {
                        // Image background
                        const oldVid = document.getElementById('bg-video-el');
                        if (oldVid) oldVid.remove();

                        preview.style.backgroundImage = `url(${e.target.result})`;
                        preview.innerHTML = `<button class="remove-bg-btn" onclick="removeBackgroundImage(event)"><i class="fa-solid fa-xmark"></i></button>`;
                        preview.classList.add('active');

                        document.body.style.backgroundImage = `url(${e.target.result})`;
                        document.body.classList.add('custom-bg');
                    }
                };

                reader.readAsDataURL(file);
            }

            window.removeBackgroundImage = function (event) {
                event.stopPropagation();
                console.log('🔵 removeBackgroundImage: إزالة الخلفية');

                const preview = document.getElementById('bg-preview');
                preview.style.backgroundImage = '';
                preview.style.background = '';
                preview.innerHTML = `<button class="remove-bg-btn" onclick="removeBackgroundImage(event)"><i class="fa-solid fa-xmark"></i></button>`;
                preview.classList.remove('active');

                tempBgImageFile = null;
                document.getElementById('bg-image-input').value = '';

                // Remove image background
                document.body.style.backgroundImage = '';
                document.body.classList.remove('custom-bg');

                // Remove video background
                const oldVid = document.getElementById('bg-video-el');
                if (oldVid) oldVid.remove();
            };

            window.saveUserPreferences = async function () {
                console.log('🔵 saveUserPreferences: حفظ التفضيلات');

                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) {
                    alert('خطأ: المستخدم غير مسجل دخول');
                    return;
                }

                try {
                    const navbarColor = document.getElementById('navbar-color-picker').value;
                    const bgColor = document.getElementById('bg-color-picker').value;

                    let bgImageUrl = null;
                    let bgImagePath = null;

                    // رفع الصورة إن وجدت
                    if (tempBgImageFile) {
                        console.log('📤 saveUserPreferences: رفع صورة الخلفية...');
                        const timestamp = Date.now();
                        const sanitizedFileName = tempBgImageFile.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                        const storagePath = `backgrounds/${user.email}/${timestamp}_${sanitizedFileName}`;

                        const { data: uploadData, error: uploadError } = await window.supabase.storage
                            .from(BUCKET_NAME)
                            .upload(storagePath, tempBgImageFile);

                        if (uploadError) throw uploadError;

                        const { data: urlData } = window.supabase.storage
                            .from(BUCKET_NAME)
                            .getPublicUrl(storagePath);

                        bgImageUrl = urlData.publicUrl;
                        bgImagePath = storagePath;
                        console.log('✅ saveUserPreferences: تم رفع الصورة');
                    }

                    // حفظ في قاعدة البيانات
                    console.log('💾 saveUserPreferences: حفظ في قاعدة البيانات...');

                    // التحقق من وجود تفضيلات سابقة
                    const { data: existing } = await window.supabase
                        .from('user_preferences')
                        .select('*')
                        .eq('user_email', user.email)
                        .single();

                    const bgType = tempBgImageFile
                        ? (tempBgImageFile.type.startsWith('video/') ? 'video' : 'image')
                        : (existing?.bg_type || 'image');

                    const preferences = {
                        user_email: user.email,
                        navbar_color: navbarColor,
                        bg_color: bgColor,
                        bg_image_url: bgImageUrl || (existing?.bg_image_url || null),
                        bg_image_path: bgImagePath || (existing?.bg_image_path || null),
                        bg_type: bgType,
                        updated_at: new Date().toISOString()
                    };

                    let result;
                    if (existing) {
                        // تحديث
                        result = await window.supabase
                            .from('user_preferences')
                            .update(preferences)
                            .eq('user_email', user.email);
                    } else {
                        // إضافة جديد
                        preferences.id = Date.now();
                        result = await window.supabase
                            .from('user_preferences')
                            .insert([preferences]);
                    }

                    if (result.error) throw result.error;

                    console.log('✅ saveUserPreferences: تم الحفظ بنجاح');

                    // تطبيق التفضيلات
                    applyPreferences(preferences);

                    // حفظ في localStorage للتحميل السريع
                    localStorage.setItem('userPreferences', JSON.stringify(preferences));

                    closeSettingsModal();
                    alert('✓ تم حفظ التفضيلات بنجاح!');

                } catch (err) {
                    console.error('❌ saveUserPreferences: خطأ:', err);
                    alert('حدث خطأ أثناء حفظ التفضيلات: ' + (err.message || err));
                }
            };

            async function loadUserPreferences() {
                console.log('🔵 loadUserPreferences: تحميل تفضيلات المستخدم');

                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;

                try {
                    // محاولة التحميل من localStorage أولاً
                    const cached = localStorage.getItem('userPreferences');
                    if (cached) {
                        const preferences = JSON.parse(cached);
                        applyPreferences(preferences);
                    }

                    // تحميل من قاعدة البيانات
                    const { data, error } = await window.supabase
                        .from('user_preferences')
                        .select('*')
                        .eq('user_email', user.email)
                        .single();

                    if (error) {
                        if (error.code !== 'PGRST116') { // ليس خطأ "لا توجد بيانات"
                            console.error('❌ loadUserPreferences: خطأ:', error);
                        }
                        return;
                    }

                    if (data) {
                        console.log('✅ loadUserPreferences: تم تحميل التفضيلات');
                        applyPreferences(data);
                        localStorage.setItem('userPreferences', JSON.stringify(data));
                    }

                } catch (err) {
                    console.error('❌ loadUserPreferences: خطأ:', err);
                }
            }

            function applyPreferences(preferences) {
                console.log('🎨 applyPreferences: تطبيق التفضيلات');

                if (preferences.navbar_color) {
                    document.getElementById('navbar').style.backgroundColor = preferences.navbar_color;
                }

                if (preferences.bg_color) {
                    document.body.style.backgroundColor = preferences.bg_color;
                }

                // Remove any existing bg video first
                const oldVid = document.getElementById('bg-video-el');
                if (oldVid) oldVid.remove();

                if (preferences.bg_image_url) {
                    const isVideo = preferences.bg_type === 'video' ||
                        /\.(mp4|webm|ogg)(\?|$)/i.test(preferences.bg_image_url);

                    if (isVideo) {
                        document.body.style.backgroundImage = '';
                        document.body.classList.remove('custom-bg');

                        const vid = document.createElement('video');
                        vid.id = 'bg-video-el';
                        vid.src = preferences.bg_image_url;
                        vid.autoplay = true;
                        vid.loop = true;
                        vid.muted = true;
                        vid.playsInline = true;
                        vid.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;pointer-events:none;';
                        document.body.appendChild(vid);
                    } else {
                        document.body.style.backgroundImage = `url(${preferences.bg_image_url})`;
                        document.body.classList.add('custom-bg');
                    }
                } else {
                    document.body.style.backgroundImage = '';
                    document.body.classList.remove('custom-bg');
                }
            }

            window.resetToDefaults = async function () {
                if (!confirm('هل تريد إعادة تعيين جميع الإعدادات للوضع الافتراضي؟')) return;

                console.log('🔵 resetToDefaults: إعادة تعيين للإعدادات الافتراضية');

                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;

                try {
                    // حذف من قاعدة البيانات
                    await window.supabase
                        .from('user_preferences')
                        .delete()
                        .eq('user_email', user.email);

                    // حذف من localStorage
                    localStorage.removeItem('userPreferences');

                    // إعادة تعيين الألوان
                    document.getElementById('navbar').style.backgroundColor = '';
                    document.body.style.backgroundColor = '';
                    document.body.style.backgroundImage = '';
                    document.body.classList.remove('custom-bg');

                    // إعادة تحميل الإعدادات في Modal
                    loadCurrentSettings();

                    console.log('✅ resetToDefaults: تمت إعادة التعيين');
                    alert('✓ تمت إعادة تعيين الإعدادات بنجاح!');

                } catch (err) {
                    console.error('❌ resetToDefaults: خطأ:', err);
                    alert('حدث خطأ أثناء إعادة التعيين');
                }
            };

            // ═══════════════════════════════════════════════════════════════
            // مؤقت بومودورو والثيم
            // ═══════════════════════════════════════════════════════════════
            let timerInterval;
            let isRunning = false;
            let timeLeft = 25 * 60;

            window.toggleTimer = function () {
                const btn = document.getElementById('timer-btn');
                const container = document.getElementById('pomodoro');

                if (isRunning) {
                    clearInterval(timerInterval);
                    isRunning = false;
                    btn.innerHTML = '<i class="fa-solid fa-play"></i>';
                    container.classList.remove('timer-running');
                } else {
                    isRunning = true;
                    btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                    container.classList.add('timer-running');

                    timerInterval = setInterval(() => {
                        timeLeft--;
                        updateTimerDisplay();

                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            isRunning = false;
                            alert("انتهى وقت التركيز! أحسنت 🎉");
                            resetTimer();
                        }
                    }, 1000);
                }
            };

            function updateTimerDisplay() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('timer-minutes').textContent = minutes.toString().padStart(2, '0');
                document.getElementById('timer-seconds').textContent = seconds.toString().padStart(2, '0');
            }

            function resetTimer() {
                clearInterval(timerInterval);
                timeLeft = 25 * 60;
                isRunning = false;
                updateTimerDisplay();
                document.getElementById('timer-btn').innerHTML = '<i class="fa-solid fa-play"></i>';
                document.getElementById('pomodoro').classList.remove('timer-running');
            }



            window.toggleTheme = function () {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            };

            function updateThemeIcon(theme) {
                const icon = document.getElementById('theme-icon');
                if (theme === 'dark') {
                    icon.className = 'fa-solid fa-moon';
                } else {
                    icon.className = 'fa-solid fa-sun';
                }
            }

            // ═══════════════════════════════════════════════════════════════
            // تهيئة التطبيق والتحقق من تسجيل الدخول
            // ═══════════════════════════════════════════════════════════════
            function initApp() {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);

                updateTimerDisplay();
                renderNotesFromDB();
                loadUserPreferences();
                window.switchView('week');

                // Load Ramadan data on startup so it persists across refreshes
                renderJuzGrid();
                renderTaraweehGrid();
                loadPrayers();
                loadKhatma();
                loadTaraweeh();

                // Load Adhkar progress
                loadAdhkarLocally();
                loadAdhkarFromSupabase();
            }

            async function checkLoginStatus() {
                const user = localStorage.getItem('currentUser');
                if (user) {
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('app-wrapper').style.display = 'block';
                    const userData = JSON.parse(user);
                    showWelcomeScreen(userData.name);
                }
            }

            checkLoginStatus();

            // ═══════════════════════════════════════════════════════════════
            // Burger Menu Functions
            // ═══════════════════════════════════════════════════════════════
            window.toggleMobileMenu = function () {
                const nav = document.getElementById('mobile-nav');
                const overlay = document.getElementById('menu-overlay');
                nav.classList.toggle('active');
                overlay.classList.toggle('active');
            };

            window.closeMobileMenu = function () {
                const nav = document.getElementById('mobile-nav');
                const overlay = document.getElementById('menu-overlay');
                nav.classList.remove('active');
                overlay.classList.remove('active');
            };

            // ═══════════════════════════════════════════════════════════════
            // Ramadan Functions
            // ═══════════════════════════════════════════════════════════════

            // State
            let ramadanPrayers = { fajr: false, dhuhr: false, asr: false, maghrib: false, isha: false };
            let ramadanKhatma = {};   // { juz1: true, juz2: false, ... }
            let ramadanTaraweeh = {}; // { day1: true, ... }
            let ramadanTasbih = { subhanallah: 0, alhamdulillah: 0, allahuakbar: 0, lailahaillallah: 0 };
            let currentTasbihType = '';
            let currentTasbihSession = 0;

            // ── Adhkar Data & State ───────────────────────────────────────
            const MORNING_ADHKAR = [
                { text: 'أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ وَالْحَمْدُ لِلَّهِ لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ. رَبِّ إنِّي أَسْأَلُكَ خَيْرَ مَا فِي هَذَا اليَوم وَخَيْرَ مَا بَعْدَهُ وَأَعُوذُ بِكَ مِنْ شَرِّ هَذَا اليَوم وَشَرِّ مَا بَعْدَهُ. رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ وَسُوءِ الْكِبَرِ. رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ', count: 1 },
                { text: 'اللَّهُمَّ بِكَ أَصْبَحْنَا، وَبِكَ أَمْسَيْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ النُّشُورُ', count: 1 },
                { text: 'اللَّهُمَّ أَنْتَ رَبِّي، لاَ إِلَـهَ إِلاَّ أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ لَكَ بِذَنْبِي، فَاغْفِرْ لِي؛ فَإِنَّهُ لاَ يَغْفِرُ الذُّنُوبَ إلاَّ أَنْتَ', count: 1 },
                { text: 'يَا حَيُّ يَا قَيُّومُ بِرَحْمَتِكَ أَسْتَغِيثُ، أَصْلِحْ لِي شَأْنِي كُلَّهُ، وَلاَ تَكِلْنِي إِلَى نَفْسِي طَرْفَةَ عَيْنٍ', count: 1 },
                { text: 'اللَّهُمّ عَالِمَ الْغَيْبِ وَالشَّهَادَةِ، فَاطِرَ السَّمَوَاتِ وَالأَرْضِ، رَبَّ كُلِّ شَيْءٍ وَمَلِيكَهُ، أشهد أن لا إله إلا أنت، أَعُوذُ بِكَ مِنْ شَرِّ نَفْسِي، وَشَرِّ الشَّيْطَانِ وَشِرْكِهِ، وَأَنْ أَقْتَرِفَ عَلَى نَفْسِي سُوءًا أَوْ أَجُرَّهُ إِلَى مُسْلِمٍ', count: 1 },
                { text: 'اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَافِيَةَ فِي الدُّنْيَا وَالآخِرَةِ، اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي دِينِي، وَدُنْيَايَ، وَأَهْلِي، وَمَالِي، اللَّهُمَّ اسْتُرْ عَوْرَاتِي وَآمِنْ رَّوْعَاتِي، اللَّهُمَّ احْفَظْنِي مِنْ بَيْنِ يَدَيَّ، وَمِنْ خَلْفِي، وَعَنْ يَمِينِي، وَعَنْ شِمَالِي، وَمِنْ فَوْقِي، وَأَعُوذُ بِعَظَمَتِكَ أَنْ أُغْتَالَ مِنْ تَحْتِي', count: 1 },
                { text: 'لاَ إِلَـهَ إِلاَّ اللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ، لَهُ الْمُلْكُ، وَلَهُ الْحَمْدُ، وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ', count: 10 },
                { text: 'بِسْمِ اللهِ الَّذِي لاَ يَضُرُّ مَعَ اسْمِهِ شَيْءٌ؛ فِي الأَرْضِ وَلاَ فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ', count: 3 },
                { text: 'اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لاَ إِلَـهَ إلاَّ أَنْتَ، اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ وَالْفَقْرِ، اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لاَ إِلَـهَ إلاَّ أَنْتَ', count: 3 },
                { text: 'لاَ إِلَـهَ إِلاَّ اللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ يُحْيِي وَيُمِيتُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ', count: 10 },
                { text: 'سُبْحَانَ اللهِ وَبِحَمْدِهِ', count: 100 },
                { text: 'سُبْحَانَ اللهِ (مائة مرة)، الحَمْدُ للهِ (مائة مرة)، اللهُ أكْبَرُ (مائة مرة)، لاَ إِلَـهَ إِلاَّ اللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ، لَهُ الْمُلْكُ، وَلَهُ الْحَمْدُ، وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ (مائة مرة)', count: 1 },
                { text: '︵ سورة الإخلاص ︴\nبِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ\nقُلْ هُوَ اللَّهُ أَحَدٌ ۝ اللَّهُ الصَّمَدُ ۝ لَمْ يَلِدْ وَلَمْ يُولَدْ ۝ وَلَمْ يَكُن لَّهُ كُفُوًا أَحَدٌ', count: 3 },
                { text: '︵ سورة الفلق ︴\nبِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ\nقُلْ أَعُوذُ بِرَبِّ الْفَلَقِ ۝ مِن شَرِّ مَا خَلَقَ ۝ وَمِن شَرِّ غَاسِقٍ إِذَا وَقَبَ ۝ وَمِن شَرِّ النَّفَّاثَاتِ فِي الْعُقَدِ ۝ وَمِن شَرِّ حَاسِدٍ إِذَا حَسَدَ', count: 3 },
                { text: '︵ سورة الناس ︴\nبِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ\nقُلْ أَعُوذُ بِرَبِّ النَّاسِ ۝ مَلِكِ النَّاسِ ۝ إِلَٰهِ النَّاسِ ۝ مِن شَرِّ الْوَسْوَاسِ الْخَنَّاسِ ۝ الَّذِي يُوَسْوِسُ فِي صُدُورِ النَّاسِ ۝ مِنَ الْجِنَّةِ وَالنَّاسِ', count: 3 },
                { text: 'اللّهُ لاَ إِلَهَ إِلاَّ هُوَ الْحَيُّ الْقَيُّومُ لاَ تَأْخُذُهُ سِنَةٌ وَلاَ نَوْمٌ لَهُ مَا فِي السَّمَاوَاتِ وَمَا فِي الأرْضِ مَنْ ذَا الَّذِي يَشْفَعُ عِنْدَهُ إِلاَّ بِإِذْنِهِ يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ وَلاَ يُحِيطُونَ بِشَيْءٍ مِنْ عِلْمِهِ إِلاَّ بِمَا شَاءَ وَسِعَ كُرْسِيُّهُ السَّمَاوَاتِ وَالأَرْضَ وَلاَ يَئُودُهُ حِفْظُهُمَا وَهُوَ الْعَلِيُّ الْعَظِيمُ', count: 1 },
                { text: 'رَضِيتُ بِاللهِ رَبًّا، وَبِالإِسْلاَمِ دِينًا، وَبِمُحَمَّدٍ نَّبِيًّا', count: 3 },
                { text: 'أَصْبَحْنَا عَلَى فِطْرَةِ الإِسْلاَمِ، وَكَلِمَةِ الإِخْلاَصِ، وَدِينِ نَبِيِّنَا مُحَمَّدٍ، وَمِلَّةِ أَبِينَا إِبْرَاهِيمَ حَنِيفًا مُّسْلِمًا وَمَا كَانَ مِنَ المُشْرِكِينَ', count: 1 },
                { text: 'سُبْحَانَ اللهِ وبحمده عَدَدَ خَلْقِهِ، وَرِضَا نَفْسِهِ، وَزِنَةَ عَرْشِهِ، وَمِدَادَ كَلِمَاتِهِ', count: 3 },
                { text: 'أَسْتَغْفِرُ اللهَ وَأَتُوبُ إِلَيْهِ', count: 100 }
            ];


            const EVENING_ADHKAR = [
                { text: 'أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ وَالْحَمْدُ لِلَّهِ لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ. رَبِّ إنِّي أَسْأَلُكَ خَيْرَ مَا فِي هَذِهِ اللَّيْلة وَخَيْرَ مَا بَعْدَهَا وَأَعُوذُ بِكَ مِنْ شَرِّ هَذِهِ اللَّيلة وَشَرِّ مَا بَعْدَهَا. رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ وَسُوءِ الْكِبَرِ. رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ', count: 1 },
                { text: 'اللَّهُمَّ بِكَ أَمْسَيْنَا، وَبِكَ أَصْبَحْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ الْمَصِيرُ', count: 1 },
                { text: 'اللَّهُمَّ أَنْتَ رَبِّي، لَا إِلَـهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ لَكَ بِذَنْبِي، فَاغْفِرْ لِي؛ فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ', count: 1 },
                { text: 'يَا حَيُّ يَا قَيُّومُ بِرَحْمَتِكَ أَسْتَغِيثُ، أَصْلِحْ لِي شَأْنِي كُلَّهُ، وَلَا تَكِلْنِي إِلَى نَفْسِي طَرْفَةَ عَيْنٍ', count: 1 },
                { text: 'اللَّهُمَّ عَالِمَ الْغَيْبِ وَالشَّهَادَةِ، فَاطِرَ السَّمَوَاتِ وَالأَرْضِ، رَبَّ كُلِّ شَيْءٍ وَمَلِيكَهُ، أَشْهَدُ أَنْ لَا إِلَهَ إِلَّا أَنْتَ، أَعُوذُ بِكَ مِنْ شَرِّ نَفْسِي، وَشَرِّ الشَّيْطَانِ وَشِرْكِهِ، وَأَنْ أَقْتَرِفَ عَلَى نَفْسِي سُوءًا أَوْ أَجُرَّهُ إِلَى مُسْلِمٍ', count: 1 },
                { text: 'اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَافِيَةَ فِي الدُّنْيَا وَالآخِرَةِ، اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي دِينِي، وَدُنْيَايَ، وَأَهْلِي، وَمَالِي، اللَّهُمَّ اسْتُرْ عَوْرَاتِي وَآمِنْ رَوْعَاتِي، اللَّهُمَّ احْفَظْنِي مِنْ بَيْنِ يَدَيَّ، وَمِنْ خَلْفِي، وَعَنْ يَمِينِي، وَعَنْ شِمَالِي، وَمِنْ فَوْقِي، وَأَعُوذُ بِعَظَمَتِكَ أَنْ أُغْتَالَ مِنْ تَحْتِي', count: 1 },
                { text: 'لَا إِلَـهَ إِلَّا اللهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ، وَلَهُ الْحَمْدُ، وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ', count: 10 },
                { text: 'بِسْمِ اللهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ؛ فِي الأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ', count: 3 },
                { text: 'اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لَا إِلَـهَ إِلَّا أَنْتَ، اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ وَالْفَقْرِ، اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لَا إِلَـهَ إِلَّا أَنْتَ', count: 3 },
                { text: 'لَا إِلَـهَ إِلَّا اللهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ يُحْيِي وَيُمِيتُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ', count: 10 },
                { text: 'سُبْحَانَ اللهِ وَبِحَمْدِهِ', count: 100 },
                { text: 'سُبْحَانَ اللهِ (مائة مرة)، الحَمْدُ للهِ (مائة مرة)، اللهُ أكْبَرُ (مائة مرة)، لَا إِلَـهَ إِلَّا اللهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ، وَلَهُ الْحَمْدُ، وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ (مائة مرة)', count: 1 },
                { text: '︵ سورة الإخلاص ︴\nبِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ\nقُلْ هُوَ اللَّهُ أَحَدٌ ۝ اللَّهُ الصَّمَدُ ۝ لَمْ يَلِدْ وَلَمْ يُولَدْ ۝ وَلَمْ يَكُن لَّهُ كُفُوًا أَحَدٌ', count: 3 },
                { text: '︵ سورة الفلق ︴\nبِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ\nقُلْ أَعُوذُ بِرَبِّ الْفَلَقِ ۝ مِن شَرِّ مَا خَلَقَ ۝ وَمِن شَرِّ غَاسِقٍ إِذَا وَقَبَ ۝ وَمِن شَرِّ النَّفَّاثَاتِ فِي الْعُقَدِ ۝ وَمِن شَرِّ حَاسِدٍ إِذَا حَسَدَ', count: 3 },
                { text: '︵ سورة الناس ︴\nبِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ\nقُلْ أَعُوذُ بِرَبِّ النَّاسِ ۝ مَلِكِ النَّاسِ ۝ إِلَٰهِ النَّاسِ ۝ مِن شَرِّ الْوَسْوَاسِ الْخَنَّاسِ ۝ الَّذِي يُوَسْوِسُ فِي صُدُورِ النَّاسِ ۝ مِنَ الْجِنَّةِ وَالنَّاسِ', count: 3 },
                { text: 'اللّهُ لَا إِلَهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ لَهُ مَا فِي السَّمَاوَاتِ وَمَا فِي الأرْضِ مَنْ ذَا الَّذِي يَشْفَعُ عِنْدَهُ إِلَّا بِإِذْنِهِ يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ وَلَا يُحِيطُونَ بِشَيْءٍ مِنْ عِلْمِهِ إِلَّا بِمَا شَاءَ وَسِعَ كُرْسِيُّهُ السَّمَاوَاتِ وَالأَرْضَ وَلَا يَئُودُهُ حِفْظُهُمَا وَهُوَ الْعَلِيُّ الْعَظِيمُ', count: 1 },
                { text: 'رَضِيتُ بِاللهِ رَبًّا، وَبِالإِسْلَامِ دِينًا، وَبِمُحَمَّدٍ نَّبِيًّا', count: 3 },
                { text: 'أَمْسَيْنَا عَلَى فِطْرَةِ الإِسْلَامِ، وَكَلِمَةِ الإِخْلَاصِ، وَدِينِ نَبِيِّنَا مُحَمَّدٍ، وَمِلَّةِ أَبِينَا إِبْرَاهِيمَ حَنِيفًا مُّسْلِمًا وَمَا كَانَ مِنَ المُشْرِكِينَ', count: 1 },
                { text: 'سُبْحَانَ اللهِ وَبِحَمْدِهِ عَدَدَ خَلْقِهِ، وَرِضَا نَفْسِهِ، وَزِنَةَ عَرْشِهِ، وَمِدَادَ كَلِمَاتِهِ', count: 3 },
                { text: 'أَسْتَغْفِرُ اللهَ وَأَتُوبُ إِلَيْهِ', count: 100 }
            ];


            let adhkarCurrentType = ''; // 'morning' or 'evening'
            let adhkarCurrentIndex = 0;
            let adhkarDoneSet = new Set(); // Track which indices are done today
            let adhkarMorningDone = new Set();
            let adhkarEveningDone = new Set();

            function getAdhkarList() {
                return adhkarCurrentType === 'morning' ? MORNING_ADHKAR : EVENING_ADHKAR;
            }
            function getAdhkarDoneSet() {
                return adhkarCurrentType === 'morning' ? adhkarMorningDone : adhkarEveningDone;
            }

            window.openAdhkar = function (type) {
                adhkarCurrentType = type;
                adhkarCurrentIndex = 0;
                adhkarDoneSet = getAdhkarDoneSet();

                // Load from localStorage
                const saved = loadFromLocal('adhkar_' + type);
                if (saved && Array.isArray(saved)) {
                    adhkarDoneSet.clear();
                    saved.forEach(i => adhkarDoneSet.add(i));
                    if (type === 'morning') adhkarMorningDone = adhkarDoneSet;
                    else adhkarEveningDone = adhkarDoneSet;
                }

                const overlay = document.getElementById('adhkar-overlay');
                overlay.classList.add('active');
                document.getElementById('adhkar-overlay-title').textContent = type === 'morning' ? '🌅 أذكار الصباح' : '🌇 أذكار المساء';
                renderAdhkarUI();
            };

            window.closeAdhkar = function () {
                document.getElementById('adhkar-overlay').classList.remove('active');
                saveAdhkarProgress();
            };

            window.adhkarNext = function () {
                const list = getAdhkarList();
                if (adhkarCurrentIndex < list.length - 1) {
                    adhkarCurrentIndex++;
                    renderAdhkarUI();
                }
            };

            window.adhkarPrev = function () {
                if (adhkarCurrentIndex > 0) {
                    adhkarCurrentIndex--;
                    renderAdhkarUI();
                }
            };

            let adhkarTapCounter = 0;

            window.adhkarTapCount = function () {
                const list = getAdhkarList();
                const item = list[adhkarCurrentIndex];
                if (!item || item.count <= 1) return;
                if (adhkarDoneSet.has(adhkarCurrentIndex)) return;

                adhkarTapCounter++;

                // Update UI
                document.getElementById('adhkar-tap-count').textContent = adhkarTapCounter;
                const pctCounter = Math.min(Math.round((adhkarTapCounter / item.count) * 100), 100);
                document.getElementById('adhkar-counter-fill').style.width = pctCounter + '%';

                // Tap circle animation
                const circle = document.getElementById('adhkar-tap-circle');
                circle.style.transform = 'scale(0.92)';
                setTimeout(() => circle.style.transform = '', 100);

                // Check if done
                if (adhkarTapCounter >= item.count) {
                    circle.classList.add('completed');
                    // Auto mark done
                    setTimeout(() => adhkarMarkDone(), 300);
                }
            };

            window.adhkarMarkDone = function () {
                adhkarDoneSet.add(adhkarCurrentIndex);
                adhkarTapCounter = 0;
                saveToLocal('adhkar_' + adhkarCurrentType, Array.from(adhkarDoneSet));
                renderAdhkarUI();
                updateAdhkarCardProgress();
                saveAdhkarProgress();

                // Auto-advance if not last
                const list = getAdhkarList();
                if (adhkarCurrentIndex < list.length - 1) {
                    setTimeout(() => {
                        adhkarCurrentIndex++;
                        renderAdhkarUI();
                    }, 350);
                }
            };

            function renderAdhkarUI() {
                const list = getAdhkarList();
                const total = list.length;
                const doneCount = adhkarDoneSet.size;
                const pct = Math.round((doneCount / total) * 100);
                const item = list[adhkarCurrentIndex];
                const isDone = adhkarDoneSet.has(adhkarCurrentIndex);
                const allDone = doneCount === total;

                // Progress
                document.getElementById('adhkar-progress-label').textContent = `الذكر ${adhkarCurrentIndex + 1} من ${total}`;
                document.getElementById('adhkar-progress-percent').textContent = pct + '%';
                const fill = document.getElementById('adhkar-progress-fill');
                fill.style.width = pct + '%';
                if (allDone) fill.classList.add('complete'); else fill.classList.remove('complete');

                // Text
                const textCard = document.getElementById('adhkar-text-card');
                const completeMsg = document.getElementById('adhkar-complete-msg');
                const counterArea = document.getElementById('adhkar-counter-area');

                if (allDone) {
                    textCard.style.display = 'none';
                    completeMsg.classList.add('active');
                } else {
                    textCard.style.display = '';
                    completeMsg.classList.remove('active');
                    document.getElementById('adhkar-text').textContent = item.text;
                    document.getElementById('adhkar-count-label').textContent = item.count > 1 ? `العدد: ${item.count} مرة` : 'مرة واحدة';

                    const badge = document.getElementById('adhkar-status-badge');
                    if (isDone) {
                        badge.textContent = '✓ تم القراءة';
                        badge.className = 'adhkar-status-badge done';
                    } else {
                        badge.textContent = 'لم يُقرأ بعد';
                        badge.className = 'adhkar-status-badge pending';
                    }

                    // Show/hide inline counter
                    if (item.count > 1 && !isDone) {
                        counterArea.classList.add('active');
                        adhkarTapCounter = 0;
                        document.getElementById('adhkar-tap-count').textContent = '0';
                        document.getElementById('adhkar-tap-target').textContent = '/ ' + item.count;
                        document.getElementById('adhkar-counter-fill').style.width = '0%';
                        document.getElementById('adhkar-tap-circle').classList.remove('completed');
                    } else {
                        counterArea.classList.remove('active');
                    }
                }

                // Buttons
                document.getElementById('adhkar-prev-btn').disabled = adhkarCurrentIndex === 0;
                document.getElementById('adhkar-next-btn').disabled = adhkarCurrentIndex === total - 1;
                const markBtn = document.getElementById('adhkar-mark-btn');
                if (isDone) {
                    markBtn.disabled = true;
                    markBtn.innerHTML = '<i class="fa-solid fa-check-double"></i> تم بالفعل';
                    markBtn.classList.add('already-done');
                } else if (item.count > 1) {
                    // For high-count, disable manual mark - must use tap counter
                    markBtn.disabled = true;
                    markBtn.innerHTML = '<i class="fa-solid fa-hand-pointer"></i> استخدم العداد ☝️';
                    markBtn.classList.remove('already-done');
                } else {
                    markBtn.disabled = false;
                    markBtn.innerHTML = '<i class="fa-solid fa-check"></i> تم';
                    markBtn.classList.remove('already-done');
                }
            }

            function updateAdhkarCardProgress() {
                // Morning card
                const mDone = adhkarMorningDone.size;
                const mTotal = MORNING_ADHKAR.length;
                const mPct = Math.round((mDone / mTotal) * 100);
                const mFill = document.getElementById('morning-card-progress');
                const mLabel = document.getElementById('morning-card-percent');
                if (mFill) mFill.style.width = mPct + '%';
                if (mLabel) mLabel.textContent = mPct + '%';

                // Evening card
                const eDone = adhkarEveningDone.size;
                const eTotal = EVENING_ADHKAR.length;
                const ePct = Math.round((eDone / eTotal) * 100);
                const eFill = document.getElementById('evening-card-progress');
                const eLabel = document.getElementById('evening-card-percent');
                if (eFill) eFill.style.width = ePct + '%';
                if (eLabel) eLabel.textContent = ePct + '%';
            }

            async function saveAdhkarProgress() {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user || !adhkarCurrentType) return;

                const list = getAdhkarList();
                const doneCount = adhkarDoneSet.size;
                const pct = Math.round((doneCount / list.length) * 100);
                const today = getLocalTodayDate();

                try {
                    const { error } = await window.supabase
                        .from('adhkar_progress')
                        .upsert({
                            user_email: user.email,
                            adhkar_type: adhkarCurrentType,
                            progress_date: today,
                            progress_percent: pct,
                            done_indices: Array.from(adhkarDoneSet)
                        }, { onConflict: 'user_email,adhkar_type,progress_date' });
                    if (error) console.error('Adhkar save error:', error);
                } catch (e) {
                    console.warn('Adhkar Supabase sync failed:', e);
                }
            }

            async function loadAdhkarFromSupabase() {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                const today = getLocalTodayDate();

                try {
                    const { data, error } = await window.supabase
                        .from('adhkar_progress')
                        .select('*')
                        .eq('user_email', user.email)
                        .eq('progress_date', today);

                    if (!error && data && data.length > 0) {
                        data.forEach(row => {
                            const indices = row.done_indices || [];
                            if (row.adhkar_type === 'morning') {
                                adhkarMorningDone = new Set(indices);
                                saveToLocal('adhkar_morning', indices);
                            } else {
                                adhkarEveningDone = new Set(indices);
                                saveToLocal('adhkar_evening', indices);
                            }
                        });
                        updateAdhkarCardProgress();
                    }
                } catch (e) {
                    console.warn('Adhkar load from Supabase failed:', e);
                }
            }

            function loadAdhkarLocally() {
                const mSaved = loadFromLocal('adhkar_morning');
                const eSaved = loadFromLocal('adhkar_evening');
                if (mSaved && Array.isArray(mSaved)) adhkarMorningDone = new Set(mSaved);
                if (eSaved && Array.isArray(eSaved)) adhkarEveningDone = new Set(eSaved);
                updateAdhkarCardProgress();
            }

            // ── localStorage helpers ──────────────────────────────────────
            function getLocalTodayDate() {
                const d = new Date();
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function getRamadanKey(type) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return null;
                if (type === 'prayers') {
                    // Use local date for prayers to ensure daily reset
                    return `ramadan_prayers_${user.email}_${getLocalTodayDate()}`;
                }
                return `ramadan_${type}_${user.email}`;
            }

            function saveToLocal(type, data) {
                const key = getRamadanKey(type);
                if (key) localStorage.setItem(key, JSON.stringify(data));
            }

            function loadFromLocal(type) {
                const key = getRamadanKey(type);
                if (!key) return null;
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : null;
            }

            // ── Show Page ─────────────────────────────────────────────────
            window.showRamadanPage = function () {
                document.getElementById('tasks-page').style.display = 'none';
                document.getElementById('bucket-page').classList.remove('active');
                const rp = document.getElementById('ramadan-page');
                rp.classList.add('active');
                rp.style.display = 'block';

                const today = new Date();
                const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('prayers-date').textContent = today.toLocaleDateString('ar-SA', opts);

                renderJuzGrid();
                renderTaraweehGrid();
                loadAllRamadanData();
            };

            window.switchRamadanTab = function (tab) {
                document.querySelectorAll('.ramadan-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.ramadan-section').forEach(s => s.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById('ramadan-' + tab).classList.add('active');
            };

            // ── Master load function ──────────────────────────────────────
            async function loadAllRamadanData() {
                // Step 1: Load instantly from localStorage
                // Reset prayers to default if new day (i.e., local storage is empty for today's key)
                ramadanPrayers = { fajr: false, dhuhr: false, asr: false, maghrib: false, isha: false };

                const localPrayers = loadFromLocal('prayers');
                if (localPrayers) {
                    ramadanPrayers = localPrayers;
                }
                // ALWAYS update UI to match current state (either loaded or reset)
                ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => updatePrayerUI(p));

                const localKhatma = loadFromLocal('khatma');
                if (localKhatma) {
                    ramadanKhatma = localKhatma;
                    updateKhatmaUI();
                }

                const localTaraweeh = loadFromLocal('taraweeh');
                if (localTaraweeh) {
                    ramadanTaraweeh = localTaraweeh;
                    updateTaraweehUI();
                }

                const localTasbih = loadFromLocal('tasbih');
                if (localTasbih) {
                    ramadanTasbih = localTasbih;
                }
                if (typeof updateTasbihUI === 'function') updateTasbihUI();

                // Step 2: Sync from Supabase in background
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;

                try {
                    // Prayers
                    const today = getLocalTodayDate();
                    const { data: pData, error: pErr } = await window.supabase
                        .from('ramadan_prayers').select('*')
                        .eq('user_email', user.email).eq('prayer_date', today);
                    if (!pErr && pData && pData.length > 0) {
                        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => {
                            const row = pData.find(r => r.prayer_name === p);
                            ramadanPrayers[p] = row ? row.is_done : false;
                            updatePrayerUI(p);
                        });
                        saveToLocal('prayers', ramadanPrayers);
                    }

                    // Khatma
                    const { data: kData, error: kErr } = await window.supabase
                        .from('ramadan_khatma').select('*').eq('user_email', user.email);
                    if (!kErr && kData && kData.length > 0) {
                        ramadanKhatma = {};
                        kData.forEach(row => { ramadanKhatma['juz' + row.juz_number] = row.is_done; });
                        updateKhatmaUI();
                        saveToLocal('khatma', ramadanKhatma);
                    }

                    // Taraweeh
                    const { data: tData, error: tErr } = await window.supabase
                        .from('ramadan_taraweeh').select('*').eq('user_email', user.email);
                    if (!tErr && tData && tData.length > 0) {
                        ramadanTaraweeh = {};
                        tData.forEach(row => { ramadanTaraweeh['day' + row.day_number] = row.is_done; });
                        updateTaraweehUI();
                        saveToLocal('taraweeh', ramadanTaraweeh);
                    }

                    // Tasbih
                    const { data: tbData, error: tbErr } = await window.supabase
                        .from('ramadan_tasbih').select('*').eq('user_email', user.email);
                    if (!tbErr && tbData && tbData.length > 0) {
                        tbData.forEach(row => { ramadanTasbih[row.tasbih_type] = row.count; });
                        if (typeof updateTasbihUI === 'function') updateTasbihUI();
                        saveToLocal('tasbih', ramadanTasbih);
                    }
                } catch (e) {
                    console.warn('Supabase sync failed, using localStorage:', e);
                }
            }

            // ── Prayers ──────────────────────────────────────────────────
            window.togglePrayer = async function (prayer) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                ramadanPrayers[prayer] = !ramadanPrayers[prayer];
                updatePrayerUI(prayer);
                saveToLocal('prayers', ramadanPrayers); // Save instantly to localStorage

                const today = getLocalTodayDate();
                const { error } = await window.supabase
                    .from('ramadan_prayers')
                    .upsert({
                        user_email: user.email,
                        prayer_date: today,
                        prayer_name: prayer,
                        is_done: ramadanPrayers[prayer]
                    }, { onConflict: 'user_email,prayer_date,prayer_name' });
                if (error) console.error('Prayer save error:', error);
            };

            function updatePrayerUI(prayer) {
                const card = document.getElementById('card-' + prayer);
                const check = document.getElementById('check-' + prayer);
                if (!card || !check) return;
                if (ramadanPrayers[prayer]) {
                    card.classList.add('done');
                    check.style.opacity = '1';
                } else {
                    card.classList.remove('done');
                    check.style.opacity = '0.2';
                }
            }

            // ── Khatma ───────────────────────────────────────────────────
            function renderJuzGrid() {
                const grid = document.getElementById('juz-grid');
                if (!grid || grid.children.length > 0) return;
                for (let i = 1; i <= 30; i++) {
                    const div = document.createElement('div');
                    div.className = 'juz-item';
                    div.id = 'juz-' + i;
                    div.onclick = () => toggleJuz(i);
                    div.innerHTML = `<span class="juz-num">جزء</span><span class="juz-label">${i}</span>`;
                    grid.appendChild(div);
                }
            }

            window.toggleJuz = async function (juz) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                const key = 'juz' + juz;
                ramadanKhatma[key] = !ramadanKhatma[key];
                updateKhatmaUI();
                saveToLocal('khatma', ramadanKhatma); // Save instantly

                const { error } = await window.supabase
                    .from('ramadan_khatma')
                    .upsert({
                        user_email: user.email,
                        juz_number: juz,
                        is_done: ramadanKhatma[key]
                    }, { onConflict: 'user_email,juz_number' });
                if (error) console.error('Khatma save error:', error);
            };

            function updateKhatmaUI() {
                let done = 0;
                for (let i = 1; i <= 30; i++) {
                    const key = 'juz' + i;
                    const el = document.getElementById('juz-' + i);
                    if (!el) continue;
                    if (ramadanKhatma[key]) {
                        el.classList.add('done');
                        done++;
                    } else {
                        el.classList.remove('done');
                    }
                }
                const pct = Math.round((done / 30) * 100);
                const pctEl = document.getElementById('khatma-percent-text');
                const fillEl = document.getElementById('khatma-progress-fill');
                const btnEl = document.getElementById('finish-khatma-btn');
                if (pctEl) pctEl.textContent = `${done} / 30 جزء — ${pct}%`;
                if (fillEl) fillEl.style.width = pct + '%';
                if (btnEl) btnEl.disabled = done < 30;
            }

            window.finishKhatma = async function () {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                const allDone = Object.keys(ramadanKhatma).filter(k => ramadanKhatma[k]).length === 30;
                if (!allDone) return;

                alert('🎉 مبروك! أتممت ختمة القرآن الكريم كاملة! بارك الله فيك.');
                if (!confirm('هل تريد البدء في ختمة جديدة؟ سيتم إعادة تعيين التقدم.')) return;

                ramadanKhatma = {};
                saveToLocal('khatma', ramadanKhatma);
                updateKhatmaUI();

                const updates = [];
                for (let i = 1; i <= 30; i++) {
                    updates.push(
                        window.supabase.from('ramadan_khatma')
                            .update({ is_done: false })
                            .eq('user_email', user.email).eq('juz_number', i)
                    );
                }
                await Promise.all(updates);
            };

            // ── Taraweeh ─────────────────────────────────────────────────
            function renderTaraweehGrid() {
                const grid = document.getElementById('taraweeh-grid');
                if (!grid || grid.children.length > 0) return;
                for (let i = 1; i <= 30; i++) {
                    const div = document.createElement('div');
                    div.className = 'taraweeh-item';
                    div.id = 'taraweeh-' + i;
                    div.onclick = () => toggleTaraweeh(i);
                    div.innerHTML = `<span class="day-num">ليلة</span><span class="day-label">${i}</span>`;
                    grid.appendChild(div);
                }
            }

            window.toggleTaraweeh = async function (day) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) return;
                const key = 'day' + day;
                ramadanTaraweeh[key] = !ramadanTaraweeh[key];
                updateTaraweehUI();
                saveToLocal('taraweeh', ramadanTaraweeh); // Save instantly

                const { error } = await window.supabase
                    .from('ramadan_taraweeh')
                    .upsert({
                        user_email: user.email,
                        day_number: day,
                        is_done: ramadanTaraweeh[key]
                    }, { onConflict: 'user_email,day_number' });
                if (error) console.error('Taraweeh save error:', error);
            };

            function updateTaraweehUI() {
                let done = 0;
                for (let i = 1; i <= 30; i++) {
                    const key = 'day' + i;
                    const el = document.getElementById('taraweeh-' + i);
                    if (!el) continue;
                    if (ramadanTaraweeh[key]) {
                        el.classList.add('done');
                        done++;
                    } else {
                        el.classList.remove('done');
                    }
                }
                const msg = document.getElementById('taraweeh-complete-msg');
                if (msg) msg.style.display = done === 30 ? 'block' : 'none';
            }

            // ── Tasbih ───────────────────────────────────────────────────
            function updateTasbihUI() {
                const els = {
                    subhanallah: document.getElementById('total-subhanallah'),
                    alhamdulillah: document.getElementById('total-alhamdulillah'),
                    allahuakbar: document.getElementById('total-allahuakbar'),
                    lailahaillallah: document.getElementById('total-lailahaillallah')
                };
                if (els.subhanallah) els.subhanallah.textContent = ramadanTasbih.subhanallah || 0;
                if (els.alhamdulillah) els.alhamdulillah.textContent = ramadanTasbih.alhamdulillah || 0;
                if (els.allahuakbar) els.allahuakbar.textContent = ramadanTasbih.allahuakbar || 0;
                if (els.lailahaillallah) els.lailahaillallah.textContent = ramadanTasbih.lailahaillallah || 0;
            }

            window.openTasbih = function (type, title) {
                currentTasbihType = type;
                currentTasbihSession = 0;
                document.getElementById('tasbih-active-title').textContent = title;
                document.getElementById('tasbih-count-display').textContent = '0';
                document.getElementById('tasbih-progress-ring').style.setProperty('--progress', '0%');
                document.getElementById('tasbih-current-session').textContent = '0';
                document.getElementById('tasbih-total-count').textContent = ramadanTasbih[type] || 0;
                document.getElementById('tasbih-active-overlay').classList.add('active');
            };

            window.closeTasbih = function () {
                saveTasbihToSupabase(currentTasbihType);
                document.getElementById('tasbih-active-overlay').classList.remove('active');
                currentTasbihType = '';
            };

            window.incrementTasbih = function () {
                if (!currentTasbihType) return;

                currentTasbihSession++;
                ramadanTasbih[currentTasbihType] = (ramadanTasbih[currentTasbihType] || 0) + 1;

                const counterArea = document.getElementById('tasbih-counter-area');
                counterArea.classList.remove('clicked');
                void counterArea.offsetWidth; // trigger reflow
                counterArea.classList.add('clicked');

                document.getElementById('tasbih-count-display').textContent = currentTasbihSession;
                document.getElementById('tasbih-current-session').textContent = currentTasbihSession;
                document.getElementById('tasbih-total-count').textContent = ramadanTasbih[currentTasbihType];
                updateTasbihUI();

                const pct = Math.min(100, (currentTasbihSession % 100));
                const ring = document.getElementById('tasbih-progress-ring');
                if ((currentTasbihSession % 100) === 0 && currentTasbihSession > 0) {
                    ring.style.setProperty('--progress', '100%');
                    setTimeout(() => {
                        ring.style.transition = 'none';
                        ring.style.setProperty('--progress', '0%');
                        void ring.offsetWidth;
                        ring.style.transition = '--progress 0.2s ease-out';
                    }, 200);
                } else {
                    ring.style.setProperty('--progress', pct + '%');
                }

                saveToLocal('tasbih', ramadanTasbih);
            };

            async function saveTasbihToSupabase(type) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user || !type) return;

                const { error } = await window.supabase
                    .from('ramadan_tasbih')
                    .upsert({
                        user_email: user.email,
                        tasbih_type: type,
                        count: ramadanTasbih[type] || 0
                    }, { onConflict: 'user_email,tasbih_type' });

                if (error) console.error('Tasbih save error:', error);
            }

        })();

    </script>

    <!-- ═══════════════════════════════════════════════════════════════
         TeamsModule - وحدة الفرق ومساحات العمل المشتركة
    ═══════════════════════════════════════════════════════════════ -->
    <script>
        (function () {
            'use strict';

            // ─── حالة الوحدة ─────────────────────────────────────────────
            let currentTeamId = null;   // معرّف الفريق النشط
            let currentTeamData = null;   // بيانات الفريق الكاملة
            let currentTeamMembers = [];     // قائمة الأعضاء
            let realtimeChannel = null;   // قناة Realtime
            let searchDebounceTimer = null;  // مؤقت البحث

            // ─── أدوات مساعدة ────────────────────────────────────────────
            function getCurrentUser() {
                return JSON.parse(localStorage.getItem('currentUser'));
            }

            function formatRelativeTime(dateStr) {
                const date = new Date(dateStr);
                const diff = Date.now() - date.getTime();
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                if (minutes < 1) return 'الآن';
                if (minutes < 60) return `منذ ${minutes} د`;
                if (hours < 24) return `منذ ${hours} س`;
                return `منذ ${days} أيام`;
            }

            function getInitials(name) {
                if (!name) return '؟';
                const parts = name.trim().split(/\s+/);
                return parts.length >= 2
                    ? (parts[0][0] + parts[1][0]).toUpperCase()
                    : parts[0][0].toUpperCase();
            }

            function isOverdue(dueDateStr) {
                if (!dueDateStr) return false;
                return new Date(dueDateStr) < new Date();
            }

            // ─── صفحة الفريق ─────────────────────────────────────────────
            window.showTeamPage = async function () {
                // إخفاء الصفحات الأخرى
                const tasksPage = document.getElementById('tasks-page');
                const bucketPage = document.getElementById('bucket-page');
                const ramadanPage = document.getElementById('ramadan-page');
                if (tasksPage) tasksPage.style.display = 'none';
                if (bucketPage) bucketPage.classList.remove('active');
                if (ramadanPage) { ramadanPage.classList.remove('active'); ramadanPage.style.display = 'none'; }

                // إظهار صفحة الفريق (نعتمد على .active class فقط، بدون inline style)
                const tp = document.getElementById('team-page');
                tp.classList.add('active');
                tp.style.display = ''; // أعد التحكم للـ CSS

                // جلب الفرق وانتظارها
                await loadUserTeams();

                // إذا كان هناك فريق سابق مختار، أعد تحديده تلقائياً
                if (currentTeamId) {
                    const sel = document.getElementById('team-select');
                    sel.value = String(currentTeamId);
                    if (sel.value === String(currentTeamId)) {
                        await onTeamSelected();
                    }
                }
            };

            // ─── تحميل الفرق ─────────────────────────────────────────────
            async function loadUserTeams() {
                const user = getCurrentUser();
                if (!user) return [];

                try {
                    // ── مسار 1: الفرق التي ينتمي إليها كعضو ──
                    const { data: memberships } = await window.supabase
                        .from('team_members')
                        .select('team_id')
                        .eq('user_email', user.email);

                    const memberTeamIds = (memberships || []).map(m => m.team_id);

                    // ── مسار 2: الفرق التي أنشأها (owner) — Fallback مهم ──
                    const { data: ownedTeams } = await window.supabase
                        .from('teams')
                        .select('*')
                        .eq('owner_email', user.email)
                        .order('created_at', { ascending: false });

                    // ── جمع كل IDs لاجتناب التكرار ──
                    const ownedIds = (ownedTeams || []).map(t => t.id);
                    const allIds = [...new Set([...memberTeamIds, ...ownedIds])];

                    let teams = ownedTeams || [];

                    // إضافة الفرق التي هو عضو فيها فقط (غير المملوكة مسبقاً)
                    const extraIds = memberTeamIds.filter(id => !ownedIds.includes(id));
                    if (extraIds.length > 0) {
                        const { data: memberTeams } = await window.supabase
                            .from('teams')
                            .select('*')
                            .in('id', extraIds)
                            .order('created_at', { ascending: false });
                        teams = [...teams, ...(memberTeams || [])];
                    }

                    // تعبئة القائمة المنسدلة
                    const sel = document.getElementById('team-select');
                    sel.innerHTML = '<option value="">-- اختر فريقاً --</option>';
                    teams.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = String(t.id);  // دائماً string للمقارنة الصحيحة
                        opt.textContent = t.name + (t.owner_email === user.email ? ' 👑' : '');
                        sel.appendChild(opt);
                    });

                    return teams; // نرجع القائمة للاستخدام في submitCreateTeam

                } catch (err) {
                    console.error('loadUserTeams error:', err);
                    return [];
                }
            }

            window.onTeamSelected = async function () {
                const sel = document.getElementById('team-select');
                const teamId = parseInt(sel.value, 10);

                // إلغاء الاشتراك من الفريق القديم
                unsubscribeFromTeam();

                if (!teamId || isNaN(teamId)) {
                    currentTeamId = null;
                    currentTeamData = null;
                    document.getElementById('no-team-placeholder').style.display = 'flex';
                    document.getElementById('team-workspace-content').style.display = 'none';
                    document.getElementById('manage-members-btn').style.display = 'none';
                    document.getElementById('add-task-global-btn').style.display = 'none';
                    document.getElementById('realtime-indicator').style.display = 'none';
                    return;
                }

                currentTeamId = teamId;

                try {
                    // جلب بيانات الفريق
                    const { data: team } = await window.supabase
                        .from('teams').select('*').eq('id', teamId).single();
                    currentTeamData = team;

                    // جلب الأعضاء
                    await reloadTeamMembers();

                    // تحديث العنوان
                    document.getElementById('team-page-title').textContent = team.name;

                    // إظهار المحتوى
                    document.getElementById('no-team-placeholder').style.display = 'none';
                    document.getElementById('team-workspace-content').style.display = 'grid';
                    document.getElementById('manage-members-btn').style.display = 'flex';
                    document.getElementById('add-task-global-btn').style.display = 'flex';
                    document.getElementById('realtime-indicator').style.display = 'inline-block';

                    // عرض إدارة الأعضاء للمالك فقط
                    const user = getCurrentUser();
                    const isOwner = team.owner_email === user.email;
                    document.getElementById('manage-members-btn').style.display = isOwner ? 'flex' : 'flex'; // الجميع يرى

                    // جلب وعرض البيانات + تهيئة الدردشة
                    await Promise.all([
                        renderTeamTasks(),
                        renderActivityLog(),
                        typeof window.initChatForTeam === 'function' ? window.initChatForTeam(teamId) : Promise.resolve()
                    ]);

                    // تفعيل Realtime
                    subscribeToTeam(teamId);

                } catch (err) {
                    console.error('onTeamSelected error:', err);
                    alert('حدث خطأ في تحميل بيانات الفريق');
                }
            };


            async function reloadTeamMembers() {
                if (!currentTeamId) return;
                const { data, error } = await window.supabase
                    .from('team_members')
                    .select('*')
                    .eq('team_id', currentTeamId);
                if (!error) currentTeamMembers = data || [];
            }

            // ─── Realtime ─────────────────────────────────────────────────
            function subscribeToTeam(teamId) {
                try {
                    realtimeChannel = window.supabase
                        .channel(`team_${teamId}`)
                        .on(
                            'postgres_changes',
                            { event: '*', schema: 'public', table: 'team_tasks', filter: `team_id=eq.${teamId}` },
                            () => renderTeamTasks()
                        )
                        .on(
                            'postgres_changes',
                            { event: 'INSERT', schema: 'public', table: 'activity_log', filter: `team_id=eq.${teamId}` },
                            () => renderActivityLog()
                        )
                        .subscribe();
                } catch (e) {
                    console.warn('Realtime not available:', e);
                }
            }

            function unsubscribeFromTeam() {
                if (realtimeChannel) {
                    window.supabase.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                }
            }

            // ─── رسم مهام الفريق ─────────────────────────────────────────
            async function renderTeamTasks() {
                const lists = {
                    todo: document.getElementById('team-list-todo'),
                    doing: document.getElementById('team-list-doing'),
                    done: document.getElementById('team-list-done')
                };
                if (!lists.todo) return;

                Object.values(lists).forEach(l => l.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tab-text);font-size:0.85rem;">جاري التحميل...</div>');

                try {
                    const { data: tasks, error } = await window.supabase
                        .from('team_tasks')
                        .select('*')
                        .eq('team_id', currentTeamId)
                        .order('created_at', { ascending: true });

                    if (error) throw error;

                    const counts = { todo: 0, doing: 0, done: 0 };
                    Object.values(lists).forEach(l => l.innerHTML = '');

                    (tasks || []).forEach(task => {
                        const card = buildTaskCard(task);
                        if (lists[task.status]) {
                            const li = document.createElement('li');
                            li.appendChild(card);
                            lists[task.status].appendChild(li);
                            counts[task.status]++;
                        }
                    });

                    document.getElementById('team-count-todo').textContent = counts.todo;
                    document.getElementById('team-count-doing').textContent = counts.doing;
                    document.getElementById('team-count-done').textContent = counts.done;

                } catch (err) {
                    console.error('renderTeamTasks error:', err);
                    Object.values(lists).forEach(l => l.innerHTML = '<div style="color:var(--accent-red);text-align:center;padding:20px;">خطأ في التحميل</div>');
                }
            }

            function buildTaskCard(task) {
                const card = document.createElement('div');
                card.className = 'team-task-card';
                card.setAttribute('data-id', task.id);

                const overdue = isOverdue(task.due_date) && task.status !== 'done';

                // chip المسؤول
                let assigneeHtml = '<span class="unassigned-chip">غير معيّن</span>';
                if (task.assigned_to && task.assigned_name) {
                    const initials = getInitials(task.assigned_name);
                    assigneeHtml = `
                    <div class="assignee-chip" title="${task.assigned_to}">
                        <div class="assignee-avatar">${initials}</div>
                        <span class="assignee-name">${task.assigned_name}</span>
                    </div>`;
                }

                // تاريخ الاستحقاق
                let dueHtml = '';
                if (task.due_date) {
                    const dueClass = overdue ? 'task-due-chip overdue' : 'task-due-chip';
                    dueHtml = `<span class="${dueClass}"><i class="fa-regular fa-calendar"></i> ${task.due_date}</span>`;
                }

                // زر الحالة التالية
                const statusMap = {
                    todo: { next: 'doing', label: '▶ ابدأ', icon: 'fa-play' },
                    doing: { next: 'done', label: '✔ أنهِ', icon: 'fa-check' },
                    done: { next: 'todo', label: '↺ أعد', icon: 'fa-rotate-left' }
                };
                const sm = statusMap[task.status];

                card.innerHTML = `
                <div class="team-task-card-title">${escapeHtmlTeams(task.title)}</div>
                ${task.description ? `<div class="team-task-card-desc">${escapeHtmlTeams(task.description)}</div>` : ''}
                <div class="team-task-card-meta">
                    ${assigneeHtml}
                    ${dueHtml}
                </div>
                <div class="team-task-actions">
                    <button class="task-action-btn" onclick="teamChangeStatus(${task.id},'${sm.next}')">
                        <i class="fa-solid ${sm.icon}"></i> ${sm.label}
                    </button>
                    <button class="task-action-btn" onclick="openAssignTaskModal(${task.id})">
                        <i class="fa-solid fa-user-pen"></i> تعيين
                    </button>
                    <button class="task-action-btn del-btn" onclick="teamDeleteTask(${task.id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>`;
                return card;
            }

            function escapeHtmlTeams(str) {
                if (!str) return '';
                const d = document.createElement('div');
                d.textContent = str;
                return d.innerHTML;
            }

            // ─── تغيير حالة المهمة ────────────────────────────────────────
            window.teamChangeStatus = async function (taskId, newStatus) {
                const user = getCurrentUser();
                if (!user || !currentTeamId) return;

                // جلب عنوان المهمة أولاً للـ activity log
                const { data: task } = await window.supabase
                    .from('team_tasks').select('title,status').eq('id', taskId).single();

                const statusLabels = { todo: 'للقيام', doing: 'جاري العمل', done: 'منجز' };

                const { error } = await window.supabase
                    .from('team_tasks')
                    .update({ status: newStatus })
                    .eq('id', taskId);

                if (error) { alert('فشل تحديث الحالة'); return; }

                // تسجيل النشاط
                await logActivity(
                    `نقل مهمة "${task.title}" من ${statusLabels[task.status]} إلى ${statusLabels[newStatus]}`
                );

                await renderTeamTasks();
            };

            // ─── حذف مهمة ────────────────────────────────────────────────
            window.teamDeleteTask = async function (taskId) {
                if (!confirm('هل تريد حذف هذه المهمة؟')) return;

                const { data: task } = await window.supabase
                    .from('team_tasks').select('title').eq('id', taskId).single();

                const { error } = await window.supabase
                    .from('team_tasks').delete().eq('id', taskId);

                if (error) { alert('فشل حذف المهمة'); return; }

                await logActivity(`حذف مهمة "${task ? task.title : ''}"`);
                await renderTeamTasks();
            };

            // ─── سجل النشاط ──────────────────────────────────────────────
            async function logActivity(action) {
                const user = getCurrentUser();
                if (!user || !currentTeamId) return;
                await window.supabase.from('activity_log').insert([{
                    team_id: currentTeamId,
                    actor_email: user.email,
                    actor_name: user.name,
                    action
                }]);
            }

            async function renderActivityLog() {
                const container = document.getElementById('activity-log-list');
                if (!container) return;

                try {
                    const { data: logs, error } = await window.supabase
                        .from('activity_log')
                        .select('*')
                        .eq('team_id', currentTeamId)
                        .order('created_at', { ascending: false })
                        .limit(30);

                    if (error) throw error;

                    if (!logs || logs.length === 0) {
                        container.innerHTML = '<div class="activity-empty">لا يوجد نشاط بعد</div>';
                        return;
                    }

                    container.innerHTML = logs.map(log => `
                    <div class="activity-item">
                        <div class="activity-item-actor">${escapeHtmlTeams(log.actor_name || log.actor_email)}</div>
                        <div class="activity-item-text">${escapeHtmlTeams(log.action)}</div>
                        <div class="activity-item-time">${formatRelativeTime(log.created_at)}</div>
                    </div>`).join('');

                } catch (err) {
                    console.error('renderActivityLog error:', err);
                }
            }

            // ─── Modal إنشاء فريق ─────────────────────────────────────────
            window.openCreateTeamModal = function () {
                document.getElementById('new-team-name').value = '';
                document.getElementById('create-team-modal').classList.add('open');
                setTimeout(() => document.getElementById('new-team-name').focus(), 100);
            };

            window.closeCreateTeamModal = function () {
                document.getElementById('create-team-modal').classList.remove('open');
            };

            window.submitCreateTeam = async function () {
                const name = document.getElementById('new-team-name').value.trim();
                if (!name) { alert('يرجى إدخال اسم الفريق'); return; }

                const user = getCurrentUser();
                if (!user) return;

                // تغيير حالة الزر لمنع الضغط المزدوج
                const submitBtn = document.querySelector('#create-team-modal .team-modal-submit');
                if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'جاري الإنشاء...'; }

                try {
                    // ── إنشاء الفريق ──
                    const { data: team, error } = await window.supabase
                        .from('teams')
                        .insert([{ name, owner_email: user.email }])
                        .select()
                        .single();

                    if (error) throw error;

                    // ── إضافة المالك كعضو (تجاهل خطأ الـ RLS إن وجد) ──
                    const { error: memberErr } = await window.supabase.from('team_members').insert([{
                        team_id: team.id,
                        user_email: user.email,
                        user_name: user.name || user.email,
                        role: 'owner'
                    }]);
                    if (memberErr) console.warn('team_members insert warning:', memberErr.message);

                    closeCreateTeamModal();

                    // ── تحديث قائمة الفرق ──
                    await loadUserTeams();

                    // ── تحديد الفريق الجديد تلقائياً ──
                    // نضبط القيمة كـ string عشان تتطابق مع option values
                    const sel = document.getElementById('team-select');
                    sel.value = String(team.id);

                    // إذا لم تُضبط القيمة (الـ option غير موجودة)، أضف option يدوياً
                    if (sel.value !== String(team.id)) {
                        const opt = document.createElement('option');
                        opt.value = String(team.id);
                        opt.textContent = name + ' 👑';
                        sel.appendChild(opt);
                        sel.value = String(team.id);
                    }

                    currentTeamId = team.id;
                    await onTeamSelected();

                    // ── تسجيل نشاط (بعد تحديد الفريق) ──
                    await logActivity(`أنشأ الفريق "${name}"`);

                } catch (err) {
                    console.error('submitCreateTeam error:', err);
                    alert('فشل إنشاء الفريق: ' + (err.message || err));
                } finally {
                    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'إنشاء الفريق'; }
                }
            };

            // ─── Modal إدارة الأعضاء ──────────────────────────────────────
            window.openManageMembersModal = async function () {
                document.getElementById('member-search-input').value = '';
                document.getElementById('member-search-results').style.display = 'none';
                document.getElementById('member-search-results').innerHTML = '';
                document.getElementById('manage-members-modal').classList.add('open');
                await renderCurrentMembersList();
            };

            window.closeManageMembersModal = function () {
                document.getElementById('manage-members-modal').classList.remove('open');
            };

            async function renderCurrentMembersList() {
                const container = document.getElementById('current-members-list');
                container.innerHTML = '<div style="text-align:center;color:var(--tab-text);padding:15px;">جاري التحميل...</div>';

                await reloadTeamMembers();

                if (currentTeamMembers.length === 0) {
                    container.innerHTML = '<div style="text-align:center;color:var(--tab-text);">لا يوجد أعضاء بعد</div>';
                    return;
                }

                const user = getCurrentUser();
                const isOwner = currentTeamData && currentTeamData.owner_email === user.email;
                const roleLabels = { owner: 'مالك', manager: 'مدير', member: 'عضو' };

                container.innerHTML = currentTeamMembers.map(m => `
                <div class="current-member-row">
                    <div class="member-info">
                        <div class="member-avatar">${getInitials(m.user_name || m.user_email)}</div>
                        <div>
                            <div class="member-item-name">${escapeHtmlTeams(m.user_name || m.user_email)}</div>
                            <div class="member-item-email">${escapeHtmlTeams(m.user_email)}</div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span class="current-member-role role-${m.role}">${roleLabels[m.role] || m.role}</span>
                        ${isOwner && m.role !== 'owner'
                        ? `<button class="remove-member-btn" onclick="removeMember('${m.user_email}')">
                                <i class="fa-solid fa-user-minus"></i> إزالة</button>`
                        : ''}
                    </div>
                </div>`).join('');
            }

            // ─── البحث عن مستخدمين ────────────────────────────────────────
            window.searchUsersDebounced = function () {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(doSearchUsers, 400);
            };

            async function doSearchUsers() {
                const query = document.getElementById('member-search-input').value.trim();
                const resultsBox = document.getElementById('member-search-results');

                if (query.length < 2) {
                    resultsBox.style.display = 'none';
                    return;
                }

                try {
                    const { data: users, error } = await window.supabase
                        .from('users')
                        .select('id, name, email')
                        .or(`name.ilike.%${query}%,email.ilike.%${query}%`)
                        .limit(8);

                    if (error) throw error;

                    if (!users || users.length === 0) {
                        resultsBox.style.display = 'block';
                        resultsBox.innerHTML = '<div style="padding:12px;text-align:center;color:var(--tab-text);">لا توجد نتائج</div>';
                        return;
                    }

                    const currentEmails = currentTeamMembers.map(m => m.user_email);

                    resultsBox.style.display = 'block';
                    resultsBox.innerHTML = users.map(u => {
                        const isAlready = currentEmails.includes(u.email);
                        return `
                        <div class="member-search-item">
                            <div class="member-info">
                                <div class="member-avatar">${getInitials(u.name)}</div>
                                <div>
                                    <div class="member-item-name">${escapeHtmlTeams(u.name)}</div>
                                    <div class="member-item-email">${escapeHtmlTeams(u.email)}</div>
                                </div>
                            </div>
                            <button class="member-invite-btn"
                                ${isAlready ? 'disabled' : ''}
                                onclick="inviteMember('${u.email}','${escapeHtmlTeams(u.name)}')">
                                ${isAlready ? '✓ عضو' : 'دعوة'}
                            </button>
                        </div>`;
                    }).join('');

                } catch (err) {
                    console.error('searchUsers error:', err);
                }
            }

            window.inviteMember = async function (email, name) {
                if (!currentTeamId) return;

                const existing = currentTeamMembers.find(m => m.user_email === email);
                if (existing) { alert('هذا المستخدم عضو بالفعل في الفريق'); return; }

                const { error } = await window.supabase.from('team_members').insert([{
                    team_id: currentTeamId,
                    user_email: email,
                    user_name: name,
                    role: 'member'
                }]);

                if (error) { alert('فشل دعوة العضو'); return; }

                await logActivity(`دعا "${name}" للانضمام إلى الفريق`);
                await reloadTeamMembers();
                await renderCurrentMembersList();

                // إغلاق نتائج البحث وإعادة تحميل الـ selects
                document.getElementById('member-search-input').value = '';
                document.getElementById('member-search-results').style.display = 'none';
            };

            window.removeMember = async function (email) {
                if (!confirm(`هل تريد إزالة هذا العضو من الفريق؟`)) return;
                if (!currentTeamId) return;

                const member = currentTeamMembers.find(m => m.user_email === email);

                const { error } = await window.supabase
                    .from('team_members')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('user_email', email);

                if (error) { alert('فشل إزالة العضو'); return; }

                await logActivity(`أزال "${member ? member.user_name || email : email}" من الفريق`);
                await reloadTeamMembers();
                await renderCurrentMembersList();
            };

            // ─── Modal إضافة مهمة ─────────────────────────────────────────
            window.openAddTeamTaskModal = function (initialStatus) {
                if (!currentTeamId) { alert('يرجى اختيار فريق أولاً'); return; }

                document.getElementById('task-initial-status').value = initialStatus || 'todo';
                document.getElementById('new-team-task-title').value = '';
                document.getElementById('new-team-task-desc').value = '';
                document.getElementById('new-team-task-due').value = '';

                // تعبئة select الأعضاء
                const sel = document.getElementById('new-team-task-assignee');
                sel.innerHTML = '<option value="">-- بدون تعيين --</option>';
                currentTeamMembers.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.user_email;
                    opt.textContent = m.user_name || m.user_email;
                    sel.appendChild(opt);
                });

                document.getElementById('add-team-task-modal').classList.add('open');
                setTimeout(() => document.getElementById('new-team-task-title').focus(), 100);
            };

            window.closeAddTeamTaskModal = function () {
                document.getElementById('add-team-task-modal').classList.remove('open');
            };

            window.submitAddTeamTask = async function () {
                const title = document.getElementById('new-team-task-title').value.trim();
                const description = document.getElementById('new-team-task-desc').value.trim();
                const assigneeSel = document.getElementById('new-team-task-assignee');
                const assignedTo = assigneeSel.value;
                const assignedName = assignedTo ? assigneeSel.selectedOptions[0].textContent : null;
                const dueDate = document.getElementById('new-team-task-due').value || null;
                const status = document.getElementById('task-initial-status').value || 'todo';

                if (!title) { alert('يرجى إدخال عنوان المهمة'); return; }

                const user = getCurrentUser();
                if (!user) return;

                const { error } = await window.supabase.from('team_tasks').insert([{
                    team_id: currentTeamId,
                    title,
                    description,
                    assigned_to: assignedTo || null,
                    assigned_name: assignedName || null,
                    status,
                    due_date: dueDate,
                    created_by: user.email
                }]);

                if (error) { alert('فشل إضافة المهمة: ' + error.message); return; }

                await logActivity(`أضاف مهمة "${title}"${assignedName ? ` وعيّنها لـ "${assignedName}"` : ''}`);
                closeAddTeamTaskModal();
                await renderTeamTasks();
            };

            // ─── Modal تعيين مسؤول ────────────────────────────────────────
            window.openAssignTaskModal = function (taskId) {
                document.getElementById('assign-task-id').value = taskId;

                const sel = document.getElementById('assign-member-select');
                sel.innerHTML = '<option value="">-- بدون تعيين --</option>';
                currentTeamMembers.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.user_email;
                    opt.textContent = m.user_name || m.user_email;
                    sel.appendChild(opt);
                });

                document.getElementById('assign-task-modal').classList.add('open');
            };

            window.closeAssignTaskModal = function () {
                document.getElementById('assign-task-modal').classList.remove('open');
            };

            window.submitAssignMember = async function () {
                const taskId = document.getElementById('assign-task-id').value;
                const sel = document.getElementById('assign-member-select');
                const email = sel.value;
                const name = email ? sel.selectedOptions[0].textContent : null;

                const { data: task } = await window.supabase
                    .from('team_tasks').select('title').eq('id', taskId).single();

                const { error } = await window.supabase
                    .from('team_tasks')
                    .update({ assigned_to: email || null, assigned_name: name || null })
                    .eq('id', taskId);

                if (error) { alert('فشل تعيين المسؤول'); return; }

                const action = email
                    ? `عيّن "${name}" مسؤولاً عن مهمة "${task ? task.title : ''}"`
                    : `أزال تعيين المسؤول عن مهمة "${task ? task.title : ''}"`;

                await logActivity(action);
                closeAssignTaskModal();
                await renderTeamTasks();
            };

            // ─── إغلاق Modals عند النقر خارجها ──────────────────────────
            document.addEventListener('click', function (e) {
                const modals = ['create-team-modal', 'manage-members-modal',
                    'add-team-task-modal', 'assign-task-modal'];
                modals.forEach(id => {
                    const modal = document.getElementById(id);
                    if (modal && e.target === modal) {
                        modal.classList.remove('open');
                    }
                });
            });

            // ─── إغلاق البحث بالضغط خارجه ───────────────────────────────
            document.addEventListener('click', function (e) {
                const searchBox = document.getElementById('member-search-results');
                const searchInput = document.getElementById('member-search-input');
                if (searchBox && !searchBox.contains(e.target) && e.target !== searchInput) {
                    searchBox.style.display = 'none';
                }
            });

            // ─── تسجيل الوظائف على window ─────────────────────────────────
            // (كل الدوال المطلوبة من HTML تم تسجيلها عبر window.xxx = أعلاه)

        })();
    </script>

    <!-- ═══════════════════════════════════════════════════════════════
         ChatModule - وحدة الدردشة الجماعية اللحظية
    ═══════════════════════════════════════════════════════════════ -->
    <script>
        (function () {
            'use strict';

            // ─── حالة الوحدة ──────────────────────────────────────────────
            let chatTeamId = null;   // الفريق النشط في الدردشة
            let chatChannel = null;   // قناة Realtime للدردشة
            let lastMsgDate = null;   // آخر تاريخ عُرض في الـ divider

            // ─── أدوات مساعدة ─────────────────────────────────────────────
            function chatGetUser() {
                return JSON.parse(localStorage.getItem('currentUser'));
            }

            function chatInitials(name) {
                if (!name) return '؟';
                const p = name.trim().split(/\s+/);
                return (p.length >= 2 ? p[0][0] + p[1][0] : p[0][0]).toUpperCase();
            }

            function chatFormatTime(dateStr) {
                const d = new Date(dateStr);
                return d.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            }

            function chatFormatDate(dateStr) {
                const d = new Date(dateStr);
                const now = new Date();
                const isToday = d.toDateString() === now.toDateString();
                if (isToday) return 'اليوم';
                const diff = Math.round((now - d) / 86400000);
                if (diff === 1) return 'أمس';
                return d.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long' });
            }

            function chatEscape(str) {
                const el = document.createElement('div');
                el.textContent = str || '';
                return el.innerHTML;
            }

            // ─── بناء فقاعة رسالة ─────────────────────────────────────────
            function buildMsgBubble(msg) {
                const user = chatGetUser();
                const isMine = user && msg.user_email === user.email;
                const cls = isMine ? 'mine' : 'theirs';

                const div = document.createElement('div');
                div.className = `chat-msg ${cls}`;
                div.setAttribute('data-msg-id', msg.id);

                div.innerHTML = `
                <div class="chat-msg-header">
                    <div class="chat-msg-avatar">${chatInitials(msg.user_name)}</div>
                    <span class="chat-msg-name">${chatEscape(msg.user_name)}</span>
                    <span class="chat-msg-time">${chatFormatTime(msg.created_at)}</span>
                </div>
                <div class="chat-msg-bubble">${chatEscape(msg.content)}</div>`;
                return div;
            }

            function buildDateDivider(label) {
                const div = document.createElement('div');
                div.className = 'chat-date-divider';
                div.textContent = label;
                return div;
            }

            // ─── إضافة رسالة للقائمة ──────────────────────────────────────
            function appendMessage(msg, scrollToBottom = true) {
                const container = document.getElementById('chat-messages');
                if (!container) return;

                // إزالة حالة "فارغة" لو موجودة
                const empty = container.querySelector('.chat-empty');
                if (empty) empty.remove();

                // divider التاريخ
                const dateLabel = chatFormatDate(msg.created_at);
                if (dateLabel !== lastMsgDate) {
                    container.appendChild(buildDateDivider(dateLabel));
                    lastMsgDate = dateLabel;
                }

                container.appendChild(buildMsgBubble(msg));

                if (scrollToBottom) {
                    requestAnimationFrame(() => {
                        container.scrollTop = container.scrollHeight;
                    });
                }
            }

            // ─── تحميل آخر 50 رسالة ───────────────────────────────────────
            async function loadMessages(teamId) {
                const container = document.getElementById('chat-messages');
                if (!container) return;

                container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tab-text);font-size:0.85rem;">جاري التحميل...</div>';
                lastMsgDate = null;

                try {
                    const { data: msgs, error } = await window.supabase
                        .from('team_messages')
                        .select('*')
                        .eq('team_id', teamId)
                        .order('created_at', { ascending: true })
                        .limit(50);

                    if (error) throw error;

                    container.innerHTML = '';

                    if (!msgs || msgs.length === 0) {
                        container.innerHTML = `
                        <div class="chat-empty">
                            <div class="chat-empty-icon">💬</div>
                            <span>لا توجد رسائل بعد — كن أول من يتحدث!</span>
                        </div>`;
                        return;
                    }

                    msgs.forEach(m => appendMessage(m, false));
                    // scroll للأسفل بعد التحميل
                    requestAnimationFrame(() => {
                        container.scrollTop = container.scrollHeight;
                    });

                } catch (err) {
                    console.error('loadMessages error:', err);
                    container.innerHTML = '<div style="color:var(--accent-red);text-align:center;padding:20px;">خطأ في تحميل الرسائل</div>';
                }
            }

            // ─── إرسال رسالة ──────────────────────────────────────────────
            window.sendChatMessage = async function () {
                const input = document.getElementById('chat-input');
                const btn = document.getElementById('chat-send-btn');
                if (!input || !btn) return;

                const content = input.value.trim();
                if (!content) return;

                const user = chatGetUser();
                if (!user || !chatTeamId) {
                    alert('يرجى اختيار فريق أولاً');
                    return;
                }

                // إعاقة مؤقتة لمنع الإرسال المزدوج
                btn.disabled = true;
                input.value = '';
                input.style.height = 'auto';

                const { error } = await window.supabase
                    .from('team_messages')
                    .insert([{
                        team_id: chatTeamId,
                        user_email: user.email,
                        user_name: user.name || user.email,
                        content
                    }]);

                if (error) {
                    console.error('sendChatMessage error:', error);
                    // أعد النص في حال الفشل
                    input.value = content;
                }

                btn.disabled = false;
                input.focus();
            };

            // ─── معالجة Enter / Shift+Enter ───────────────────────────────
            window.chatHandleKeydown = function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            };

            // ─── تمدد الـ textarea تلقائياً ───────────────────────────────
            window.chatAutoResize = function (el) {
                el.style.height = 'auto';
                el.style.height = Math.min(el.scrollHeight, 100) + 'px';
            };

            // ─── Realtime: الاشتراك في قناة الدردشة ──────────────────────
            function subscribeChatToTeam(teamId) {
                // إلغاء الاشتراك القديم
                if (chatChannel) {
                    window.supabase.removeChannel(chatChannel);
                    chatChannel = null;
                }

                try {
                    chatChannel = window.supabase
                        .channel(`chat_${teamId}`)
                        .on(
                            'postgres_changes',
                            {
                                event: 'INSERT',
                                schema: 'public',
                                table: 'team_messages',
                                filter: `team_id=eq.${teamId}`
                            },
                            (payload) => {
                                // تجنب إضافة رسائل المستخدم الحالي مرتين
                                const user = chatGetUser();
                                const existing = document.querySelector(`[data-msg-id="${payload.new.id}"]`);
                                if (!existing) appendMessage(payload.new, true);
                            }
                        )
                        .subscribe();
                } catch (e) {
                    console.warn('Chat Realtime not available:', e);
                }
            }

            // ─── الربط مع TeamsModule ──────────────────────────────────────
            // يُستدعى من onTeamSelected عند تغيير الفريق
            window.initChatForTeam = async function (teamId) {
                chatTeamId = teamId;
                lastMsgDate = null;

                if (!teamId) {
                    // إعادة ضبط الدردشة
                    const c = document.getElementById('chat-messages');
                    if (c) c.innerHTML = '<div class="chat-empty"><div class="chat-empty-icon">💬</div><span>اختر فريقاً لبدء الدردشة</span></div>';
                    if (chatChannel) { window.supabase.removeChannel(chatChannel); chatChannel = null; }
                    return;
                }

                subscribeChatToTeam(teamId);
                await loadMessages(teamId);
            };

        })();
    </script>

</body>
